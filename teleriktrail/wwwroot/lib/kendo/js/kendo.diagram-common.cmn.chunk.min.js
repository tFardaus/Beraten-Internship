/**
 * Kendo UI v2025.3.1002 (http://www.telerik.com/kendo-ui)
 * Copyright 2025 Progress Software Corporation and/or one of its subsidiaries or affiliates. All rights reserved.
 *
 * Kendo UI commercial licenses may be obtained at
 * http://www.telerik.com/purchase/license-agreement/kendo-ui-complete
 * If you do not own a commercial license, this file shall be governed by the trial license terms.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("kendo.drawing.cmn.chunk.js"),require("kendo.common.cmn.chunk.js")):"function"==typeof define&&define.amd?define(["exports","kendo.drawing.cmn.chunk.min","kendo.common.cmn.chunk.min"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).kendo=t.kendo||{},t.kendo._globals=t.kendo._globals||{},t.kendo._globals.DiagramCommonCmnChunk={}),t.kendo._globals.DrawingCmnChunk,t.kendo._globals.CommonCmnChunk)}(this,(function(t,e,s){const i="width";const n="height";const o="x";const r="y";const h="transparent";const a="start";const c="end";var l;!function(t){t.None="none",t.ArrowStart="ArrowStart",t.FilledCircle="FilledCircle",t.ArrowEnd="ArrowEnd"}(l||(l={}));const d=Math.PI/180;const u=1e-6;const p="change";const g={arrow:"default",grip:"pointer",cross:"pointer",add:"pointer",move:"move",select:"pointer",south:"s-resize",east:"e-resize",west:"w-resize",north:"n-resize",rowresize:"row-resize",colresize:"col-resize"};const f=10,m="Auto",_="Top",y="Right",w="Left",v="Bottom",x="dragStart",b="drag",C="dragEnd",S="itemRotate",M="itemBoundsChange",T="mouseEnter",k="mouseLeave",E="zoomStart",P="zoomEnd",L="pan",I="rotated",D="source",R="target",z={"-1":D,1:R};const O="Connection Editing";const N="cascading",B=9007199254740992,A="select",V="none",H=Number.MAX_VALUE,F=-Number.MAX_VALUE,U="transformed";const W=t=>Math.abs(t)<u;const q=t=>void 0!==t;const K=q;const Y=t=>"function"==typeof t;const j=t=>null==t;const X=t=>t===Object(t);const G=(t,e)=>Object.hasOwnProperty.call(t,e);const J=t=>"[object String]"===Object.prototype.toString.call(t);const Z=t=>!isNaN(parseFloat(t))&&isFinite(t);const $=t=>{if(null===t)return!0;if(Array.isArray(t)||J(t))return 0===t.length;for(const e in t)if(G(t,e))return!1;return!0};const Q=(t,e)=>{if(X(e))for(const s in e)s&&(t[s]=e[s])};const tt=(t,e)=>{const s=[];for(let i=0;i<t;++i)s[i]=e;return s};const et=(t,e)=>{const s=Math.floor(Math.random()*e)+t;return parseInt(s.toString(),10)};const st=(t,e)=>{if(e(t),t.childNodes)for(let s=0;s<t.childNodes.length;s++){const i=t.childNodes[s];st(i,e)}};const it=(t,e)=>{if(t===e)return 0;const s=e.x-t.x;const i=t.y-e.y;const n=Math.atan(s/i);return i>=0?s<0?n+2*Math.PI:n:n+Math.PI};const nt=t=>t?t<0?-1:1:0;const ot=(t,e)=>180*it(t,e)/Math.PI;const rt=(t,e,s)=>{for(let i=0;i<t.length;i++)e.call(s,t[i],i,t)};const ht=(t,e)=>{for(let s=0;s<t.length;++s)if(e(t[s]))return t[s];return null};const at=(t,e)=>{let s=t.indexOf(e);for(;-1!==s;)t.splice(s,1),s=t.indexOf(e);return t};const ct=(t,e)=>(t||[]).includes(e);const lt=(t,e)=>t.indexOf(e);const dt=(t,e)=>e.indexOf(t);const ut=(t,e)=>t.filter(e);const pt=(t,e,s,i)=>{let n=void 0!==s;for(let o=0;o<t.length;o++){const r=t[o];n?s=e.call(i,s,r,o,t):(s=r,n=!0)}if(!n)throw new Error("Reduce of empty array with no initial value");return s};const gt=(t,e,s)=>t.find(e.bind(s))||void 0;const ft=(t,e,s)=>0===t.length?null:j(e)?t[0]:gt(t,e,s);const mt=(t,e,s)=>(t.splice(s,0,e),t);const _t=(t,e,s)=>{let i=!0;let n;for(let o=0;o<t.length&&(n=t[o],i=i&&e.call(s,n,o,t),i);o++);return i};const yt=t=>{t.splice(0,t.length)};const wt=(t,e,s)=>{if(j(t))throw new Error("First array is not specified.");if(j(e))throw new Error("Second array is not specified.");if(t.length!==e.length)throw new Error("The two arrays should have equal length");const i=[];for(let s=0;s<t.length;s++)i.push({x:t[s],y:e[s]});j(s)?i.sort(((t,e)=>t.x-e.x)):i.sort(((t,e)=>s(t.x,e.x))),yt(t),yt(e);for(let s=0;s<i.length;s++)t.push(i[s].x),e.push(i[s].y)};const vt=(t,e)=>{t.push(...e)};const xt=()=>{};const bt="string";const Ct="function";const St=function(){this._defaultPrevented=!0};const Mt=function(){return!0===this._defaultPrevented};class Tt{constructor(){this.options={},this.events=[],this._events={}}destroy(){this.unbind()}bind(t,e,s){if(!e&&X(t)&&!Array.isArray(t)){for(const e in t)t[e]&&this.bind(e,t[e]);return this}const i=typeof t===bt?[t]:t,n=typeof e===Ct;let o,r;for(let t=0,h=i.length;t<h;t++){const h=i[t];r=n?e:e[h],r&&(s&&(o=r,r=(...t)=>{this.unbind(h,r),o.apply(this,t)},r.original=o),this._events[h]=this._events[h]||[],this._events[h].push(r))}return this}one(t,e){return this.bind(t,e,!0)}first(t,e){const s=typeof t===bt?[String(t)]:Array.from(t),i=typeof e===Ct;let n;for(let t=0,o=s.length;t<o;t++){const o=s[t];n=i?e:e[o],n&&(this._events[o]=this._events[o]||[],this._events[o].unshift(n))}return this}trigger(t,e){let s=this._events[t];if(s){const t=e||{};t.sender=this,t._defaultPrevented=!1,t.preventDefault=St,t.isDefaultPrevented=Mt,s=s.slice();for(let e=0,i=s.length;e<i;e++)s[e].call(this,t);return!0===t._defaultPrevented}return!1}unbind(t,e){const s=this._events[t];if(void 0===t)this._events={};else if(s)if(e)for(let t=s.length-1;t>=0;t--)s[t]!==e&&s[t].original!==e||s.splice(t,1);else this._events[t]=[];return this}_setEvents(t){const e=(this.events||[]).length;for(let s=0;s<e;s++){const e=this.events[s];this.options[e]&&t[e]&&(this.unbind(e,this.options[e]),this._events&&this._events[e]&&delete this._events[e])}this.bind(this.events,t)}}var kt=Object.freeze({__proto__:null,DFT:st,Observable:Tt,addRange:vt,all:_t,bisort:wt,clear:yt,contains:ct,defined:K,deserializePoints:t=>{const e=t.split(";");const s=[];if(e.length%2!=0)throw new Error("Not an array of points.");for(let t=0;t<e.length;t+=2)s.push({x:parseInt(e[t],10),y:parseInt(e[t+1],10)});return s},find:gt,findAngle:ot,findRadian:it,first:ft,fold:pt,forEach:rt,getAny:ht,getMatrixAngle:t=>null===t||0===t.d?0:180*Math.atan2(t.b,t.d)/Math.PI,getMatrixScaling:t=>[Math.sqrt(t.a*t.a+t.c*t.c),Math.sqrt(t.b*t.b+t.d*t.d)],grep:ut,has:G,inArray:dt,indexOf:lt,initArray:tt,insert:mt,isBoolean:t=>"[object Boolean]"===Object.prototype.toString.call(t),isDefined:q,isEmpty:$,isFunction:Y,isNearZero:W,isNumber:Z,isObject:X,isString:J,isType:(t,e)=>Object.prototype.toString.call(t)==="[object "+e+"]",isUndefined:j,noop:xt,randomInteger:et,remove:at,serializePoints:t=>{const e=[];for(let s=0;s<t.length;s++){const i=t[s];e.push(i.x+";"+i.y)}return e.join(";")},sign:nt,simpleExtend:Q});const Et={easeInOut:t=>-Math.cos(t*Math.PI)/2+.5};class Pt{constructor(){this.adapters=[],this.target=0,this.tick=0,this.interval=20,this.duration=800,this.lastTime=null,this.handlers=[],this.timerDelegate=()=>{},this.intervalId=null,this.caller=null,this.timerDelegate=()=>{this.onTimerEvent()}}addAdapter(t){this.adapters.push(t)}onComplete(t){this.handlers.push(t)}removeHandler(t){this.handlers=this.handlers.filter((e=>e!==t))}trigger(){this.handlers&&rt(this.handlers,(t=>t.call(null!==this.caller?this.caller:this)))}onStep(){}seekTo(t){this.seekFromTo(this.tick,t)}seekFromTo(t,e){this.target=Math.max(0,Math.min(1,e)),this.tick=Math.max(0,Math.min(1,t)),this.lastTime=(new Date).getTime(),this.intervalId||(this.intervalId=window.setInterval(this.timerDelegate,this.interval))}stop(){this.intervalId&&(window.clearInterval(this.intervalId),this.intervalId=null,this.trigger())}play(t){0!==this.adapters.length&&(null!==t&&(this.caller=t),this.initState(),this.seekFromTo(0,1))}reverse(){this.seekFromTo(1,0)}initState(){if(0!==this.adapters.length)for(let t=0;t<this.adapters.length;t++)this.adapters[t].initState()}propagate(){const t=Et.easeInOut(this.tick);for(let e=0;e<this.adapters.length;e++)this.adapters[e].update(t)}onTimerEvent(){const t=(new Date).getTime();const e=t-this.lastTime;this.lastTime=t;const s=e/this.duration*(this.tick<this.target?1:-1);Math.abs(s)>=Math.abs(this.tick-this.target)?this.tick=this.target:this.tick+=s;try{this.propagate()}finally{this.onStep.call(this),this.target===this.tick&&this.stop()}}}function Lt(t){j(t)&&(t=10);let e="";const s="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(let i=t;i>0;--i)e+=s.charAt(Math.round(61*Math.random()));return e}class It{constructor(){this._buckets={},this.length=0,this._stringsMap=new Map,this._stringsCounter=0}add(t,e){const s=this._createGetBucket(t);return q(e)&&(s.value=e),s}get(t){return this._bucketExists(t)?this._createGetBucket(t):null}set(t,e){this.add(t,e)}containsKey(t){return this._bucketExists(t)}remove(t){if(this._bucketExists(t)){const e=this._hash(t);return delete this._buckets[e],this.length--,t}}forEach(t){const e=this._hashes();for(let s=0,i=e.length;s<i;s++){const i=e[s];const n=this._buckets[i];j(n)||t(n)}}clone(){const t=new It;const e=this._hashes();for(let s=0,i=e.length;s<i;s++){const i=e[s];const n=this._buckets[i];j(n)||t.add(n.key,n.value)}return t}_hashes(){const t=[];for(const e in this._buckets)Object.prototype.hasOwnProperty.call(this._buckets,e)&&t.push(e);return t}_bucketExists(t){const e=this._hash(t);return q(this._buckets[e])}_createGetBucket(t){const e=this._hash(t);let s=this._buckets[e];return j(s)&&(s={key:t},this._buckets[e]=s,this.length++),s}_hash(t){if(J(t)||Z(t))return this._hashString(String(t));if(X(t))return this._objectHashId(t);throw new Error("Unsupported key type.")}_hashString(t){let e=0;return 0===t.length?e:this._stringsMap.has(t)?this._stringsMap.get(t):(this._stringsCounter++,this._stringsMap.set(t,this._stringsCounter),e=this._stringsCounter,e)}_objectHashId(t){let e=t._hashId;return j(e)&&(e=Lt(),t._hashId=e),e}}class Dt extends Tt{constructor(t){if(super(),this._hashTable=new It,this.length=0,q(t))if(Array.isArray(t))for(let e=0;e<t.length;e++)this.add(t[e]);else t.forEach((function(t,e){this.add(t,e)}),this)}add(t,e){let s=this._hashTable.get(t);s||(s=this._hashTable.add(t),this.length++,this.trigger("changed")),s.value=e}set(t,e){this.add(t,e)}get(t){const e=this._hashTable.get(t);if(e)return e.value;throw new Error("Cannot find key "+t)}containsKey(t){return this._hashTable.containsKey(t)}remove(t){if(this.containsKey(t))return this.trigger("changed"),this.length--,this._hashTable.remove(t)}forEach(t,e){this._hashTable.forEach((function(s){t.call(e,s.key,s.value)}))}forEachValue(t,e){this._hashTable.forEach((function(s){t.call(e,s.value)}))}forEachKey(t,e){this._hashTable.forEach((function(s){t.call(e,s.key)}))}keys(){const t=[];return this.forEachKey((function(e){t.push(e)})),t}}const Rt={_distanceToLineSquared:function(t,e,s){function i(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}if(e===s)return i(t,e);const n=s.x-e.x,o=s.y-e.y;let r=(t.x-e.x)*n+(t.y-e.y)*o;return r<0?i(e,t):(r=(s.x-t.x)*n+(s.y-t.y)*o,r<0?i(s,t):(r=(s.x-t.x)*o-(s.y-t.y)*n,r*r/(n*n+o*o)))},distanceToLine:function(t,e,s){return Math.sqrt(this._distanceToLineSquared(t,e,s))},distanceToPolyline:function(t,e){let s=Number.MAX_VALUE;if(j(e)||0===e.length)return Number.MAX_VALUE;for(let i=0;i<e.length-1;i++){const n=e[i];const o=e[i+1];const r=this._distanceToLineSquared(t,n,o);r<s&&(s=r)}return Math.sqrt(s)}};class zt{constructor(t,e){this.r=t,this.angle=e}}class Ot extends e.P{constructor(t,e){super(t,e)}clone(){return new Ot(this.x,this.y)}plus(t){return new Ot(this.x+t.x,this.y+t.y)}minus(t){return new Ot(this.x-t.x,this.y-t.y)}offset(t){return new Ot(this.x-t,this.y-t)}times(t){return new Ot(this.x*t,this.y*t)}normalize(){return 0===this.length()?new Ot:this.times(1/this.length())}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}toString(){return"("+this.x+","+this.y+")"}lengthSquared(){return this.x*this.x+this.y*this.y}middleOf(t,e){return new Ot(e.x-t.x,e.y-t.y).times(.5).plus(t)}toPolar(t){let e=1;t&&(e=180/Math.PI);const s=Math.atan2(Math.abs(this.y),Math.abs(this.x));const i=Math.PI/2;const n=this.length();if(0===this.x){if(0===this.y)return new zt(0,0);if(this.y>0)return new zt(n,e*i);if(this.y<0)return new zt(n,3*e*i)}else if(this.x>0){if(0===this.y)return new zt(n,0);if(this.y>0)return new zt(n,e*s);if(this.y<0)return new zt(n,e*(4*i-s))}else{if(0===this.y)return new zt(n,2*i);if(this.y>0)return new zt(n,e*(2*i-s));if(this.y<0)return new zt(n,e*(2*i+s))}}isOnLine(t,e){if(t.x>e.x){const s=e;e=t,t=s}const s=new Nt(t.x,t.y).inflate(3,3),i=new Nt(e.x,e.y).inflate(3,3);let n,o;return!!s.union(i).contains(this)&&(t.x===e.x||t.y===e.y||(t.y<e.y?(n=s.x+(i.x-s.x)*(this.y-(s.y+s.height))/(i.y+i.height-(s.y+s.height)),o=s.x+s.width+(i.x+i.width-(s.x+s.width))*(this.y-s.y)/(i.y-s.y)):(n=s.x+(i.x-s.x)*(this.y-s.y)/(i.y-s.y),o=s.x+s.width+(i.x+i.width-(s.x+s.width))*(this.y-(s.y+s.height))/(i.y+i.height-(s.y+s.height))),this.x>n&&this.x<o))}parse(t){const e=t.slice(1,t.length-1).split(","),s=parseInt(e[0],10),i=parseInt(e[1],10);if(!isNaN(s)&&!isNaN(i))return new Ot(s,i)}}class Nt{constructor(t,e,s,i){this.x=t||0,this.y=e||0,this.width=s||0,this.height=i||0}contains(t){return t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height}inflate(t,e){return void 0===e&&(e=t),this.x-=t,this.y-=e,this.width+=2*t+1,this.height+=2*e+1,this}offset(t,e){let s=t,i=e;return t instanceof Ot&&(s=t.x,i=t.y),this.x+=s,this.y+=i,this}union(t){const e=Math.min(this.x,t.x);const s=Math.min(this.y,t.y);const i=Math.max(this.x+this.width,t.x+t.width);const n=Math.max(this.y+this.height,t.y+t.height);return new Nt(e,s,i-e,n-s)}center(){return new Ot(this.x+this.width/2,this.y+this.height/2)}top(){return new Ot(this.x+this.width/2,this.y)}right(){return new Ot(this.x+this.width,this.y+this.height/2)}bottom(){return new Ot(this.x+this.width/2,this.y+this.height)}left(){return new Ot(this.x,this.y+this.height/2)}topLeft(){return new Ot(this.x,this.y)}topRight(){return new Ot(this.x+this.width,this.y)}bottomLeft(){return new Ot(this.x,this.y+this.height)}bottomRight(){return new Ot(this.x+this.width,this.y+this.height)}clone(){return new Nt(this.x,this.y,this.width,this.height)}isEmpty(){return!this.width&&!this.height}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}rotatedBounds(t){const e=this.clone(),s=this.rotatedPoints(t),i=s[0],n=s[1],o=s[2],r=s[3];return e.x=Math.min(o.x,i.x,n.x,r.x),e.y=Math.min(o.y,i.y,n.y,r.y),e.width=Math.max(o.x,i.x,n.x,r.x)-e.x,e.height=Math.max(o.y,i.y,n.y,r.y)-e.y,e}rotatedPoints(t){const e=this.center(),s=this.bottomRight().rotate(t,e);return[this.topLeft().rotate(t,e),this.topRight().rotate(t,e),s,this.bottomLeft().rotate(t,e)]}toString(t){return t=t||" ",this.x+t+this.y+t+this.width+t+this.height}scale(t,e,s,i,n){let o=this.topLeft();const r=this.center();o.rotate(n,r).rotate(n,i);const h=s.minus(o);const a=new Ot(h.x*t,h.y*e);const c=h.minus(a);o=o.plus(c),o.rotate(n,i).rotate(n,r),this.x=o.x,this.y=o.y,this.width*=t,this.height*=e}zoom(t){return this.x*=t,this.y*=t,this.width*=t,this.height*=t,this}overlaps(t){const e=this.bottomRight();const s=t.bottomRight();return!(e.x<t.x||e.y<t.y||s.x<this.x||s.y<this.y)}static toRect(t){return t instanceof Nt||(t=new Nt(t.x,t.y,t.width,t.height)),t}static empty(){return new Nt(0,0,0,0)}static fromPoints(t,e){if(isNaN(t.x)||isNaN(t.y)||isNaN(e.x)||isNaN(e.y))throw new Error("Some values are NaN.");return new Nt(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.abs(t.x-e.x),Math.abs(t.y-e.y))}}class Bt{constructor(t){this.container=Nt.toRect(t)}align(t,e){const s=e.toLowerCase().split(" ");for(let e=0;e<s.length;e++)t=this._singleAlign(t,s[e]);return t}_singleAlign(t,e){return Y(this[e])?this[e](t):t}left(t){return this._align(t,this._left)}center(t){return this._align(t,this._center)}right(t){return this._align(t,this._right)}stretch(t){return this._align(t,this._stretch)}top(t){return this._align(t,this._top)}middle(t){return this._align(t,this._middle)}bottom(t){return this._align(t,this._bottom)}_left(t,e){e.x=t.x}_center(t,e){e.x=(t.width-e.width)/2||0}_right(t,e){e.x=t.width-e.width}_top(t,e){e.y=t.y}_middle(t,e){e.y=(t.height-e.height)/2||0}_bottom(t,e){e.y=t.height-e.height}_stretch(t,e){e.x=0,e.y=0,e.height=t.height,e.width=t.width}_align(t,e){return t=Nt.toRect(t),e(this.container,t),t}}class At{constructor(){this._tail=null,this._head=null,this.length=0}enqueue(t){const e={value:t,next:null};this._head?(this._tail.next=e,this._tail=this._tail.next):(this._head=e,this._tail=this._head),this.length++}dequeue(){if(this.length<1)throw new Error("The queue is empty.");const t=this._head.value;return this._head=this._head.next,this.length--,t}contains(t){let e=this._head;for(;e;){if(e.value===t)return!0;e=e.next}return!1}}const Vt="object";function Ht(t,e){for(const s in e){if("__proto__"===s||"constructor"===s)continue;const i=e[s];const n=typeof i;let o;if(o=n===Vt&&null!==i?i.constructor:null,o&&o!==Array)if(i instanceof Date)t[s]=new Date(i.getTime());else if("function"==typeof i.clone)t[s]=i.clone();else{const e=t[s];t[s]=typeof e===Vt&&e||{},Ht(t[s],i)}else"undefined"!==n&&(t[s]=i)}return t}function Ft(t,...e){const s=e.length;for(let i=0;i<s;i++)Ht(t,e[i]);return t}const Ut={type:"Tree",subtype:"Down",roots:null,animate:!1,limitToView:!1,friction:.9,nodeDistance:50,iterations:300,horizontalSeparation:90,verticalSeparation:50,underneathVerticalTopOffset:15,underneathHorizontalOffset:15,underneathVerticalSeparation:15,grid:{width:1500,offsetX:50,offsetY:50,componentSpacingX:20,componentSpacingY:20},layerSeparation:50,layeredIterations:2,startRadialAngle:0,endRadialAngle:360,radialSeparation:150,radialFirstLevelSeparation:200,keepComponentsInOneRadialLayout:!1,ignoreContainers:!0,layoutContainerChildren:!1,ignoreInvisible:!0,animateTransitions:!1};class Wt{constructor(){this.defaultOptions={...Ut,grid:{...Ut.grid}}}gridLayoutComponents(t){if(!t)throw new Error("No components supplied.");rt(t,(function(t){t.calcBounds()})),t.sort((function(t,e){return e.bounds.width-t.bounds.width}));const e=this.options.grid.width,s=this.options.grid.componentSpacingX,i=this.options.grid.componentSpacingY,n=this.options.grid.offsetX,o=[],r=[];let h=0,a=n,c=this.options.grid.offsetY;for(;t.length>0;){a>=e&&(a=n,c+=h+i,h=0);const l=t.pop();this.moveToOffset(l,new Ot(a,c));for(let t=0;t<l.nodes.length;t++)r.push(l.nodes[t]);for(let t=0;t<l.links.length;t++)o.push(l.links[t]);const d=l.bounds;let u=d.height;(u<=0||isNaN(u))&&(u=0);let p=d.width;(p<=0||isNaN(p))&&(p=0),u>=h&&(h=u),a+=p+s}return{nodes:r,links:o}}moveToOffset(t,e){let s,i;const n=t.bounds,o=e.x-n.x,r=e.y-n.y;for(s=0;s<t.nodes.length;s++){const e=t.nodes[s];let i=e.bounds();0===i.width&&0===i.height&&0===i.x&&0===i.y&&(i=new Nt(0,0,0,0)),i.x+=o,i.y+=r,e.bounds(i)}for(s=0;s<t.links.length;s++){const e=t.links[s];if(e.points){const t=[];const s=e.points;for(i=0;i<s.length;i++){const e=s[i];e.x+=o,e.y+=r,t.push(e)}e.points=t}}return this.currentHorizontalOffset+=n.width+this.options.grid.offsetX,new Ot(o,r)}transferOptions(t){this.options=Ft({},this.defaultOptions),j(t)||(this.options=Ft(this.options,t||{}))}}class qt{constructor(t,e){if(j(t))throw new Error("No diagram given");this.diagram=t,this.nodeMap=new Dt,this.linkMap=new Dt,this.capture(e||t)}capture(t){let e,s,i,n,o,r,h;if(t&&"Graph"===t.type){for(n=0;n<t.nodes.length;n++)e=t.nodes[n],i=e.associatedShape,this.nodeMap.set(i.visual.id,new Nt(e.x,e.y,e.width,e.height));for(n=0;n<t.links.length;n++)r=t.links[n],o=r.associatedConnection,this.linkMap.set(o.visual.id,r.points())}else if(t instanceof Array)for(s=t,n=0;n<s.length;n++)e=s[n],i=e.associatedShape,i&&this.nodeMap.set(i.visual.id,new Nt(e.x,e.y,e.width,e.height));else if(Object.prototype.hasOwnProperty.call(t,"links")&&Object.prototype.hasOwnProperty.call(t,"nodes")){for(s=t.nodes,h=t.links,n=0;n<s.length;n++)e=s[n],i=e.associatedShape,i&&this.nodeMap.set(i.visual.id,new Nt(e.x,e.y,e.width,e.height));for(n=0;n<h.length;n++)r=h[n],o=r.associatedConnection,o&&this.linkMap.set(o.visual.id,r.points)}else{const t=this.diagram.shapes;const e=this.diagram.connections;for(n=0;n<t.length;n++)i=t[n],this.nodeMap.set(i.visual.id,i.bounds());for(n=0;n<e.length;n++)o=e[n],this.linkMap.set(o.visual.id,o.points())}}}class Kt{constructor(t,e){if(this.links=[],this.outgoing=[],this.incoming=[],this.weight=1,this.data=null,this.type="Node",this.isVirtual=!1,q(t)?this.id=t:this.id=Lt(),q(e)){this.associatedShape=e;const t=e.bounds();this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y}else this.associatedShape=null;this.shortForm="Node '"+this.id+"'"}isIsolated(){return $(this.links)}bounds(t){if(!q(t))return new Nt(this.x,this.y,this.width,this.height);this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}isLinkedTo(t){return ht(this.links,(e=>e.getComplement(this)===t))}getChildren(){if(0===this.outgoing.length)return[];const t=[];for(let e=0,s=this.outgoing.length;e<s;e++){const s=this.outgoing[e];t.push(s.getComplement(this))}return t}getParents(){if(0===this.incoming.length)return[];const t=[];for(let e=0,s=this.incoming.length;e<s;e++){const s=this.incoming[e];t.push(s.getComplement(this))}return t}clone(){const t=new Kt;return q(this.weight)&&(t.weight=this.weight),q(this.balance)&&(t.balance=this.balance),q(this.owner)&&(t.owner=this.owner),t.associatedShape=this.associatedShape,t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t}adjacentTo(t){return null!==this.isLinkedTo(t)}removeLink(t){t.source===this&&(at(this.links,t),at(this.outgoing,t),t.source=null),t.target===this&&(at(this.links,t),at(this.incoming,t),t.target=null)}hasLinkTo(t){return ht(this.outgoing,(function(e){return e.target===t}))}degree(){return this.links.length}incidentWith(t){return ct(this.links,t)}getLinksWith(t){return _t(this.links,(function(e){return e.getComplement(this)===t}),this)}getNeighbors(){const t=[];return rt(this.incoming,(function(e){t.push(e.getComplement(this))}),this),rt(this.outgoing,(function(e){t.push(e.getComplement(this))}),this),t}}class Yt{constructor(t,e,s,i){if(j(t))throw new Error("The source of the new link is not set.");if(j(e))throw new Error("The target of the new link is not set.");let n,o;n=J(t)?new Kt(t):t,o=J(e)?new Kt(e):e,this.source=n,this.target=o,this.source.links.push(this),this.target.links.push(this),this.source.outgoing.push(this),this.target.incoming.push(this),q(s)?this.id=s:this.id=Lt(),q(i)?this.associatedConnection=i:this.associatedConnection=null,this.type="Link",this.shortForm="Link '"+this.source.id+"->"+this.target.id+"'"}getComplement(t){if(this.source!==t&&this.target!==t)throw new Error("The given node is not incident with this link.");return this.source===t?this.target:this.source}getCommonNode(t){return this.source===t.source||this.source===t.target?this.source:this.target===t.source||this.target===t.target?this.target:null}isBridging(t,e){return this.source===t&&this.target===e||this.source===e&&this.target===t}getNodes(){return[this.source,this.target]}incidentWith(t){return this.source===t||this.target===t}adjacentTo(t){return ct(this.source.links,t)||ct(this.target.links,t)}changeSource(t){at(this.source.links,this),at(this.source.outgoing,this),t.links.push(this),t.outgoing.push(this),this.source=t}changeTarget(t){at(this.target.links,this),at(this.target.incoming,this),t.links.push(this),t.incoming.push(this),this.target=t}changesNodes(t,e){this.source===t?this.changeSource(e):this.target===t&&this.changeTarget(e)}reverse(){const t=this.source;const e=this.target;return this.source=e,at(t.outgoing,this),this.source.outgoing.push(this),this.target=t,at(e.incoming,this),this.target.incoming.push(this),this}directTo(t){if(this.source!==t&&this.target!==t)throw new Error("The given node is not incident with this link.");this.target!==t&&this.reverse()}createReverseEdge(){const t=this.clone();return t.reverse(),t.reversed=!0,t}clone(){return new Yt(this.source,this.target)}}class jt{constructor(t){this.links=[],this.nodes=[],this._nodeMap=new Dt,this.diagram=null,this._root=null,this.bounds=new Nt,this._hasCachedRelationships=!1,this.type="Graph",this.componentIndex=0,q(t)?J(t)?this.id=t:(this.diagram=t,this.id=t.id):this.id=Lt()}cacheRelationships(t){if(j(t)&&(t=!1),!this._hasCachedRelationships||t){for(let t=0,e=this.nodes.length;t<e;t++){const e=this.nodes[t];e.children=this.getChildren(e),e.parents=this.getParents(e)}this._hasCachedRelationships=!0}}assignLevels(t,e,s){if(!t)throw new Error("Start node not specified.");j(e)&&(e=0),this.cacheRelationships(),j(s)&&(s=new Dt,rt(this.nodes,(function(t){s.add(t,!1)}))),s.set(t,!0),t.level=e;const i=t.children;for(let t=0,n=i.length;t<n;t++){const n=i[t];n&&!s.get(n)&&this.assignLevels(n,e+1,s)}}root(t){if(j(t)){if(this._root)return this._root;{const t=ft(this.nodes,(function(t){return 0===t.incoming.length}));return t||ft(this.nodes)}}this._root=t}getConnectedComponents(){this.componentIndex=0,this.setItemIndices();const t=tt(this.nodes.length,-1);for(let e=0;e<this.nodes.length;e++)-1===t[e]&&(this._collectConnectedNodes(t,e),this.componentIndex++);const e=[];let s;for(s=0;s<this.componentIndex;++s)e[s]=new jt;for(s=0;s<t.length;++s){e[t[s]].addNodeAndOutgoings(this.nodes[s])}return e.sort((function(t,e){return e.nodes.length-t.nodes.length})),e}_collectConnectedNodes(t,e){t[e]=this.componentIndex;const s=this.nodes[e];rt(s.links,(function(e){const i=e.getComplement(s).index;-1===t[i]&&this._collectConnectedNodes(t,i)}),this)}calcBounds(){if(this.isEmpty())return this.bounds=new Nt,this.bounds;let t=null;for(let e=0,s=this.nodes.length;e<s;e++){const s=this.nodes[e];t=t?t.union(s.bounds()):s.bounds()}return this.bounds=t,this.bounds}getSpanningTree(t){const e=new jt;const s=new Dt;let i,n;const o=t.clone();e.root(o),o.level=0,o.id=t.id,s.add(t,e.root()),t.level=0;const r=[];const h=[];e._addNode(e.root()),r.push(t),h.push(t);let a=1;for(;h.length>0;){const t=h.pop();for(let o=0;o<t.links.length;o++){const c=t.links[o].getComplement(t);if(ct(r,c))continue;c.level=t.level+1,a<c.level+1&&(a=c.level+1),ct(h,c)||h.push(c),ct(r,c)||r.push(c),s.containsKey(t)?i=s.get(t):(i=t.clone(),i.level=t.level,i.id=t.id,s.add(t,i)),s.containsKey(c)?n=s.get(c):(n=c.clone(),n.level=c.level,n.id=c.id,s.add(c,n));const l=new Yt(i,n);e.addLink(l)}}const c=[];for(let t=0;t<a;t++)c.push([]);return rt(e.nodes,(function(t){c[t.level].push(t)})),e.treeLevels=c,e.cacheRelationships(),e}takeRandomNode(t,e){if(j(t)&&(t=[]),j(e)&&(e=4),0===this.nodes.length)return null;if(1===this.nodes.length)return ct(t,this.nodes[0])?null:this.nodes[0];const s=this.nodes.filter((function(s){return!ct(t,s)&&s.degree()<=e}));return $(s)?null:s[et(0,s.length)]}isEmpty(){return $(this.nodes)}isHealthy(){return _t(this.links,(function(t){return ct(this.nodes,t.source)&&ct(this.nodes,t.target)}),this)}getParents(t){if(!this.hasNode(t))throw new Error("The given node is not part of this graph.");return t.getParents()}getChildren(t){if(!this.hasNode(t))throw new Error("The given node is not part of this graph.");return t.getChildren()}addLink(t,e,s){if(j(t))throw new Error("The source of the link is not defined.");if(j(e)){if(q(t.type)&&"Link"===t.type)return void this.addExistingLink(t);throw new Error("The target of the link is not defined.")}let i=this.getNode(t);j(i)&&(i=this.addNode(t));let n=this.getNode(e);j(n)&&(n=this.addNode(e));const o=new Yt(i,n);return q(s)&&(o.owner=s),this.links.push(o),o}removeAllLinks(){for(;this.links.length>0;){const t=this.links[0];this.removeLink(t)}}addExistingLink(t){if(!this.hasLink(t)){if(this.links.push(t),this.hasNode(t.source.id)){const e=this.getNode(t.source.id);t.changeSource(e)}else this.addNode(t.source);if(this.hasNode(t.target.id)){const e=this.getNode(t.target.id);t.changeTarget(e)}else this.addNode(t.target)}}hasLink(t){if(J(t))return ht(this.links,(function(e){return e.id===t}));if("Link"===t.type)return ct(this.links,t);throw new Error("The given object is neither an identifier nor a Link.")}getNode(t){const e=t.id||t;if(this._nodeMap.containsKey(e))return this._nodeMap.get(e)}hasNode(t){const e=t.id||t;return this._nodeMap.containsKey(e)}_addNode(t){this.nodes.push(t),this._nodeMap.add(t.id,t)}_removeNode(t){at(this.nodes,t),this._nodeMap.remove(t.id)}removeNode(t){let e=t;if(J(t)&&(e=this.getNode(t)),!q(e))throw new Error("The identifier should be a Node or the Id (string) of a node.");{const t=e.links;e.links=[];for(let e=0,s=t.length;e<s;e++){const s=t[e];this.removeLink(s)}this._removeNode(e)}}areConnected(t,e){return ht(this.links,(function(s){return s.source===t&&s.target===e||s.source===e&&s.target===t}))}removeLink(t){at(this.links,t),at(t.source.outgoing,t),at(t.source.links,t),at(t.target.incoming,t),at(t.target.links,t)}addNode(t,e,s){let i=null;if(!q(t))throw new Error("No Node or identifier for a new Node is given.");if(J(t)){if(this.hasNode(t))return this.getNode(t);i=new Kt(t)}else{if(this.hasNode(t))return this.getNode(t);i=t}return q(e)&&i.bounds(e),q(s)&&(i.owner=s),this._addNode(i),i}addNodeAndOutgoings(t){this.hasNode(t)||this._addNode(t);const e=t.outgoing;t.outgoing=[],rt(e,(function(t){this.addExistingLink(t)}),this)}setItemIndices(){let t;for(t=0;t<this.nodes.length;++t)this.nodes[t].index=t;for(t=0;t<this.links.length;++t)this.links[t].index=t}clone(t){const e=new jt;const s=q(t)&&!0===t;s&&(e.nodeMap=new Dt,e.linkMap=new Dt);const i=new Dt;return rt(this.nodes,(function(t){const n=t.clone();i.set(t,n),e._addNode(n),s&&e.nodeMap.set(n,t)})),rt(this.links,(function(t){if(i.containsKey(t.source)&&i.containsKey(t.target)){const n=e.addLink(i.get(t.source),i.get(t.target));s&&e.linkMap.set(n,t)}})),e}linearize(t){return jt.Utils.linearize(this,t)}depthFirstTraversal(t,e){if(j(t))throw new Error("You need to supply a starting node.");if(j(e))throw new Error("You need to supply an action.");if(!this.hasNode(t))throw new Error("The given start-node is not part of this graph");const s=this.getNode(t);this._dftIterator(s,e,[])}_dftIterator(t,e,s){e(t),s.push(t);const i=t.getChildren();for(let t=0,n=i.length;t<n;t++){const n=i[t];ct(s,n)||this._dftIterator(n,e,s)}}breadthFirstTraversal(t,e){if(j(t))throw new Error("You need to supply a starting node.");if(j(e))throw new Error("You need to supply an action.");if(!this.hasNode(t))throw new Error("The given start-node is not part of this graph");const s=this.getNode(t);const i=new At;const n=[];for(i.enqueue(s);i.length>0;){const t=i.dequeue();e(t),n.push(t);const s=t.getChildren();for(let t=0,e=s.length;t<e;t++){const e=s[t];ct(n,e)||i.contains(e)||i.enqueue(e)}}}_stronglyConnectedComponents(t,e,s,i,n,o,r){s.add(e,r),i.add(e,r),r++,o.push(e);const h=e.getChildren();let a;for(let c=0,l=h.length;c<l;c++)a=h[c],s.containsKey(a)?ct(o,a)&&i.add(e,Math.min(i.get(e),s.get(a))):(this._stronglyConnectedComponents(t,a,s,i,n,o,r),i.add(e,Math.min(i.get(e),i.get(a))));if(i.get(e)===s.get(e)){const s=[];do{a=o.pop(),s.push(a)}while(a!==e);(!t||s.length>1)&&n.push(s)}}findCycles(t){j(t)&&(t=!0);const e=new Dt;const s=new Dt;const i=[];const n=[];for(let o=0,r=this.nodes.length;o<r;o++){const r=this.nodes[o];e.containsKey(r)||this._stronglyConnectedComponents(t,r,e,s,i,n,0)}return i}isAcyclic(){return $(this.findCycles())}isSubGraph(t){const e=t.linearize();const s=this.linearize();return _t(e,(function(t){return ct(s,t)}))}makeAcyclic(){if(this.isEmpty()||this.nodes.length<=1||this.links.length<=1)return[];if(2===this.nodes.length){const t=[];if(this.links.length>1){const e=this.links[0].source;for(let s=0,i=this.links.length;s<i;s++){const i=this.links[s];if(i.source===e)continue;const n=i.reverse();t.push(n)}}return t}const t=this.clone(!0);const e=this.nodes.length;const s=new Dt;const i=function(t){return 0===t.outgoing.length?2-e:0===t.incoming.length?e-2:t.outgoing.length-t.incoming.length};const n=function(t){const e=i(t);s.containsKey(e)||s.set(e,[]),s.get(e).push(t)};rt(t.nodes,(function(t){n(t)}));let o=[];const r=[];for(;t.nodes.length>0;){let h,a,c;if(s.containsKey(2-e)){const o=s.get(2-e);for(;o.length>0;){a=o.pop();for(let t=0;t<a.links.length;t++){const e=a.links[t];h=e.getComplement(a),c=i(h),at(s.get(c),h),h.removeLink(e),n(h)}t._removeNode(a),r.unshift(a)}}if(s.containsKey(e-2)){const r=s.get(e-2);for(;r.length>0;){h=r.pop();for(let t=0;t<h.links.length;t++){const e=h.links[t];a=e.getComplement(h),c=i(a),at(s.get(c),a),a.removeLink(e),n(a)}o.push(h),t._removeNode(h)}}if(t.nodes.length>0)for(let r=e-3;r>2-e;r--)if(s.containsKey(r)&&s.get(r).length>0){const e=s.get(r).pop();for(let t=0;t<e.links.length;t++){const o=e.links[t];const r=o.getComplement(e);c=i(r),at(s.get(c),r),r.removeLink(o),n(r)}o.push(e),t._removeNode(e);break}}o=o.concat(r);const h=new Dt;for(let e=0;e<this.nodes.length;e++)h.set(t.nodeMap.get(o[e]),e);const a=[];return rt(this.links,(function(t){h.get(t.source)>h.get(t.target)&&(t.reverse(),a.push(t))})),a}}jt.Predefined={EightGraph:()=>jt.Utils.parse(["1->2","2->3","3->4","4->1","3->5","5->6","6->7","7->3"]),Mindmap:()=>jt.Utils.parse(["0->1","0->2","0->3","0->4","0->5","1->6","1->7","7->8","2->9","9->10","9->11","3->12","12->13","13->14","4->15","4->16","15->17","15->18","18->19","18->20","14->21","14->22","5->23","23->24","23->25","6->26"]),ThreeGraph:()=>jt.Utils.parse(["1->2","2->3","3->1"]),BinaryTree:t=>(j(t)&&(t=5),jt.Utils.createBalancedTree(t,2)),Linear:t=>(j(t)&&(t=10),jt.Utils.createBalancedTree(t,1)),Tree:(t,e)=>jt.Utils.createBalancedTree(t,e),Forest:(t,e,s)=>jt.Utils.createBalancedForest(t,e,s),Workflow:()=>jt.Utils.parse(["0->1","1->2","2->3","1->4","4->3","3->5","5->6","6->3","6->7","5->4"]),Grid(t,e){const s=new jt;if(t<=0&&e<=0)return s;for(let i=0;i<t+1;i++){let t=null;for(let n=0;n<e+1;n++){const e=new Kt(i.toString()+"."+n.toString());if(s.addNode(e),t&&s.addLink(t,e),i>0){const t=s.getNode((i-1).toString()+"."+n.toString());s.addLink(t,e)}t=e}}return s}},jt.Utils={parse(t){let e;const s=new jt,i=t.slice();for(let t=0,n=i.length;t<n;t++){const n=i[t];if(J(n)){if(n.indexOf("->")<0)throw new Error("The link should be specified as 'a->b'.");const t=n.split("->");if(2!==t.length)throw new Error("The link should be specified as 'a->b'.");e=new Yt(t[0],t[1]),s.addLink(e)}if(X(n)){if(!e)throw new Error("Specification found before Link definition.");Ft(e,n)}}return s},linearize(t,e){if(j(t))throw new Error("Expected an instance of a Graph object in slot one.");j(e)&&(e=!1);const s=[];for(let i=0,n=t.links.length;i<n;i++){const n=t.links[i];s.push(n.source.id+"->"+n.target.id),e&&s.push({id:n.id})}return s},_addShape:(t,e,s,i)=>(j(e)&&(e=new Ot(0,0)),j(s)&&(s=Lt()),i=Ft({width:20,height:20,id:s,radius:10,fill:"#778899",data:"circle",undoable:!1,x:e.x,y:e.y},i),t.addShape(i)),_addConnection:(t,e,s,i)=>t.connect(e,s,i),createDiagramFromGraph(t,e,s,i){if(j(t))throw new Error("The diagram surface is undefined.");if(j(e))throw new Error("No graph specification defined.");j(s)&&(s=!0),j(i)&&(i=!1);const n=t.element.clientWidth||200;const o=t.element.clientHeight||200;const r=[];let h,a;for(let s=0,c=e.nodes.length;s<c;s++){h=e.nodes[s];let c=h.position;j(c)&&(c=q(h.x)&&q(h.y)?new Ot(h.x,h.y):new Ot(et(10,n-20),et(10,o-20)));const l={};"0"===h.id||i&&Ft(l,{width:150*Math.random()+20,height:80*Math.random()+50,data:"rectangle",fill:{color:"#778899"}}),a=this._addShape(t,c,h.id,l);const d=a.bounds();q(d)&&(h.x=d.x,h.y=d.y,h.width=d.width,h.height=d.height),r[h.id]=a}for(let s=0;s<e.links.length;s++){const i=e.links[s];const n=r[i.source.id];if(j(n))continue;const o=r[i.target.id];j(o)||this._addConnection(t,n,o,{id:i.id})}if(s){new Xt(t).layoutGraph(e,{limitToView:!1});for(let t=0;t<e.nodes.length;t++)h=e.nodes[t],a=r[h.id],a.bounds(new Nt(h.x,h.y,h.width,h.height))}},createBalancedTree(t,e){j(t)&&(t=3),j(e)&&(e=3);const s=new jt;let i,n=-1,o=[];if(t<=0||e<=0)return s;const r=new Kt((++n).toString());s.addNode(r),s.root(r),o.push(r);for(let r=0;r<t;r++){i=[];for(let t=0;t<o.length;t++){const r=o[t];for(let t=0;t<e;t++){const t=new Kt((++n).toString());s.addLink(r,t),i.push(t)}}o=i}return s},createBalancedForest(t,e,s){j(t)&&(t=3),j(e)&&(e=3),j(s)&&(s=5);const i=new jt;let n,o=-1,r=[];if(t<=0||e<=0||s<=0)return i;for(let h=0;h<s;h++){const s=new Kt((++o).toString());i.addNode(s),r=[s];for(let s=0;s<t;s++){n=[];for(let t=0;t<r.length;t++){const s=r[t];for(let t=0;t<e;t++){const t=new Kt((++o).toString());i.addLink(s,t),n.push(t)}}r=n}}return i},createRandomConnectedGraph(t,e,s){j(t)&&(t=40),j(e)&&(e=4),j(s)&&(s=!1);const i=new jt;let n=-1;if(t<=0)return i;const o=new Kt((++n).toString());if(i.addNode(o),1===t)return i;if(t>1){for(let s=1;s<t;s++){const t=i.takeRandomNode([],e);if(!t)break;const n=i.addNode(s.toString());i.addLink(t,n)}if(!s&&t>1){const s=et(1,t);for(let t=0;t<s;t++){const t=i.takeRandomNode([],e);const s=i.takeRandomNode([],e);t&&s&&!i.areConnected(t,s)&&i.addLink(t,s)}}return i}},randomDiagram(t,e,s,i,n){const o=jt.Utils.createRandomConnectedGraph(e,s,i);jt.Utils.createDiagramFromGraph(t,o,!1,n)}};class Xt extends Wt{constructor(t){if(super(),j(t))throw new Error("Diagram is not specified.");this.diagram=t}layout(t){this.transferOptions(t);const e=new Gt(this.diagram).convert(t);if(e.isEmpty())return;const s=e.getConnectedComponents();if($(s))return;for(let e=0;e<s.length;e++){const i=s[e];this.layoutGraph(i,t)}const i=this.gridLayoutComponents(s);return new qt(this.diagram,i)}layoutGraph(t,e){q(e)&&this.transferOptions(e),this.graph=t;const s=9*this.options.nodeDistance;this.temperature=s;const i=this._expectedBounds();this.width=i.width,this.height=i.height;for(let t=0;t<this.options.iterations;t++)this.refineStage=t>=5*this.options.iterations/6,this.tick(),this.temperature=this.refineStage?s/30:s*(1-t/(2*this.options.iterations))}tick(){let t;for(t=0;t<this.graph.nodes.length;t++)this._repulsion(this.graph.nodes[t]);for(t=0;t<this.graph.links.length;t++)this._attraction(this.graph.links[t]);for(t=0;t<this.graph.nodes.length;t++){const e=this.graph.nodes[t];const s=Math.sqrt(e.dx*e.dx+e.dy*e.dy);if(0===s)return;e.x+=Math.min(s,this.temperature)*e.dx/s,e.y+=Math.min(s,this.temperature)*e.dy/s,this.options.limitToView&&(e.x=Math.min(this.width,Math.max(e.width/2,e.x)),e.y=Math.min(this.height,Math.max(e.height/2,e.y)))}}_shake(t){const e=Math.random()*this.options.nodeDistance/4;const s=2*Math.random()*Math.PI;t.x+=e*Math.cos(s),t.y-=e*Math.sin(s)}_InverseSquareForce(t,e,s){let i;if(this.refineStage){const t=e.x-s.x;const n=e.y-s.y;const o=e.width/2;const r=e.height/2;const h=s.width/2;const a=s.height/2;i=Math.pow(t,2)/Math.pow(o+h+this.options.nodeDistance,2)+Math.pow(n,2)/Math.pow(r+a+this.options.nodeDistance,2)}else i=Math.pow(t,2)/Math.pow(this.options.nodeDistance,2);return 4*i/3}_SquareForce(t,e,s){return 1/this._InverseSquareForce(t,e,s)}_repulsion(t){t.dx=0,t.dy=0,rt(this.graph.nodes,(function(e){if(e===t)return;for(;t.x===e.x&&t.y===e.y;)this._shake(e);const s=t.x-e.x;const i=t.y-e.y;const n=Math.sqrt(s*s+i*i);const o=2*this._SquareForce(n,t,e);t.dx+=s/n*o,t.dy+=i/n*o}),this)}_attraction(t){const e=t.target;const s=t.source;if(s===e)return;for(;s.x===e.x&&s.y===e.y;)this._shake(e);const i=s.x-e.x;const n=s.y-e.y;const o=Math.sqrt(i*i+n*n);const r=5*this._InverseSquareForce(o,s,e);const h=i/o*r;const a=n/o*r;e.dx+=h,e.dy+=a,s.dx-=h,s.dy-=a}_expectedBounds(){const t=this.graph.nodes.length;if(0===t)return;const e=pt(this.graph.nodes,(function(t,e){const s=e.width*e.height;return s>0?t+=Math.sqrt(s):0}),0,this)/t*Math.ceil(Math.sqrt(t));return{width:4*(e*Math.sqrt(1.5)),height:4*(e/Math.sqrt(1.5))}}}class Gt{constructor(t){this.nodeMap=new Dt,this.shapeMap=new Dt,this.nodes=[],this.edges=[],this.edgeMap=new Dt,this.finalNodes=[],this.finalLinks=[],this.ignoredConnections=[],this.ignoredShapes=[],this.hyperMap=new Dt,this.hyperTree=new jt,this.finalGraph=null,this.diagram=t}convert(t){if(j(this.diagram))throw new Error("No diagram to convert.");return this.options=Ft({ignoreInvisible:!0,ignoreContainers:!0,layoutContainerChildren:!1},t||{}),this.clear(),this._renormalizeShapes(),this._renormalizeConnections(),this.finalNodes=new Dt(this.nodes),this.finalLinks=new Dt(this.edges),this.finalGraph=new jt,this.finalNodes.forEach((function(t){this.finalGraph.addNode(t)}),this),this.finalLinks.forEach((function(t){this.finalGraph.addExistingLink(t)}),this),this.finalGraph}mapConnection(t){return this.edgeMap.get(t.id)}mapShape(t){return this.nodeMap.get(t.id)}getEdge(t,e){return ft(t.links,(function(s){return s.getComplement(t)===e}))}clear(){this.finalGraph=null,this.hyperTree=!this.options.ignoreContainers&&this.options.layoutContainerChildren?new jt:null,this.hyperMap=!this.options.ignoreContainers&&this.options.layoutContainerChildren?new Dt:null,this.nodeMap=new Dt,this.shapeMap=new Dt,this.nodes=[],this.edges=[],this.edgeMap=new Dt,this.ignoredConnections=[],this.ignoredShapes=[],this.finalNodes=[],this.finalLinks=[]}listToRoot(t){const e=[];let s=t.container;if(!s)return e;for(e.push(s);s.parentContainer;)s=s.parentContainer,e.push(s);return e.reverse(),e}firstNonIgnorableContainer(t){return t.isContainer&&!this.isIgnorableItem(t)?t:t.parentContainer?this.firstNonIgnorableContainer(t.parentContainer):null}isContainerConnection(t,e){return!(!t.isContainer||!this.isDescendantOf(t,e))||e.isContainer&&this.isDescendantOf(e,t)}isDescendantOf(t,e){if(!t.isContainer)throw new Error("Expecting a container.");if(t===e)return!1;if(ct(t.children,e))return!0;const s=[];for(let i=0,n=t.children.length;i<n;i++){const n=t.children[i];n.isContainer&&this.isDescendantOf(n,e)&&s.push(n)}return s.length>0}isIgnorableItem(t){return this.options.ignoreInvisible?(!t.isCollapsed||!this._isVisible(t))&&!(!t.isCollapsed&&this._isVisible(t)):t.isCollapsed&&!this._isTop(t)}isShapeMapped(t){return t.isCollapsed&&!this._isVisible(t)&&!this._isTop(t)}leastCommonAncestor(t,e){if(!t)throw new Error("Parameter should not be null.");if(!e)throw new Error("Parameter should not be null.");if(!this.hyperTree)throw new Error("No hypertree available.");const s=this.listToRoot(t);const i=this.listToRoot(e);let n=null;if($(s)||$(i))return this.hyperTree.root().data;let o=s[0];let r=i[0];let h=0;for(;o===r&&(n=s[h],h++,!(h>=s.length||h>=i.length));)o=s[h],r=i[h];return n?this.hyperTree.nodes.filter((function(t){return t.data.container===n})):this.hyperTree.root().data}_isTop(t){return!t.parentContainer}_isVisible(t){return!!t.visible()&&(t.parentContainer?this._isVisible(t.parentContainer):t.visible())}_isCollapsed(t){return!(!t.isContainer||!t.isCollapsed)||t.parentContainer&&this._isCollapsed(t.parentContainer)}_renormalizeShapes(){if(!this.options.ignoreContainers)throw new Error("Containers are not supported yet, but stay tuned.");for(let t=0,e=this.diagram.shapes.length;t<e;t++){const e=this.diagram.shapes[t];if(this.options.ignoreInvisible&&!this._isVisible(e)||e.isContainer){this.ignoredShapes.push(e);continue}const s=new Kt(e.id,e);s.isVirtual=!1,this.nodeMap.add(e.id,s),this.nodes.push(s)}}_renormalizeConnections(){if(0!==this.diagram.connections.length)for(let t=0,e=this.diagram.connections.length;t<e;t++){const e=this.diagram.connections[t];if(this.isIgnorableItem(e)){this.ignoredConnections.push(e);continue}let s=e.sourceConnector?e.sourceConnector.shape:null;let i=e.targetConnector?e.targetConnector.shape:null;if(!s||!i){this.ignoredConnections.push(e);continue}if(ct(this.ignoredShapes,s)&&!this.shapeMap.containsKey(s)){this.ignoredConnections.push(e);continue}if(ct(this.ignoredShapes,i)&&!this.shapeMap.containsKey(i)){this.ignoredConnections.push(e);continue}this.shapeMap.containsKey(s)&&(s=this.shapeMap[s]),this.shapeMap.containsKey(i)&&(i=this.shapeMap[i]);const n=this.mapShape(s);const o=this.mapShape(i);if(n===o||this.areConnectedAlready(n,o))this.ignoredConnections.push(e);else{if(null===n||null===o)throw new Error("A shape was not mapped to a node.");if(!this.options.ignoreContainers)throw new Error("Containers are not supported yet, but stay tuned.");{if(n.isVirtual||o.isVirtual){this.ignoredConnections.push(e);continue}const t=new Yt(n,o,e.id,e);this.edgeMap.add(e.id,t),this.edges.push(t)}}}}areConnectedAlready(t,e){return ht(this.edges,(function(s){return s.source===t&&s.target===e||s.source===e&&s.target===t}))}}function Jt(t,e,s,i,n){const o=(e.x-t.x)*(i.y-s.y)-(e.y-t.y)*(i.x-s.x);if(W(o))return;const r=((t.y-s.y)*(i.x-s.x)-(t.x-s.x)*(i.y-s.y))/o;const h=((t.y-s.y)*(e.x-t.x)-(t.x-s.x)*(e.y-t.y))/o;return n&&(r<0||r>1||h<0||h>1)?void 0:new Ot(t.x+r*(e.x-t.x),t.y+r*(e.y-t.y))}const Zt={lines:(t,e,s,i)=>Jt(t,e,s,i),segments:(t,e,s,i)=>Jt(t,e,s,i,!0),rectWithLine:(t,e,s)=>Zt.segments(e,s,t.topLeft(),t.topRight())||Zt.segments(e,s,t.topRight(),t.bottomRight())||Zt.segments(e,s,t.bottomLeft(),t.bottomRight())||Zt.segments(e,s,t.topLeft(),t.bottomLeft()),rects(t,e,s){let i=e.topLeft(),n=e.topRight(),o=e.bottomLeft(),r=e.bottomRight();const h=e.center();s&&(i=i.rotate(s,h),n=n.rotate(s,h),o=o.rotate(s,h),r=r.rotate(s,h));let a=t.contains(i)||t.contains(n)||t.contains(o)||t.contains(r)||Zt.rectWithLine(t,i,n)||Zt.rectWithLine(t,i,o)||Zt.rectWithLine(t,n,r)||Zt.rectWithLine(t,o,r);if(!a){if(i=t.topLeft(),n=t.topRight(),o=t.bottomLeft(),r=t.bottomRight(),s){const t=360-s;i=i.rotate(t,h),n=n.rotate(t,h),o=o.rotate(t,h),r=r.rotate(t,h)}a=e.contains(i)||e.contains(n)||e.contains(o)||e.contains(r)}return a}};const $t=(t,e)=>t.map(e);class Qt{constructor(t,e,s,i,n,o){this.a=t||0,this.b=e||0,this.c=s||0,this.d=i||0,this.e=n||0,this.f=o||0}fromMatrix(t){const e=new Qt;return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e.e=t.e,e.f=t.f,e}}class te{constructor(t,e,s,i,n,o){this.a=t||0,this.b=e||0,this.c=s||0,this.d=i||0,this.e=n||0,this.f=o||0}plus(t){this.a+=t.a,this.b+=t.b,this.c+=t.c,this.d+=t.d,this.e+=t.e,this.f+=t.f}minus(t){this.a-=t.a,this.b-=t.b,this.c-=t.c,this.d-=t.d,this.e-=t.e,this.f-=t.f}times(t){return new te(this.a*t.a+this.c*t.b,this.b*t.a+this.d*t.b,this.a*t.c+this.c*t.d,this.b*t.c+this.d*t.d,this.a*t.e+this.c*t.f+this.e,this.b*t.e+this.d*t.f+this.f)}apply(t){return new Ot(this.a*t.x+this.c*t.y+this.e,this.b*t.x+this.d*t.y+this.f)}applyRect(t){return Nt.fromPoints(this.apply(t.topLeft()),this.apply(t.bottomRight()))}toString(){return"matrix("+this.a+" "+this.b+" "+this.c+" "+this.d+" "+this.e+" "+this.f+")"}static fromSVGMatrix(t){const e=new te;return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e.e=t.e,e.f=t.f,e}static fromMatrixVector(t){const e=new te;return e.a=t.a,e.b=t.b,e.c=t.c,e.d=t.d,e.e=t.e,e.f=t.f,e}static fromList(t){if(6!==t.length)throw new Error("The given list should consist of six elements.");const e=new te;return e.a=t[0],e.b=t[1],e.c=t[2],e.d=t[3],e.e=t[4],e.f=t[5],e}static translation(t,e){const s=new te;return s.a=1,s.b=0,s.c=0,s.d=1,s.e=t,s.f=e,s}static unit(){return new te(1,0,0,1,0,0)}static rotation(t,e,s){const i=new te;return i.a=Math.cos(t*Math.PI/180),i.b=Math.sin(t*Math.PI/180),i.c=-i.b,i.d=i.a,i.e=e-e*i.a+s*i.b||0,i.f=s-s*i.a-e*i.b||0,i}static scaling(t,e){const s=new te;return s.a=t,s.b=0,s.c=0,s.d=e,s.e=0,s.f=0,s}static parse(t){let e,s;if(t){if("matrix"===(t=t.trim()).slice(0,6).toLowerCase()){if(s=t.slice(7,t.length-1).trim(),e=s.split(","),6===e.length)return te.fromList($t(e,(function(t){return parseFloat(t)})));if(e=s.split(" "),6===e.length)return te.fromList($t(e,(function(t){return parseFloat(t)})))}if("("===t.slice(0,1)&&")"===t.slice(t.length-1)&&(t=t.substr(1,t.length-1)),t.indexOf(",")>0&&(e=t.split(","),6===e.length))return te.fromList($t(e,(function(t){return parseFloat(t)})));if(t.indexOf(" ")>0&&(e=t.split(" "),6===e.length))return te.fromList($t(e,(function(t){return parseFloat(t)})))}return e}}class ee{constructor(t,e,s){this.point=t,this.left=e,this.right=s}}class se extends Tt{constructor(t){super(),this._hashTable=new It,this.length=0,q(t)&&(t instanceof It?t.forEach((function(t){this.add(t)})):t instanceof Dt&&t.forEach((function(t,e){this.add({key:t,value:e})}),this))}contains(t){return this._hashTable.containsKey(t)}add(t){this._hashTable.get(t)||(this._hashTable.add(t,t),this.length++,this.trigger("changed"))}get(t){return this.contains(t)?this._hashTable.get(t).value:null}hash(t){return this._hashTable._hash(t)}remove(t){this.contains(t)&&(this._hashTable.remove(t),this.length--,this.trigger("changed"))}forEach(t,e){const s=e?t.bind(e):t;this._hashTable.forEach((function(t){s(t.value)}))}toArray(){const t=[];return this.forEach((function(e){t.push(e)})),t}}class ie{constructor(t,e){this.width=t,this.height=e}static Empty(){return new ie(0,0)}}class ne{constructor(t,e,s){this.x=e||0,this.y=s||0,this.angle=t}toString(){return this.x&&this.y?`rotate(${this.angle},${this.x},${this.y})`:`rotate(${this.angle})`}toMatrix(){return te.rotation(this.angle,this.x,this.y)}center(){return new Ot(this.x,this.y)}invert(){return new ne(360-this.angle,this.x,this.y)}static create(t){return new ne(t.angle,t.x,t.y)}static parse(t){const e=t.slice(1,t.length-1).split(",");const s=parseFloat(e[0]);const i=parseFloat(e[1]);const n=parseFloat(e[2]);return new ne(s,i,n)}}ne.ZERO=new ne(0);class oe{constructor(t,e){this.x=t,this.y=e}toMatrix(){return te.scaling(this.x,this.y)}toString(){return`scale(${this.x},${this.y})`}invert(){return new oe(1/this.x,1/this.y)}}class re{constructor(t,e){this.x=t,this.y=e}toMatrixVector(){return new Qt(0,0,0,0,this.x,this.y)}toMatrix(){return te.translation(this.x,this.y)}toString(){return`translate(${this.x},${this.y})`}plus(t){this.x+=t.x,this.y+=t.y}times(t){this.x*=t,this.y*=t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){0!==this.Length&&this.times(1/this.length())}invert(){return new re(-this.x,-this.y)}}class he{constructor(t,e,s,i,n,o){this.translate=new re(t,e),void 0!==s&&void 0!==i&&(this.scale=new oe(s,i)),void 0!==n&&(this.rotate=o?new ne(n,o.x,o.y):new ne(n))}toString(){const t=function(t){return t?t.toString():""};return t(this.translate)+t(this.rotate)+t(this.scale)}render(t){t._transform=this,t._renderTransform()}toMatrix(){let t=te.unit();return this.translate&&(t=t.times(this.translate.toMatrix())),this.rotate&&(t=t.times(this.rotate.toMatrix())),this.scale&&(t=t.times(this.scale.toMatrix())),t}invert(){const t=this.rotate?this.rotate.invert():void 0,e=t?t.toMatrix():te.unit(),s=this.scale?this.scale.invert():void 0,i=s?s.toMatrix():te.unit();let n=new Ot(-this.translate.x,-this.translate.y);n=e.times(i).apply(n);const o=new re(n.x,n.y);const r=new he;return r.translate=o,r.rotate=t,r.scale=s,r}}function ae(t,e){const s=this.options;let i=!1;let n,o;for(let r=0;r<e.length;r++)o=e[r],n=t[o],Z(n)&&s[o]!==n&&(s[o]=n,i=!0);return i}class ce{constructor(t){this.options=Ft({},this.options,t),this.id=this.options.id,this._originSize=Nt.empty(),this._transform=new he}visible(t){return this.drawingContainer().visible(t)}redraw(t){t&&t.id&&(this.id=t.id)}position(t,e){const s=this.options;if(!K(t))return new Ot(s.x,s.y);K(e)?(s.x=t,s.y=e):t instanceof Ot&&(s.x=t.x,s.y=t.y),this._transform.translate=new re(s.x,s.y),this._renderTransform()}rotate(t,e){return K(t)&&(this._transform.rotate=new ne(t,e.x,e.y),this._renderTransform()),this._transform.rotate||ne.ZERO}drawingContainer(){return this.drawingElement}_renderTransform(){const t=this._transform.toMatrix();this.drawingContainer().transform(new e.M(t.a,t.b,t.c,t.d,t.e,t.f))}_hover(){}_diffNumericOptions(t,e){return ae.call(this,t,e)}_measure(t){let s;if(!this._measured||t){const t=this._boundingBox()||new e.R([0,0],[0,0]);const i=t.topLeft();s=new Nt(i.x,i.y,t.width(),t.height()),this._originSize=s,this._originWidth=s.width,this._originHeight=s.height,this._measured=!0}else s=this._originSize;return s}_boundingBox(){return this.drawingElement.rawBBox()}}function le(t){return{x:t.x||0,y:t.y||0,width:t.width||0,height:t.height||0}}function de(t){if(t){let e=t;return J(e)&&(e={color:e}),e.color&&(e.color=ue(e.color)),e}}function ue(t){let s;return s=t!==h?new e.C(t).toHex():t,s}function pe(t,s){return new e.S(new e.P(t,s))}function ge(t){if(t)return new e.R([t.x,t.y],[t.width,t.height])}function fe(t,e=0){const s={top:0,right:0,bottom:0,left:0};return"number"==typeof t?s.top=s.right=s.bottom=s.left=t:(s.top=t.top||e,s.right=t.right||e,s.bottom=t.bottom||e,s.left=t.left||e),s}const me=(t,e,s)=>{const i=e.length;for(let n=0;n<i;n++){const o=e[(n+i-1)%i];const r=e[n];const h=e[(n+1)%i];const a=Array.isArray(s)?s[n]:s;const c={x:o.x-r.x,y:o.y-r.y};const l={x:h.x-r.x,y:h.y-r.y};const d=Math.hypot(c.x,c.y);const u=Math.hypot(l.x,l.y);const p=(c.x*l.x+c.y*l.y)/(d*u);const g=Math.acos(Math.max(-1,Math.min(1,p)));const f=a/Math.tan(g/2);const m=Math.min(f,d-.001,u-.001);const _={x:r.x+c.x/d*m,y:r.y+c.y/d*m};const y={x:r.x+l.x/u*m,y:r.y+l.y/u*m};0===n?t.moveTo(_.x,_.y):t.lineTo(_.x,_.y);const w=c.x*l.y-c.y*l.x<0;t.arcTo([y.x,y.y],a,a,!1,w)}t.close()};const _e=(t,s,i,n)=>{const o=t.bbox();if(!o.size.width||!o.size.height)return;const r=i+n;const h=(s+n)/o.size.width;const a=r/o.size.height;t.transform(new e.v(new e.M(h,0,0,a,-o.origin.x*h,-o.origin.y*a)))};function ye(t,e){const s=t.length;const i=[];for(let n=0;n<s;n++){const o=t[(n+s-1)%s];const r=t[n];const h=t[(n+1)%s];const a=Array.isArray(e)?e[n]:e;const c={x:o.x-r.x,y:o.y-r.y};const l={x:h.x-r.x,y:h.y-r.y};const d=Math.hypot(c.x,c.y);const u=Math.hypot(l.x,l.y);const p={x:c.x/d,y:c.y/d};const g={x:l.x/u,y:l.y/u};const f=Math.acos(Math.max(-1,Math.min(1,p.x*g.x+p.y*g.y)));const m=a/Math.sin(f/2)-a;let _={x:p.x+g.x,y:p.y+g.y};const y=Math.hypot(_.x,_.y);_={x:_.x/y,y:_.y/y};const w={x:-_.x,y:-_.y};i.push({x:r.x+w.x*m,y:r.y+w.y*m})}return i}const we={stroke:{color:"gray",width:1},fill:{color:h}};class ve extends ce{constructor(t){super(t=Ft({},we,t)),(t=this.options).fill=de(t.fill),t.stroke=de(t.stroke)}fill(t,e){this._fill({color:ue(t),opacity:e})}stroke(t,e,s){this._stroke({color:ue(t),width:e,opacity:s})}redraw(t){if(t){const e=t.stroke;const s=t.fill;e&&this._stroke(de(e)),s&&this._fill(de(s)),super.redraw(t)}}_hover(t){const e=this.options;const s=e.hover;if(s&&s.fill){const i=t?de(s.fill):e.fill;this._setFill(i)}}_setFill(t){this.drawingElement.fill(t.color,t.opacity)}_evalStrokeOptions(t){const e=this.options;Ft(e,{stroke:t});let s=null;return(t=e.stroke).width>0&&(s={color:t.color,width:t.width,opacity:t.opacity,dashType:t.dashType}),s}_evalFillOptions(t){const e=this.options;return Ft(e,{fill:t||{}}),e.fill}_stroke(t){const e=this._evalStrokeOptions(t);this.drawingElement.options.set("stroke",e)}_fill(t){const s=this._evalFillOptions(t);if(s.gradient){const t=s.gradient;const i="radial"===t.type?e.h:e.L;this.drawingElement.fill(new i(t))}else this.drawingElement.fill(s.color,s.opacity)}}const xe={stroke:{color:h,width:0},fill:{color:"black"}};class be extends ve{constructor(t){super(t=Ft({},xe,t));const s=this.options.anchor||{};this.anchor=new e.P(s.x,s.y),this.createElement()}createElement(){}_transformToPath(t,e){const s=e.transform();return t&&s&&(t=t.transformCopy(s)),t}redraw(t){t&&(t.position&&(this.options.position=t.position),super.redraw(t))}}const Ce={path:"M 0 0 L 10 5 L 0 10 L 3 5 z",anchor:{x:10,y:5}};class Se extends be{constructor(t){super(t=Ft({},Ce,t))}createElement(){const t=this.options;this.drawingElement=e.a.parse(t.path,{fill:t.fill,stroke:t.stroke})}positionMarker(t){const s=this._linePoints(t);const i=s.start;const n=s.end;const o=e.t();if(i&&o.rotate(function(t,s){const i=s.x-t.x;const n=s.y-t.y;return e.q(Math.atan2(n,i))}(i,n),n),n){const t=this.anchor;const e=n.clone().translate(-t.x,-t.y);o.translate(e.x,e.y)}this.drawingElement.transform(o)}_linePoints(t){const e=this.options;const s=t.segments;let i,n,o;if(e.position===a){if(o=s[0],o){n=o.anchor(),i=o.controlOut();const t=s[1];!i&&t&&(i=t.anchor())}}else if(o=s[s.length-1],o){n=o.anchor(),i=o.controlIn();const t=s[s.length-2];!i&&t&&(i=t.anchor())}if(n)return{start:this._transformToPath(i,t),end:this._transformToPath(n,t)}}}let Me=class{constructor(t,s){this._translate=(t,e)=>{const s=this._viewBox;return K(t)&&K(e)&&(s.x=t,s.y=e,this.surface.translate({x:t,y:e})),{x:s.x,y:s.y}},this.element=t,this.surface=e.k.create(t,s),Y(this.surface.translate)&&(this.translate=this._translate),this.drawingElement=new e.G,this._viewBox=new Nt(0,0,s.width,s.height),this.size(this._viewBox)}bounds(){const t=this.drawingElement.clippedBBox();return new Nt(0,0,t.width(),t.height())}size(t){const e=this._viewBox;return K(t)&&(e.width=t.width,e.height=t.height,this.surface.setSize(t)),{width:e.width,height:e.height}}draw(){this.surface.draw(this.drawingElement)}append(t){return this.drawingElement.append(t.drawingContainer()),this}remove(t){this.drawingElement.remove(t.drawingContainer())}insertBefore(){}clear(){this.drawingElement.clear()}destroy(t){this.surface.destroy(),t&&(!function(t){for(;t.firstChild;)t.removeChild(t.firstChild)}(this.element),this.element.remove())}};const Te={_setScale:function(){const t=this.options;const e=this._originWidth;const s=this._originHeight;let i=t.width/e;let n=t.height/s;Z(i)||(i=1),Z(n)||(n=1),this._transform.scale=new oe(i,n)},_setTranslate:function(){const t=this.options;const e=t.x||0;const s=t.y||0;this._transform.translate=new re(e,s)},_initSize:function(){const t=this.options;let e=!1;!1!==t.autoSize&&(q(t.width)||q(t.height))&&(this._measure(!0),this._setScale(),e=!0),(q(t.x)||q(t.y))&&(this._setTranslate(),e=!0),e&&this._renderTransform()},_updateSize:function(t){let e=!1;return!1!==this.options.autoSize&&this._diffNumericOptions(t,[i,n])&&(e=!0,this._measure(!0),this._setScale()),this._diffNumericOptions(t,[o,r])&&(e=!0,this._setTranslate()),e&&this._renderTransform(),e}};class ke extends ve{constructor(t){super(t),this._setScale=Te._setScale.bind(this),this._setTranslate=Te._setTranslate.bind(this),this._initSize=Te._initSize.bind(this),this._updateSize=Te._updateSize.bind(this),this._initCircle(),this._initSize()}redraw(t){if(t){const e=this.options;t.center&&(Ft(e,{center:t.center}),this._center.move(e.center.x,e.center.y)),this._diffNumericOptions(t,["radius"])&&this._circle.setRadius(e.radius),this._updateSize(t),super.redraw.call(this,t)}}_initCircle(){const t=this.options;let s=t.width;let i=t.height;let n=t.radius;K(n)||(K(s)||(s=i),K(i)||(i=s),t.radius=n=Math.min(s,i)/2);const o=t.center||{x:n,y:n};this._center=new e.P(o.x,o.y),this._circle=new e.f(this._center,n),this.drawingElement=new e.e(this._circle,{stroke:t.stroke}),this._fill()}}const Ee={radius:4,anchor:{x:0,y:0}};class Pe extends be{constructor(t){super(t=Ft({},Ee,t))}createElement(){const t=this.options;this.drawingElement=new e.e(new e.f(this.anchor,t.radius),{fill:t.fill,stroke:t.stroke})}positionMarker(t){const s=this.options.position;const i=t.segments;let n;let o;n=s===a?i[0]:i[i.length-1],n&&(o=this._transformToPath(n.anchor(),t),this.drawingElement.transform(e.t().translate(o.x,o.y)))}}class Le extends ve{constructor(t){super(t),this._initPath(),this._setPosition()}_setPosition(){const t=this.options;const e=t.x;const s=t.y;(K(e)||K(s))&&this.position(e||0,s||0)}redraw(t){t&&(super.redraw(t),this._diffNumericOptions(t,[i,n])&&this._drawPath(),this._diffNumericOptions(t,[o,r])&&this._setPosition())}_initPath(){const t=this.options;this.drawingElement=new e.a({stroke:t.stroke}),this._fill(),this._drawPath()}_drawPath(){const{width:t,height:e}=le(this.options);const s=this.drawingElement;const i=[{x:0,y:0},{x:t,y:0},{x:t,y:e},{x:0,y:e}];this.options.cornerRadius>0?me(s,i,this.options.cornerRadius):((t,e)=>{const s=e.length;for(let i=0;i<s;i++){const s=e[i];0===i?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y)}t.close()})(s,i)}}class Ie extends Le{_initPath(){const t=this.options;this.drawingElement=new e.g({stroke:t.stroke}),this._fill(),this._drawPath()}}const De={shapesOffsetRatio:.025};class Re extends Ie{constructor(t){super({...De,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.cornerRadius;const n=this.options.stroke.width||0;const o=s*this.options.shapesOffsetRatio-i/2;const r=e/2;const h=s/2;me(t,[{x:r,y:h-o},{x:0,y:0},{x:e,y:0}],[i/3,i,i]);me(t,[{x:r,y:h+o},{x:e,y:s},{x:0,y:s}],[i/3,i,i]),_e(t,e,s,n)}}class ze extends Le{_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=e/2;const n=Math.min(e,s)/2;t.moveTo([i,0]).arcTo([i,s],n,n,!1,!0).arcTo([i,0],n,n,!1,!0)}}const Oe={slantRatio:.15};class Ne extends Le{constructor(t){super({...Oe,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const{slantRatio:n,cornerRadius:o}=this.options;const r=e*n;me(t,[{x:r,y:0},{x:e,y:0},{x:e-r,y:s},{x:0,y:s}],o),_e(t,e,s,i)}}const Be={ellipseRxRatio:.5,ellipseRyRatio:.2};class Ae extends Le{constructor(t){super({...Be,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=e*this.options.ellipseRxRatio;const o=s*this.options.ellipseRyRatio;const r=o;const h=o;t.moveTo([e,r]).arcTo([0,r],n,h,!1,!0).arcTo([e,r],n,h,!1,!0).lineTo([e,s]).arcTo([0,s],n,h,!1,!0).lineTo([0,r]),_e(this.drawingElement,e,s,i)}}const Ve={ellipseRadiusXRatio:.165,ellipseRadiusYRatio:.5};class He extends Ie{constructor(t){super({...Ve,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=e*this.options.ellipseRadiusXRatio;const n=i;const o=s*this.options.ellipseRadiusYRatio;const r=i;t.moveTo(r,0).lineTo(e,0).arc(270,90,n,o,!0).lineTo(r,s).arcTo([r,0],n,o,!1,!0).close()}}class Fe extends Le{_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=ye([{x:0,y:s/2},{x:e/2,y:0},{x:e,y:s/2},{x:e/2,y:s}],this.options.cornerRadius);me(t,n,this.options.cornerRadius),_e(t,e,s,i)}}const Ue={arcRadiusXRatio:.17,arcRadiusYRatio:.3};class We extends Le{constructor(t){super({...Ue,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const{arcRadiusXRatio:n,arcRadiusYRatio:o,cornerRadius:r}=this.options;const h=e*n;const a=s*o;t.moveTo([0,r]).arcTo([r,0],r,r,!0,!1).lineTo([e-h,0]).arcTo([e-h,s],h,a,!1,!1).lineTo([r,s]).arcTo([0,s-r],r,r,!0,!1).close(),_e(this.drawingElement,e,s,i)}}const qe={ellipseRatio:.1407};class Ke extends Le{constructor(t){super({...qe,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=e*this.options.ellipseRatio;const n=i;const o=i;const r=s/2;t.moveTo([e-n,s]).arcTo([e-n,0],o,r,!1,!0).arcTo([e-n,s],o,r,!1,!0).lineTo([n,s]).arcTo([n,0],o,r,!1,!0).lineTo([e-n,0])}}const Ye={sideCutRatio:.35,arcRadiusYRatio:.3,arcRadiusXRatio:.08};class je extends Le{constructor(t){super({...Ye,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=s*this.options.arcRadiusYRatio;const o=e*this.options.arcRadiusXRatio;const r=e-o;const h=e*this.options.sideCutRatio;t.moveTo([h,0]).lineTo([r,0]).arcTo([r,s],o,n,!1,!0).lineTo([r,s]).lineTo([h,s]).lineTo([0,s/2]).close(),_e(this.drawingElement,e,s,i)}}const Xe=5/6;const Ge=1/6;const Je={waveRatio:.37};const Ze={...Je,docsXRatio:.14,docsYRatio:.2};const $e=(t,e,s,i,n,o)=>{const r=i*n;t.moveTo(e[0]+s,e[1]+i).curveTo([e[0]+s,e[1]+i],[e[0]+s*Xe,e[1]+i-r],[e[0]+s/2,e[1]+i]).curveTo([e[0]+s*Ge,e[1]+i+r],[e[0],e[1]+i],[e[0],e[1]+i]).lineTo(e[0],e[1]+o).arcTo([e[0]+o,e[1]],o,o,!0,!1).lineTo(e[0]+s-o,e[1]).arcTo([e[0]+s,e[1]+o],o,o,!0,!1).lineTo(e[0]+s,e[1]+i).close()};class Qe extends Le{constructor(t){super({...Je,...t})}_drawPath(){const{width:t,height:e}=le(this.options);const s=this.options.stroke.width||0;const{waveRatio:i,cornerRadius:n}=this.options;const o=e*i*.5;$e(this.drawingElement,[0,0],t,e-o,i,n),_e(this.drawingElement,t,e,s)}}class ts extends Qe{constructor(t){super({...Ze,...t})}_initPath(){this.drawingElement=new e.G,this._fill(),this._drawPath()}_fill(t){const s=this._evalFillOptions(t);if(s.gradient){const t=s.gradient;const i="radial"===t.type?e.h:e.L;this.drawingElement.children.forEach((e=>{e.fill(new i(t))}))}else this.drawingElement.children.forEach((t=>{t.fill(s.color,s.opacity)}))}_drawPath(){const{width:t,height:s}=le(this.options);const i=this.options.stroke.width||0;const{waveRatio:n,docsXRatio:o,docsYRatio:r,stroke:h,fill:a,cornerRadius:c}=this.options;const l=t*o;const d=s*r;const u=this.drawingElement;const p=new e.g({stroke:h,fill:a});const g=new e.g({stroke:h,fill:a});const f=s*n*.5;$e(p,[l,0],t-l,s-d-f,n,c),$e(g,[0,d],t-l,s-d-f,n,c),u.append(p),u.append(g),_e(this.drawingElement,t,s,i)}}class es extends Le{_drawPath(){const{width:t,height:e}=le(this.options);const s=e/2;this.drawingElement.moveTo(s,0).lineTo(t-2*s,0).arcTo([t-2*s,e],s,s,!1,!1).lineTo(s,e).arcTo([s,0],s,s,!1,!1).close()}}class ss extends Le{_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=this.options.cornerRadius||0;const o=ye([{x:e/2,y:0},{x:e,y:s},{x:0,y:s}],n);me(t,o,n),_e(t,e,s,i)}}class is extends ce{constructor(t){super(t=Ft({autoSize:!1},t)),this.children=[],this._childrenChange=!1,this._setScale=Te._setScale.bind(this),this._setTranslate=Te._setTranslate.bind(this),this._initSize=Te._initSize.bind(this),this._updateSize=Te._updateSize.bind(this),this.drawingElement=new e.G,this._initSize()}append(t){this.drawingElement.append(t.drawingContainer()),this.children.push(t),this._childrenChange=!0}remove(t){this._remove(t)&&(this._childrenChange=!0)}_remove(t){const e=this.children.indexOf(t);if(e>=0)return this.drawingElement.removeAt(e),this.children.splice(e,1),!0}clear(){this.drawingElement.clear(),this.children=[],this._childrenChange=!0}toFront(t){let e;for(let s=0;s<t.length;s++)e=t[s],this._remove(e)&&this.append(e)}toBack(t){this._reorderChildren(t,0)}toIndex(t,e){this._reorderChildren(t,e)}_reorderChildren(t,e){const s=this.drawingElement;const i=s.children.slice(0);const n=this.children;const o=Z(e);let r,h,a,c,l;for(r=0;r<t.length;r++)l=t[r],c=l.drawingContainer(),h=n.indexOf(l),h>=0&&(i.splice(h,1),n.splice(h,1),a=o?e:e[r],i.splice(a,0,c),n.splice(a,0,l));s.clear(),s.append(...i)}redraw(t){t&&(this._childrenChange?(this._childrenChange=!1,this._updateSize(t)||this._initSize()):this._updateSize(t),super.redraw(t))}_boundingBox(){const t=this.children;let s;let i,n;for(let o=0;o<t.length;o++)i=t[o],i.visible()&&!1!==i._includeInBBox&&(n=i.drawingContainer().clippedBBox(null),n&&(s=s?e.R.union(s,n):n));return s}}class ns extends ce{constructor(t){super(t),this._initImage()}redraw(t){t&&(t.source&&this.drawingElement.src(t.source),this._diffNumericOptions(t,[i,n,o,r])&&this.drawingElement.rect(this._rect()),super.redraw(t))}_initImage(){const t=this.options;const s=this._rect();this.drawingElement=new e.I(t.source,s)}_rect(){const t=le(this.options);const s=new e.P(t.x,t.y);const i=new e.o(t.width,t.height);return new e.R(s,i)}}const os={leftLineOffsetRatio:.13,topLineOffsetRatio:.23};class rs extends Ie{constructor(t){super({...os,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const{leftLineOffsetRatio:i,topLineOffsetRatio:n}=this.options;const o=e*i;const r=s*n;me(t,[{x:0,y:0},{x:e,y:0},{x:e,y:s},{x:0,y:s}],this.options.cornerRadius),t.moveTo(o,0).lineTo(o,s).moveTo(0,r).lineTo(e,r)}}const hs={_getPath:function(t){let s=this.drawingElement;if(s instanceof e.g&&(s=t===a?s.paths[0]:s.paths[s.paths.length-1]),s&&s.segments.length)return s},_normalizeMarkerOptions:function(t){const e=t.startCap;const s=t.endCap;J(e)&&(t.startCap={type:e}),J(s)&&(t.endCap={type:s})},_removeMarker:function(t){const e=this._markers[t];e&&(this.drawingContainer().remove(e.drawingElement),delete this._markers[t])},_createMarkers:function(){const t=this.options;this._normalizeMarkerOptions(t),this._markers={},this._markers[a]=this._createMarker(t.startCap,a),this._markers[c]=this._createMarker(t.endCap,c)},_createMarker:function(t,e){const s=(t||{}).type;const i=this._getPath(e);let n,o;if(i)return s===l.FilledCircle?n=Pe:s===l.ArrowStart||s===l.ArrowEnd?n=Se:this._removeMarker(e),n?(o=new n(Ft({},t,{position:e})),o.positionMarker(i),this.drawingContainer().append(o.drawingElement),o):void 0;this._removeMarker(e)},_positionMarker:function(t){const e=this._markers[t];if(e){const s=this._getPath(t);s?e.positionMarker(s):this._removeMarker(t)}},_capMap:{start:"startCap",end:"endCap"},_redrawMarker:function(t,e,s){this._normalizeMarkerOptions(s);const i=this.options;const n=this._capMap[e];const o=(i[n]||{}).type;const r=s[n];let h=!1;return r?(i[n]=Ft({},i[n],r),r.type&&o!==r.type?(this._removeMarker(e),this._markers[e]=this._createMarker(i[n],e),h=!0):this._markers[e]&&this._markers[e].redraw(r)):t&&!this._markers[e]&&i[n]&&(this._markers[e]=this._createMarker(i[n],e),h=!0),h},_redrawMarkers:function(t,e){!this._redrawMarker(t,a,e)&&t&&this._positionMarker(a),!this._redrawMarker(t,c,e)&&t&&this._positionMarker(c)}};const as={topSlantRatio:.2};class cs extends Le{constructor(t){super({...as,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const{topSlantRatio:n,cornerRadius:o}=this.options;me(t,[{x:0,y:s*n},{x:e,y:0},{x:e,y:s},{x:0,y:s}],o),_e(t,e,s,i)}}const ls={baseShrinkRatio:.5};class ds extends Le{constructor(t){super({...ls,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=e*this.options.baseShrinkRatio;me(t,[{x:0,y:0},{x:e,y:0},{x:e-n/2,y:s},{x:n/2,y:s}],this.options.cornerRadius),_e(t,e,s,i)}}class us extends Le{_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=ye([{x:0,y:0},{x:e,y:0},{x:e/2,y:s}],this.options.cornerRadius);me(t,n,this.options.cornerRadius),_e(t,e,s,i)}}class ps extends Ie{_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=e/2;const n=s/2;const o=Math.min(e,s)/2-this.options.stroke.width;t.moveTo(i,0).arcTo([i,s],o,o,!1,!0).arcTo([i,0],o,o,!1,!0).moveTo(0,n).lineTo(e,n).moveTo(i,0).lineTo(i,s)}}const gs={ellipseRxRatio:.5,ellipseRyRatio:.13,bottomEdgeYRatio:.76};class fs extends Le{constructor(t){super({...gs,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=e*this.options.ellipseRxRatio;const o=s*this.options.ellipseRyRatio;const r=o;const h=r;const a=r;const c=s*this.options.bottomEdgeYRatio;const l=e/2;const d=s;t.moveTo([0,r]).arcTo([e,a],n,o,!1,!1).lineTo([e,c]).lineTo([l,d]).lineTo([0,c]).lineTo([0,h]).close(),_e(this.drawingElement,e,s,i)}}class ms extends ve{constructor(t){super(t=Ft({autoSize:!0},t)),this._capMap=hs._capMap,this.container=new e.G,this._setScale=Te._setScale.bind(this),this._setTranslate=Te._setTranslate.bind(this),this._initSize=Te._initSize.bind(this),this._updateSize=Te._updateSize.bind(this),this._getPath=hs._getPath.bind(this),this._normalizeMarkerOptions=hs._normalizeMarkerOptions.bind(this),this._removeMarker=hs._removeMarker.bind(this),this._createMarkers=hs._createMarkers.bind(this),this._createMarker=hs._createMarker.bind(this),this._positionMarker=hs._positionMarker.bind(this),this._redrawMarker=hs._redrawMarker.bind(this),this._redrawMarkers=hs._redrawMarkers.bind(this),this._createElements(),this._initSize()}drawingContainer(){return this.container}data(t){const e=this.options;if(!t)return e.data;e.data!==t&&(e.data=t,this._setData(t),this._initSize(),this._redrawMarkers(!0,{}))}redraw(t){if(t){super.redraw(t);const e=this.options;const s=t.data;K(s)&&e.data!==s?(e.data=s,this._setData(s),this._updateSize(t)||this._initSize(),this._redrawMarkers(!0,t)):(this._updateSize(t),this._redrawMarkers(!1,t))}}_createElements(){const t=this.options;this.drawingElement=e.a.parse(t.data||"",{stroke:t.stroke}),this._fill(),this.container.append(this.drawingElement),this._createMarkers()}_setData(t){const s=this.drawingElement;const i=e.a.parse(t||"");const n=i.paths.slice(0);i.paths.elements([]),s.paths.elements(n)}}class _s extends ve{constructor(t){super(t=Ft({points:[]},t)),this._capMap=hs._capMap,this.container=new e.G,this._getPath=hs._getPath.bind(this),this._normalizeMarkerOptions=hs._normalizeMarkerOptions.bind(this),this._removeMarker=hs._removeMarker.bind(this),this._createMarkers=hs._createMarkers.bind(this),this._createMarker=hs._createMarker.bind(this),this._positionMarker=hs._positionMarker.bind(this),this._redrawMarker=hs._redrawMarker.bind(this),this._redrawMarkers=hs._redrawMarkers.bind(this),this._initPath(),this._createMarkers()}drawingContainer(){return this.container}points(t){const e=this.options;if(!t)return e.points;e.points=t,this._updatePath()}redraw(t){if(t){const e=t.points;super.redraw.call(this,t),e&&this._pointsDiffer(e)?(this.points(e),this._redrawMarkers(!0,t)):this._redrawMarkers(!1,t)}}_initPath(){const t=this.options;this.drawingElement=new e.a({stroke:t.stroke}),this._fill(),this.container.append(this.drawingElement),t.points&&this._updatePath()}_pointsDiffer(t){const e=this.options.points;let s=e.length!==t.length;if(!s)for(let i=0;i<t.length;i++)if(e[i].x!==t[i].x||e[i].y!==t[i].y){s=!0;break}return s}_updatePath(){const t=this.drawingElement;const e=this.options.points;const s=[];let i;for(let t=0;t<e.length;t++)i=e[t],s.push(pe(i.x,i.y));t.segments.elements(s)}}const ys={sideLineOffsetRatio:.1};class ws extends Ie{constructor(t){super({...ys,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=e*this.options.sideLineOffsetRatio;const n=i;const o=e-i;me(t,[{x:0,y:0},{x:e,y:0},{x:e,y:s},{x:0,y:s}],this.options.cornerRadius),t.moveTo(n,0).lineTo(n,s).moveTo(o,0).lineTo(o,s)}}const vs={horizontalInsetRatio:1/6};class xs extends Le{constructor(t){super({...vs,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=e*this.options.horizontalInsetRatio;me(t,[{x:n,y:0},{x:e-n,y:0},{x:e,y:s/2},{x:e-n,y:s},{x:n,y:s},{x:0,y:s/2}],this.options.cornerRadius),_e(t,e,s,i)}}class bs extends Le{}const Cs={shapesOffsetRatio:.015};class Ss extends Ie{constructor(t){super({...Cs,...t})}_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=this.options.stroke.width||0;const n=this.options.cornerRadius;const o=this.options.shapesOffsetRatio*s;const r=s/2;me(t,[{x:e/2,y:0},{x:e,y:r-o},{x:0,y:r-o}],[n/3,n,n]);me(t,[{x:e/2,y:s},{x:0,y:r+o},{x:e,y:r+o}],[n/3,n,n]),_e(t,e,s,i)}}class Ms extends Ie{_drawPath(){const t=this.drawingElement;const{width:e,height:s}=le(this.options);const i=e/2;const n=s/2;const o=.5*Math.min(e,s);const r=n-o;const h=n+o;const a=i-o/Math.SQRT2;const c=n-o/Math.SQRT2;const l=i+o/Math.SQRT2;const d=n+o/Math.SQRT2;t.moveTo(i,r).arcTo([i,h],o,o,!1,!0).arcTo([i,r],o,o,!1,!0).moveTo(a,c).lineTo(l,d).moveTo(l,c).lineTo(a,d)}}const Ts=t=>(t&&t.color&&(t=Ft({},t,{fill:{color:t.color}})),t);const ks={fontSize:15,fontFamily:"sans-serif",lineSpacing:0,textWrap:"nowrap",padding:fe(0),relativePadding:fe(0),stroke:{width:0},fill:{color:"black"},autoSize:!0};class Es extends ve{constructor(t){t=Ft({},ks,t),super(t=Ts(t)),this.textElements=[],this.alignable=!0,this._setScale=Te._setScale.bind(this),this._setTranslate=Te._setTranslate.bind(this),this._initSize=Te._initSize.bind(this),this._updateSize=Te._updateSize.bind(this),this._font(),this._initText(),this._initSize()}_initText(){const t=this.options;this.textElements.length=0,this.drawingElement=new e.T(K(t.text)?t.text:"",new e.P,{font:t.font}),this.textElements.push(this.drawingElement),this._fill(),this._stroke()}_fill(t){const s=this._evalFillOptions(t);if(s.gradient){const t=s.gradient;const i="radial"===t.type?e.h:e.L;this.textElements.forEach((e=>{e.fill(new i(t))}))}else this._setFill(s)}_setFill(t){this.textElements.forEach((e=>{e.fill(t.color,t.opacity)}))}_stroke(t){const e=this._evalStrokeOptions(t);this.textElements.forEach((t=>t.options.set("stroke",e)))}_font(){const t=this.options;if(t.fontFamily&&K(t.fontSize)){const e=[];t.fontStyle&&e.push(t.fontStyle),t.fontWeight&&e.push(t.fontWeight),e.push(t.fontSize+(Z(t.fontSize)?"px":"")),e.push(t.fontFamily),t.font=e.join(" ")}else delete t.font}content(t){return this.drawingElement.content(t)}redraw(t){if(t){let e=!1;const s=this.options;t=Ts(t),super.redraw(t),(t.fontFamily||K(t.fontSize)||t.fontStyle||t.fontWeight)&&(Ft(s,{fontFamily:t.fontFamily,fontSize:t.fontSize,fontStyle:t.fontStyle,fontWeight:t.fontWeight}),this._font(),this.drawingElement.options.set("font",s.font),e=!0),t.text&&(this.content(t.text),e=!0),!this._updateSize(t)&&e&&this._initSize()}}}class Ps{constructor(t,e,s,i){this.x1=t,this.y1=e,this.x2=s,this.y2=i}width(){return this.x2-this.x1}height(){return this.y2-this.y1}pad(t){const e={...t};return this.x1-=e.left,this.x2+=e.right,this.y1-=e.top,this.y2+=e.bottom,this}unpad(t){const e={...t};return e.left=-e.left,e.top=-e.top,e.right=-e.right,e.bottom=-e.bottom,this.pad(e)}toRect(){return new e.R([this.x1,this.y1],[this.width(),this.height()])}}const Ls=(t="")=>{const e={justifyContent:"center",alignContent:"center"};return t.includes("left")&&(e.justifyContent="start"),t.includes("right")&&(e.justifyContent="end"),t.includes("top")&&(e.alignContent="start"),t.includes("bottom")&&(e.alignContent="end"),e};class Is extends Es{constructor(){super(...arguments),this.alignable=!1}content(t){return void 0!==t&&(this.options.text=t,this._initText()),this.options.text}_initText(){this.textElements.length=0,this.alignable=!1;const t=this.drawingElement=this.drawingElement||new e.G;t.children.length&&t.clear();const s=this.options;const{shapeSize:i}=s;const n=new Ps(0,0,i.width,i.height);const o=function(t,e){const s=fe(e,0);return{left:t.width*s.left,top:t.height*s.top,right:t.width*s.right,bottom:t.height*s.bottom}}(i,s.relativePadding);n.unpad(o),n.unpad(s.padding);const r=n.toRect();const h=new e.j(r,{...Ls(s.align),lineSpacing:s.lineSpacing});this._textLines(r?r.size.width:void 0).forEach((i=>{const n=new e.T(i,new e.P(0,0),{font:s.font});this.textElements.push(n),(h||t).append(n)})),h&&(h.reflow(),t.append(h)),this._fill(),this._stroke()}_textLines(t){const{text:s=""}=this.options;if(void 0===t)return[s];const i={font:this.options.font};const n=e.m;const o=s.split(" ");const r=[];let h="";return o.forEach((e=>{for(;n(e,i).width>t;){let s="";for(let o=1;o<=e.length;o++){const r=e.substring(0,o);if(n(r,i).width>t)break;s=r}if(!s)break;h&&(r.push(h),h=""),r.push(s),e=e.substring(s.length)}const s=h?`${h} ${e}`:e;n(s,i).width>t&&h?(r.push(h),h=e):h=s})),h&&r.push(h),r}}class Ds extends Wt{constructor(t){if(super(),j(t))throw new Error("Diagram is not specified.");this.diagram=t}layout(t){this.transferOptions(t);const e=new Gt(this.diagram).convert(t);if(e.isEmpty())return;const s=e.getConnectedComponents();if($(s))return;for(let e=0;e<s.length;e++){const i=s[e];this.layoutGraph(i,t)}const i=this.gridLayoutComponents(s);return new qt(this.diagram,i)}_initRuntimeProperties(){for(let t=0;t<this.graph.nodes.length;t++){const e=this.graph.nodes[t];e.layer=-1,e.downstreamLinkCount=0,e.upstreamLinkCount=0,e.isVirtual=!1,e.uBaryCenter=0,e.dBaryCenter=0,e.upstreamPriority=0,e.downstreamPriority=0,e.gridPosition=0}}_prepare(t){const e=[];let s,i,n;const o=new Dt;let r=0;let h,a,c;for(rt(t.nodes,(function(t){0===t.incoming.length&&(o.set(t,0),e.push(t))}));e.length>0;)for(a=e.shift(),s=0;s<a.outgoing.length;s++)n=a.outgoing[s],c=n.target,h=o.containsKey(c)?Math.max(o.get(a)+1,o.get(c)):o.get(a)+1,o.set(c,h),h>r&&(r=h),ct(e,c)||e.push(c);const l=o.keys();l.sort((function(t,e){const s=o.get(t);const i=o.get(e);return nt(i-s)}));for(let t=0;t<l.length;++t){const e=l[t];let s=Number.MAX_VALUE;if(0!==e.outgoing.length){for(i=0;i<e.outgoing.length;++i)n=e.outgoing[i],s=Math.min(s,o.get(n.target));s>1&&o.set(e,s-1)}}let d;for(this.layers=[],s=0;s<r+1;s++)d=[],d.linksTo={},this.layers.push(d);for(o.forEach((function(t,e){t.layer=e,this.layers[e].push(t)}),this),i=0;i<this.layers.length;i++)for(d=this.layers[i],s=0;s<d.length;s++)d[s].gridPosition=s}layoutGraph(t,e){if(j(t))throw new Error("No graph given or graph analysis of the diagram failed.");q(e)&&this.transferOptions(e),this.graph=t,t.setItemIndices();const s=t.makeAcyclic();this._initRuntimeProperties(),this._prepare(t),this._dummify(),this._optimizeCrossings(),this._swapPairs(),this.arrangeNodes(),this._moveThingsAround(),this._dedummify(),rt(s,(function(t){t.points&&t.points.reverse()}))}setMinDist(t,e,s){const i=t.layer;const n=t.layerIndex;if(!Number.isInteger(i)||!Number.isInteger(n)||i<0||n<0)throw new Error("Invalid layer or index value.");this.minDistances[i][n]=s}getMinDist(t,e){let s=0;const i=t.layerIndex,n=e.layerIndex,o=t.layer,r=Math.min(i,n),h=Math.max(i,n);for(let t=r;t<h;++t)s+=this.minDistances[o][t];return s}placeLeftToRight(t){const e=new Dt;let s,i;for(let n=0;n<this.layers.length;++n){const o=t[n];if(!o)continue;for(s=0;s<o.length;s++)i=o[s],e.containsKey(i)||this.placeLeft(i,e,n);let r=Number.POSITIVE_INFINITY;for(s=0;s<o.length;s++){i=o[s];const t=this.rightSibling(i);t&&this.nodeLeftClass.get(t)!==n&&(r=Math.min(r,e.get(t)-e.get(i)-this.getMinDist(i,t)))}if(r===Number.POSITIVE_INFINITY){const t=[];for(s=0;s<o.length;s++){i=o[s];const r=[];vt(r,this.upNodes.get(i)),vt(r,this.downNodes.get(i));for(let s=0;s<r.length;s++){const o=r[s];this.nodeLeftClass.get(o)<n&&t.push(e.get(o)-e.get(i))}}t.sort(),r=0===t.length?0:t.length%2==1?t[this.intDiv(t.length,2)]:(t[this.intDiv(t.length,2)-1]+t[this.intDiv(t.length,2)])/2}for(s=0;s<o.length;s++)i=o[s],e.set(i,e.get(i)+r)}return e}placeRightToLeft(t){const e=new Dt;let s,i;for(let n=0;n<this.layers.length;++n){const o=t[n];if(!o)continue;for(s=0;s<o.length;s++)i=o[s],e.containsKey(i)||this.placeRight(i,e,n);let r=Number.NEGATIVE_INFINITY;for(s=0;s<o.length;s++){i=o[s];const t=this.leftSibling(i);t&&this.nodeRightClass.get(t)!==n&&(r=Math.max(r,e.get(t)-e.get(i)+this.getMinDist(t,i)))}if(r===Number.NEGATIVE_INFINITY){const t=[];for(s=0;s<o.length;s++){i=o[s];const r=[];vt(r,this.upNodes.get(i)),vt(r,this.downNodes.get(i));for(let s=0;s<r.length;s++){const o=r[s];this.nodeRightClass.get(o)<n&&t.push(e.get(i)-e.get(o))}}t.sort(),r=0===t.length?0:t.length%2==1?t[this.intDiv(t.length,2)]:(t[this.intDiv(t.length,2)-1]+t[this.intDiv(t.length,2)])/2}for(s=0;s<o.length;s++)i=o[s],e.set(i,e.get(i)+r)}return e}_getLeftWing(){const t={value:null};const e=this.computeClasses(t,1);return this.nodeLeftClass=t.value,e}_getRightWing(){const t={value:null};const e=this.computeClasses(t,-1);return this.nodeRightClass=t.value,e}computeClasses(t,e){let s=0;const i=t.value=new Dt;for(let t=0;t<this.layers.length;++t){s=t;const n=this.layers[t];for(let t=1===e?0:n.length-1;t>=0&&t<n.length;t+=e){const e=n[t];if(i.containsKey(e))s=i.get(e);else if(i.set(e,s),e.isVirtual){const t=this._nodesInLink(e);for(let e=0;e<t.length;e++){const n=t[e];i.set(n,s)}}}}const n=[];for(let t=0;t<this.layers.length;t++)n.push(null);return i.forEach((function(t,e){null===n[e]&&(n[e]=[]),n[e].push(t)})),n}_isVerticalLayout(){return"up"===this.options.subtype.toLowerCase()||"down"===this.options.subtype.toLowerCase()||"vertical"===this.options.subtype.toLowerCase()}_isHorizontalLayout(){return"right"===this.options.subtype.toLowerCase()||"left"===this.options.subtype.toLowerCase()||"horizontal"===this.options.subtype.toLowerCase()}_isIncreasingLayout(){return"right"===this.options.subtype.toLowerCase()||"down"===this.options.subtype.toLowerCase()}_moveThingsAround(){let t,e,s,i,n,o;for(e=0;e<this.layers.length;++e)i=this.layers[e],i.sort(this._gridPositionComparer.bind(this));for(this.minDistances=[],e=0;e<this.layers.length;++e)for(i=this.layers[e],this.minDistances[e]=[],n=0;n<i.length;++n)s=i[n],s.layerIndex=n,this.minDistances[e][n]=this.options.nodeDistance,n<i.length-1&&(this._isVerticalLayout()?this.minDistances[e][n]+=(s.width+i[n+1].width)/2:this.minDistances[e][n]+=(s.height+i[n+1].height)/2);for(this.downNodes=new Dt,this.upNodes=new Dt,rt(this.graph.nodes,(function(t){this.downNodes.set(t,[]),this.upNodes.set(t,[])}),this),rt(this.graph.links,(function(t){const e=t.source;const s=t.target;let i=null,n=null;e.layer>s.layer?(i=t.source,n=t.target):(n=t.source,i=t.target),this.downNodes.get(n).push(i),this.upNodes.get(i).push(n)}),this),this.downNodes.forEachValue((function(t){t.sort(this._gridPositionComparer)}),this),this.upNodes.forEachValue((function(t){t.sort(this._gridPositionComparer)}),this),e=0;e<this.layers.length-1;++e)for(i=this.layers[e],o=0;o<i.length-1;o++){const t=i[o];if(!t.isVirtual)continue;const r=this.downNodes.get(t)[0];if(r.isVirtual)for(n=o+1;n<i.length;++n){if(s=i[n],!s.isVirtual)continue;const t=this.downNodes.get(s)[0];if(t.isVirtual&&r.gridPosition>t.gridPosition){const s=r.gridPosition;r.gridPosition=t.gridPosition,t.gridPosition=s;const i=r.layerIndex;const n=t.layerIndex;this.layers[e+1][i]=t,this.layers[e+1][n]=r,r.layerIndex=n,t.layerIndex=i}}}const r=this._getLeftWing();const h=this._getRightWing();const a=this.placeLeftToRight(r);const c=this.placeRightToLeft(h);const l=new Dt;rt(this.graph.nodes,(function(t){l.set(t,(a.get(t)+c.get(t))/2)}));const d=new Dt;const u=new Dt;for(e=0;e<this.layers.length;++e){i=this.layers[e];let t=-1;for(n=0;n<i.length;++n)s=i[n],d.set(s,0),u.set(s,!1),s.isVirtual&&(-1===t||t===n-1||(d.set(i[t],0),l.get(s)-l.get(i[t])===this.getMinDist(i[t],s)?u.set(i[t],!0):u.set(i[t],!1)),t=n)}rt([1,-1],(function(e){for(let s=1===e?0:this.layers.length-1;s>=0&&s<this.layers.length;s+=e){const i=this.layers[s];let n=this._firstVirtualNode(i);let o=null;let r=null;if(-1!==n)for(o=i[n],r=[],t=0;t<n;t++)r.push(i[t]);else o=null,r=i;if(r.length>0){for(this._sequencer(l,null,o,e,r),t=0;t<r.length-1;++t)this.setMinDist(r[t],r[t+1],l.get(r[t+1])-l.get(r[t]));o&&this.setMinDist(r[r.length-1],o,l.get(o)-l.get(r[r.length-1]))}for(;o;){const s=this.nextVirtualNode(i,o);if(s){if(d.get(o)===e){n=o.layerIndex;const h=s.layerIndex;for(r=[],t=n+1;t<h;t++)r.push(i[t]);r.length>0&&this._sequencer(l,o,s,e,r),u.set(o,!0)}}else{for(n=o.layerIndex,r=[],t=n+1;t<i.length;t++)r.push(i[t]);if(r.length>0){for(this._sequencer(l,o,null,e,r),t=0;t<r.length-1;++t)this.setMinDist(r[t],r[t+1],l.get(r[t+1])-l.get(r[t]));this.setMinDist(o,r[0],l.get(r[0])-l.get(o))}}o=s}this.adjustDirections(s,e,d,u)}}),this);const p=this._isIncreasingLayout()?0:this.layers.length-1;const g=this._isIncreasingLayout()?1:-1;let f=0;function m(t,e){let s=Number.MIN_VALUE;for(let i=0;i<t.length;++i){const n=t[i];s=e._isVerticalLayout()?Math.max(s,n.height):Math.max(s,n.width)}return s}for(t=p;_=t,(y=this)._isIncreasingLayout()?_<y.layers.length:_>=0;t+=g){i=this.layers[t];const e=m(i,this);for(n=0;n<i.length;++n)s=i[n],this._isVerticalLayout()?(s.x=l.get(s),s.y=f+e/2):(s.x=f+e/2,s.y=l.get(s));f+=this.options.layerSeparation+e}var _,y}adjustDirections(t,e,s,i){if(t+e<0||t+e>=this.layers.length)return;let n=null,o=null;const r=this.layers[t+e];for(let h=0;h<r.length;++h){const a=r[h];if(a.isVirtual){const h=this.getNeighborOnLayer(a,t);if(h.isVirtual){if(n){let c=i.get(o);const l=this.layers[t];const d=o.layerIndex;const u=h.layerIndex;for(let t=d+1;t<u;++t)l[t].isVirtual&&(c=c&&i.get(l[t]));if(c){s.set(n,e);const t=n.layerIndex;const i=a.layerIndex;for(let n=t+1;n<i;++n)r[n].isVirtual&&s.set(r[n],e)}}n=a,o=h}}}}getNeighborOnLayer(t,e){let s=this.upNodes.get(t)[0];return s.layer===e?s:(s=this.downNodes.get(t)[0],s.layer===e?s:null)}_sequencer(t,e,s,i,n){if(1===n.length&&this._sequenceSingle(t,e,s,i,n[0]),n.length>1){const o=n.length,r=this.intDiv(o,2);this._sequencer(t,e,s,i,n.slice(0,r)),this._sequencer(t,e,s,i,n.slice(r)),this.combineSequences(t,e,s,i,n)}}_sequenceSingle(t,e,s,i,n){const o=-1===i?this.downNodes.get(n):this.upNodes.get(n);const r=o.length;0!==r&&(r%2==1?t.set(n,t.get(o[this.intDiv(r,2)])):t.set(n,(t.get(o[this.intDiv(r,2)-1])+t.get(o[this.intDiv(r,2)]))/2),e&&t.set(n,Math.max(t.get(n),t.get(e)+this.getMinDist(e,n))),s&&t.set(n,Math.min(t.get(n),t.get(s)-this.getMinDist(n,s))))}combineSequences(t,e,s,i,n){const o=n.length,r=this.intDiv(o,2);const h=[];let a,c,l,d,u,p;for(a=0;a<r;++a){for(c=0,d=-1===i?this.downNodes.get(n[a]):this.upNodes.get(n[a]),l=0;l<d.length;++l)u=d[l],t.get(u)>=t.get(n[a])?c++:(c--,h.push({k:t.get(u)+this.getMinDist(n[a],n[r-1]),v:2}));h.push({k:t.get(n[a])+this.getMinDist(n[a],n[r-1]),v:c})}e&&h.push({k:t.get(e)+this.getMinDist(e,n[r-1]),v:Number.MAX_VALUE}),h.sort(this._positionDescendingComparer.bind(this));const g=[];for(a=r;a<o;++a){for(c=0,d=-1===i?this.downNodes.get(n[a]):this.upNodes.get(n[a]),l=0;l<d.length;++l)u=d[l],t.get(u)<=t.get(n[a])?c++:(c--,g.push({k:t.get(u)-this.getMinDist(n[a],n[r]),v:2}));g.push({k:t.get(n[a])-this.getMinDist(n[a],n[r]),v:c})}s&&g.push({k:t.get(s)-this.getMinDist(s,n[r]),v:Number.MAX_VALUE}),g.sort(this._positionAscendingComparer.bind(this));let f=0,m=0;const _=this.getMinDist(n[r-1],n[r]);for(;t.get(n[r])-t.get(n[r-1])<_;)if(f<m){if(0===h.length){t.set(n[r-1],t.get(n[r])-_);break}p=h.shift(),f+=p.v,t.set(n[r-1],p.k),t.set(n[r-1],Math.max(t.get(n[r-1]),t.get(n[r])-_))}else{if(0===g.length){t.set(n[r],t.get(n[r-1])+_);break}p=g.shift(),m+=p.v,t.set(n[r],p.k),t.set(n[r],Math.min(t.get(n[r]),t.get(n[r-1])+_))}for(a=r-2;a>=0;a--)t.set(n[a],Math.min(t.get(n[a]),t.get(n[r-1])-this.getMinDist(n[a],n[r-1])));for(a=r+1;a<o;a++)t.set(n[a],Math.max(t.get(n[a]),t.get(n[r])+this.getMinDist(n[a],n[r])))}placeLeft(t,e,s){let i=Number.NEGATIVE_INFINITY;rt(this._getComposite(t),(function(t){const n=this.leftSibling(t);n&&this.nodeLeftClass.get(n)===this.nodeLeftClass.get(t)&&(e.containsKey(n)||this.placeLeft(n,e,s),i=Math.max(i,e.get(n)+this.getMinDist(n,t)))}),this),i===Number.NEGATIVE_INFINITY&&(i=0),rt(this._getComposite(t),(function(t){e.set(t,i)}))}placeRight(t,e,s){let i=Number.POSITIVE_INFINITY;rt(this._getComposite(t),(function(t){const n=this.rightSibling(t);n&&this.nodeRightClass.get(n)===this.nodeRightClass.get(t)&&(e.containsKey(n)||this.placeRight(n,e,s),i=Math.min(i,e.get(n)-this.getMinDist(t,n)))}),this),i===Number.POSITIVE_INFINITY&&(i=0),rt(this._getComposite(t),(function(t){e.set(t,i)}))}leftSibling(t){const e=this.layers[t.layer],s=t.layerIndex;return 0===s?null:e[s-1]}rightSibling(t){const e=this.layers[t.layer];const s=t.layerIndex;return s===e.length-1?null:e[s+1]}_getComposite(t){return t.isVirtual?this._nodesInLink(t):[t]}arrangeNodes(){let t,e,s,i,n;for(e=0;e<this.layers.length;e++)for(i=this.layers[e],s=0;s<i.length;s++)n=i[s],n.upstreamPriority=n.upstreamLinkCount,n.downstreamPriority=n.downstreamLinkCount;for(let e=0;e<2;e++){for(t=this.layers.length-1;t>=1;t--)this.layoutLayer(!1,t);for(t=0;t<this.layers.length-1;t++)this.layoutLayer(!0,t)}let o=Number.MAX_VALUE;for(e=0;e<this.layers.length;e++)for(i=this.layers[e],s=0;s<i.length;s++)n=i[s],o=Math.min(o,n.gridPosition);if(o<0)for(e=0;e<this.layers.length;e++)for(i=this.layers[e],s=0;s<i.length;s++)n=i[s],n.gridPosition=n.gridPosition-o}layoutLayer(t,e){let s;let i;i=t?this.layers[s=e+1]:this.layers[s=e-1];const n=[];for(let t=0;t<i.length;t++)n.push(i[t]);n.sort((function(t,e){const s=(t.upstreamPriority+t.downstreamPriority)/2;const i=(e.upstreamPriority+e.downstreamPriority)/2;return Math.abs(s-i)<1e-4?0:s<i?1:-1})),rt(n,(function(t){let e=t.gridPosition;const s=this.calcBaryCenter(t);const n=(t.upstreamPriority+t.downstreamPriority)/2;if(!(Math.abs(e-s)<1e-4||Math.abs(e-s)<.2501))if(e<s)for(;e<s&&this.moveRight(t,i,n);)e=t.gridPosition;else for(;e>s&&this.moveLeft(t,i,n);)e=t.gridPosition}),this),s>0&&this.calcDownData(s-1),s<this.layers.length-1&&this.calcUpData(s+1)}moveRight(t,e,s){const i=lt(e,t);if(i===e.length-1)return t.gridPosition=t.gridPosition+.5,!0;const n=e[i+1];const o=(n.upstreamPriority+n.downstreamPriority)/2;return n.gridPosition>t.gridPosition+1?(t.gridPosition=t.gridPosition+.5,!0):!(o>s||Math.abs(o-s)<1e-4)&&(!!this.moveRight(n,e,s)&&(t.gridPosition=t.gridPosition+.5,!0))}moveLeft(t,e,s){const i=lt(e,t);if(0===i)return t.gridPosition=t.gridPosition-.5,!0;const n=e[i-1];const o=(n.upstreamPriority+n.downstreamPriority)/2;return n.gridPosition<t.gridPosition-1?(t.gridPosition=t.gridPosition-.5,!0):!(o>s||Math.abs(o-s)<1e-4)&&(!!this.moveLeft(n,e,s)&&(t.gridPosition=t.gridPosition-.5,!0))}mapVirtualNode(t,e){this.nodeToLinkMap.set(t,e),this.linkToNodeMap.containsKey(e)||this.linkToNodeMap.set(e,[]),this.linkToNodeMap.get(e).push(t)}_nodesInLink(t){return this.linkToNodeMap.get(this.nodeToLinkMap.get(t))}_dummify(){this.linkToNodeMap=new Dt,this.nodeToLinkMap=new Dt;const t=this.graph.links.slice(0);const e=this.layers;let s,i,n,o,r,h,a,c;const l=function(t,s,i){e[t].linksTo[s]=e[t].linksTo[s]||[],e[t].linksTo[s].push(i)};for(c=0;c<t.length;c++){const d=t[c];const u=d.source;const p=d.target;const g=u.layer;const f=p.layer;const m=u.gridPosition;const _=p.gridPosition;const y=(_-m)/Math.abs(f-g);let w=u;if(g-f>1){for(a=g-1;a>f;a--){for(n=new Kt,n.x=u.x,n.y=u.y,n.width=u.width/100,n.height=u.height/100,s=e[a],i=(a-f)*y+m,i>s.length&&(i=s.length),m>=e[g].length-1&&_>=e[f].length-1?i=s.length:0===m&&0===_&&(i=0),n.layer=a,n.uBaryCenter=0,n.dBaryCenter=0,n.upstreamLinkCount=0,n.downstreamLinkCount=0,n.gridPosition=i,n.isVirtual=!0,mt(s,n,i),r=i+1;r<s.length;r++)o=s[r],o.gridPosition=o.gridPosition+1;h=new Yt(w,n),h.depthOfDumminess=0,l(a-1,a,h),w=n,this.graph._addNode(n),this.graph.addLink(h),n.index=this.graph.nodes.length-1,this.mapVirtualNode(n,d)}l(f-1,f,h),d.changeSource(w),d.depthOfDumminess=g-f-1}else if(g-f<-1){for(a=g+1;a<f;a++){for(n=new Kt,n.x=u.x,n.y=u.y,n.width=u.width/100,n.height=u.height/100,s=e[a],i=(a-g)*y+m,i>s.length&&(i=s.length),m>=e[g].length-1&&_>=e[f].length-1?i=s.length:0===m&&0===_&&(i=0),n.layer=a,n.uBaryCenter=0,n.dBaryCenter=0,n.upstreamLinkCount=0,n.downstreamLinkCount=0,n.gridPosition=i,n.isVirtual=!0,i=Math.floor(i),mt(s,n,i),r=i+1;r<s.length;r++)o=s[r],o.gridPosition=o.gridPosition+1;h=new Yt(w,n),h.depthOfDumminess=0,l(a-1,a,h),w=n,this.graph._addNode(n),this.graph.addLink(h),n.index=this.graph.nodes.length-1,this.mapVirtualNode(n,d)}l(f-1,f,d),d.changeSource(w),d.depthOfDumminess=f-g-1}else l(g,f,d)}}_dedummify(){let t=!0;for(;t;){t=!1;for(let e=0;e<this.graph.links.length;e++){const s=this.graph.links[e];if(!s.depthOfDumminess)continue;const i=[];i.unshift({x:s.target.x,y:s.target.y}),i.unshift({x:s.source.x,y:s.source.y});let n=s;const o=s.depthOfDumminess;for(let t=0;t<o;t++){const t=n.source.incoming[0];i.unshift({x:t.source.x,y:t.source.y}),n=t}s.changeSource(n.source),s.depthOfDumminess=0,i.length>2?(i.splice(0,1),i.splice(i.length-1),s.points=i):s.points=[],t=!0;break}}}_optimizeCrossings(){let t,e=-1;let s=0;for(;0!==e&&!(s++>3);){for(e=0,t=this.layers.length-1;t>=1;t--)e+=this.optimizeLayerCrossings(!1,t);for(t=0;t<this.layers.length-1;t++)e+=this.optimizeLayerCrossings(!0,t)}}calcUpData(t){if(0===t)return;const e=this.layers[t];let s,i,n;const o=new se;const r=this.layers[t-1];for(s=0;s<r.length;s++)o.add(r[s]);for(s=0;s<e.length;s++){const t=e[s];let r=0;let h=0;for(i=0;i<t.incoming.length;i++)n=t.incoming[i],o.contains(n.source)&&(h++,r+=n.source.gridPosition);for(i=0;i<t.outgoing.length;i++)n=t.outgoing[i],o.contains(n.target)&&(h++,r+=n.target.gridPosition);h>0?(t.uBaryCenter=r/h,t.upstreamLinkCount=h):(t.uBaryCenter=s,t.upstreamLinkCount=0)}}calcDownData(t){if(t===this.layers.length-1)return;const e=this.layers[t];let s,i,n;const o=new se;const r=this.layers[t+1];for(s=0;s<r.length;s++)o.add(r[s]);for(s=0;s<e.length;s++){const t=e[s];let r=0;let h=0;for(i=0;i<t.incoming.length;i++)n=t.incoming[i],o.contains(n.source)&&(h++,r+=n.source.gridPosition);for(i=0;i<t.outgoing.length;i++)n=t.outgoing[i],o.contains(n.target)&&(h++,r+=n.target.gridPosition);h>0?(t.dBaryCenter=r/h,t.downstreamLinkCount=h):(t.dBaryCenter=s,t.downstreamLinkCount=0)}}optimizeLayerCrossings(t,e){let s;let i;i=t?this.layers[s=e+1]:this.layers[s=e-1];const n=i.slice(0);t?this.calcUpData(s):this.calcDownData(s),i.sort(((t,e)=>{const s=this.calcBaryCenter(t),i=this.calcBaryCenter(e);if(Math.abs(s-i)<1e-4)return t.degree()===e.degree()?this.compareByIndex(t,e):t.degree()<e.degree()?1:-1;const n=1e3*(i-s);return n>0?-1:n<0?1:this.compareByIndex(t,e)}));let o,r=0;for(o=0;o<i.length;o++)i[o]!==n[o]&&r++;if(r>0){let t=0;for(o=0;o<i.length;o++){i[o].gridPosition=t++}}return r}_swapPairs(){const t=this.options.layeredIterations;let e=0;for(;!(e++>t);){const t=e%4<=1;const s=e%4==1;for(let e=t?0:this.layers.length-1;t?e<=this.layers.length-1:e>=0;e+=t?1:-1){const i=this.layers[e];let n=!1;let o=!0;let r=0;for(let h=0;h<i.length-1;h++){let a=0;let c=0;let l=0;if(o?(0!==e&&(a=this.countLinksCrossingBetweenTwoLayers(e-1,e)),e!==this.layers.length-1&&(c=this.countLinksCrossingBetweenTwoLayers(e,e+1)),t?a*=2:c*=2,l=a+c):l=r,0===l)continue;let d=i[h];let u=i[h+1];let p=d.gridPosition;let g=u.gridPosition;i[h]=u,i[h+1]=d,d.gridPosition=g,u.gridPosition=p,a=0,0!==e&&(a=this.countLinksCrossingBetweenTwoLayers(e-1,e)),c=0,e!==this.layers.length-1&&(c=this.countLinksCrossingBetweenTwoLayers(e,e+1)),t?a*=2:c*=2;const f=a+c;let m=!1;m=s?f>=l:f>l,m?(d=i[h],u=i[h+1],p=d.gridPosition,g=u.gridPosition,i[h]=u,i[h+1]=d,d.gridPosition=g,u.gridPosition=p,r=l,o=!1):(n=!0,o=!0)}n&&(e!==this.layers.length-1&&this.calcUpData(e+1),0!==e&&this.calcDownData(e-1))}}}countLinksCrossingBetweenTwoLayers(t,e){const s=this.layers[t].linksTo[e];let i,n,o,r,h,a,c,l;let d=0;const u=s.length;for(c=0;c<u;c++)for(i=s[c],l=c+1;l<u;l++){n=s[l],i.target.layer===e?(o=i.source,r=i.target):(o=i.target,r=i.source),n.target.layer===e?(h=n.source,a=n.target):(h=n.target,a=n.source);const t=o.gridPosition;const c=r.gridPosition;(t-h.gridPosition)*(c-a.gridPosition)<0&&d++}return d}calcBaryCenter(t){const e=t.upstreamLinkCount;const s=t.downstreamLinkCount;const i=t.uBaryCenter;const n=t.dBaryCenter;return e>0&&s>0?(i+n)/2:e>0?i:s>0?n:0}_gridPositionComparer(t,e){return t.gridPosition<e.gridPosition?-1:t.gridPosition>e.gridPosition?1:0}_positionAscendingComparer(t,e){return t.k<e.k?-1:t.k>e.k?1:0}_positionDescendingComparer(t,e){return t.k<e.k?1:t.k>e.k?-1:0}_firstVirtualNode(t){for(let e=0;e<t.length;e++)if(t[e].isVirtual)return e;return-1}compareByIndex(t,e){const s=t.index;const i=e.index;return s<i?1:s>i?-1:0}intDiv(t,e){return(t-t%e)/e}nextVirtualNode(t,e){for(let s=e.layerIndex+1;s<t.length;++s)if(t[s].isVirtual)return t[s];return null}}class Rs{constructor(t){this.center=null,this.options=t}layout(t,e){if(this.graph=t,this.graph.nodes&&0!==this.graph.nodes.length){if(!ct(this.graph.nodes,e))throw new Error("The given root is not in the graph.");this.center=e,this.graph.cacheRelationships(),this.layoutSwitch()}}layoutLeft(t){this.setChildrenDirection(this.center,"Left",!1),this.setChildrenLayout(this.center,"Default",!1);let e,s,i,n=0,o=0;for(s=0;s<t.length;s++){i=t[s],i.TreeDirection="Left";const e=this.measure(i,ie.Empty.bind(this));o=Math.max(o,e.width),n+=e.height+this.options.verticalSeparation}n-=this.options.verticalSeparation;const r=this.center.x-this.options.horizontalSeparation;for(e=this.center.y+(this.center.height-n)/2,s=0;s<t.length;s++){i=t[s];const n=new Ot(r-i.Size.width,e);this.arrange(i,n),e+=i.Size.height+this.options.verticalSeparation}}layoutRight(t){this.setChildrenDirection(this.center,"Right",!1),this.setChildrenLayout(this.center,"Default",!1);let e,s,i,n=0,o=0;for(s=0;s<t.length;s++){i=t[s],i.TreeDirection="Right";const e=this.measure(i,ie.Empty.bind(this));o=Math.max(o,e.width),n+=e.height+this.options.verticalSeparation}n-=this.options.verticalSeparation;const r=this.center.x+this.options.horizontalSeparation+this.center.width;for(e=this.center.y+(this.center.height-n)/2,s=0;s<t.length;s++){i=t[s];const n=new Ot(r,e);this.arrange(i,n),e+=i.Size.height+this.options.verticalSeparation}}layoutUp(t){this.setChildrenDirection(this.center,"Up",!1),this.setChildrenLayout(this.center,"Default",!1);let e,s,i,n=0;for(i=0;i<t.length;i++){s=t[i],s.TreeDirection="Up";n+=this.measure(s,ie.Empty.bind(this)).width+this.options.horizontalSeparation}n-=this.options.horizontalSeparation;let o=this.center.x+this.center.width/2-n/2;for(i=0;i<t.length;i++){s=t[i],e=this.center.y-this.options.verticalSeparation-s.Size.height;const n=new Ot(o,e);this.arrange(s,n),o+=s.Size.width+this.options.horizontalSeparation}}layoutDown(t){let e,s;this.setChildrenDirection(this.center,"Down",!1),this.setChildrenLayout(this.center,"Default",!1);let i=0;for(s=0;s<t.length;s++){e=t[s],e.treeDirection="Down";i+=this.measure(e,ie.Empty.bind(this)).width+this.options.horizontalSeparation}i-=this.options.horizontalSeparation;let n=this.center.x+this.center.width/2-i/2;const o=this.center.y+this.options.verticalSeparation+this.center.height;for(s=0;s<t.length;s++){e=t[s];const i=new Ot(n,o);this.arrange(e,i),n+=e.Size.width+this.options.horizontalSeparation}}layoutRadialTree(){this.setChildrenDirection(this.center,"Radial",!1),this.setChildrenLayout(this.center,"Default",!1),this.previousRoot=null;const t=this.options.startRadialAngle*d;const e=this.options.endRadialAngle*d;if(e<=t)throw new Error("Final angle should not be less than the start angle.");this.maxDepth=0,this.origin=new Ot(this.center.x,this.center.y),this.calculateAngularWidth(this.center,0),this.maxDepth>0&&this.radialLayout(this.center,this.options.radialFirstLevelSeparation,t,e),this.center.Angle=e-t}tipOverTree(t,e){j(e)&&(e=0),this.setChildrenDirection(this.center,"Down",!1),this.setChildrenLayout(this.center,"Default",!1),this.setChildrenLayout(this.center,"Underneath",!1,e);let s,i,n=0;for(i=0;i<t.length;i++){s=t[i],s.TreeDirection="Down";n+=this.measure(s,ie.Empty.bind(this)).width+this.options.horizontalSeparation}n-=this.options.horizontalSeparation,n-=t[t.length-1].width,n+=t[t.length-1].associatedShape.bounds().width;let o=this.center.x+this.center.width/2-n/2;const r=this.center.y+this.options.verticalSeparation+this.center.height;for(i=0;i<t.length;i++){s=t[i];const e=new Ot(o,r);this.arrange(s,e),o+=s.Size.width+this.options.horizontalSeparation}}calculateAngularWidth(t,e){e>this.maxDepth&&(this.maxDepth=e);const s=0===e?0:Math.sqrt(2e6)/e;let i=0;if(t.children.length>0){for(let s=0,n=t.children.length;s<n;s++){const n=t.children[s];i+=this.calculateAngularWidth(n,e+1)}i=Math.max(s,i)}else i=s;return t.sectorAngle=i,i}sortChildren(t){let e,s=0;if(t.parents.length>1)throw new Error("Node is not part of a tree.");const i=t.parents[0];if(i){const e=new Ot(i.x,i.y);const n=new Ot(t.x,t.y);s=this.normalizeAngle(Math.atan2(e.y-n.y,e.x-n.x))}const n=t.children.length;if(0===n)return null;const o=[];const r=[];for(e=0;e<n;++e){const i=t.children[e];const n=new Ot(i.x,i.y);r[e]=e,o[e]=this.normalizeAngle(-s+Math.atan2(n.y-n.y,n.x-n.x))}wt(o,r);const h=[];const a=t.children;for(e=0;e<n;++e)h.push(a[r[e]]);return h}normalizeAngle(t){for(;t>2*Math.PI;)t-=2*Math.PI;for(;t<0;)t+=2*Math.PI;return t}radialLayout(t,e,s,i){const n=i-s;const o=n/2;const r=t.sectorAngle;let h=0;const a=this.sortChildren(t);for(let t=0,i=a.length;t<i;t++){const i=a[t];const c=i;const l=c.sectorAngle/r;i.children.length>0&&this.radialLayout(i,e+this.options.radialSeparation,s+h*n,s+(h+l)*n),this.setPolarLocation(i,e,s+h*n+l*o),c.angle=l*n,h+=l}}setPolarLocation(t,e,s){t.x=this.origin.x+e*Math.cos(s),t.y=this.origin.y+e*Math.sin(s),t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height)}setChildrenDirection(t,e,s){const i=t.treeDirection;this.graph.depthFirstTraversal(t,(t=>{t.treeDirection=e})),s||(t.treeDirection=i)}setChildrenLayout(t,e,s,i){j(i)&&(i=0);const n=t.childrenLayout;i>0?(this.graph.assignLevels(t),this.graph.depthFirstTraversal(t,(t=>{t.level>=i+1&&(t.childrenLayout=e)}))):(this.graph.depthFirstTraversal(t,(t=>{t.childrenLayout=e})),s||(t.childrenLayout=n))}measure(t,e){let s,i=0,n=0;let o=new ie(0,0);if(!t)throw new Error("Node is not defined.");const r=t.associatedShape.bounds();const h=r.width;const a=r.height;if(1!==t.parents.length)throw new Error("Node not in a spanning tree.");const c=t.parents[0];if("Undefined"===t.treeDirection&&(t.treeDirection=c.treeDirection),$(t.children))o=new ie(Math.abs(h)<u?50:h,Math.abs(a)<u?25:a);else if(1===t.children.length){switch(t.treeDirection){case"Radial":s=this.measure(t.children[0],e),i=h+this.options.radialSeparation*Math.cos(t.AngleToParent)+s.width,n=a+Math.abs(this.options.radialSeparation*Math.sin(t.AngleToParent))+s.height;break;case"Left":case"Right":switch(t.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":s=this.measure(t.children[0],e),i=h+s.width+this.options.underneathHorizontalOffset,n=a+this.options.underneathVerticalTopOffset+s.height;break;case"Default":s=this.measure(t.children[0],e),i=h+this.options.horizontalSeparation+s.width,n=Math.max(a,s.height);break;default:throw new Error("Unhandled TreeDirection in the Radial layout measuring.")}break;case"Up":case"Down":switch(t.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":s=this.measure(t.children[0],e),i=Math.max(h,s.width+this.options.underneathHorizontalOffset),n=a+this.options.underneathVerticalTopOffset+s.height;break;case"Default":s=this.measure(t.children[0],e),n=a+this.options.verticalSeparation+s.height,i=Math.max(h,s.width);break;default:throw new Error("Unhandled TreeDirection in the Down layout measuring.")}break;default:throw new Error("Unhandled TreeDirection in the layout measuring.")}o=new ie(i,n)}else{let r,c;switch(t.treeDirection){case"Left":case"Right":switch(t.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(i=h,n=a+this.options.underneathVerticalTopOffset,r=0;r<t.children.length;r++)c=t.children[r],s=this.measure(c,e),i=Math.max(i,s.width+this.options.underneathHorizontalOffset),n+=s.height+this.options.underneathVerticalSeparation;n-=this.options.underneathVerticalSeparation;break;case"Default":for(i=h,n=0,r=0;r<t.children.length;r++)c=t.children[r],s=this.measure(c,e),i=Math.max(i,h+this.options.horizontalSeparation+s.width),n+=s.height+this.options.verticalSeparation;n-=this.options.verticalSeparation;break;default:throw new Error("Unhandled TreeDirection in the Right layout measuring.")}break;case"Up":case"Down":switch(t.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(i=h,n=a+this.options.underneathVerticalTopOffset,r=0;r<t.children.length;r++)c=t.children[r],s=this.measure(c,e),i=Math.max(i,s.width+this.options.underneathHorizontalOffset),n+=s.height+this.options.underneathVerticalSeparation;n-=this.options.underneathVerticalSeparation;break;case"Default":for(i=0,n=0,r=0;r<t.children.length;r++)c=t.children[r],s=this.measure(c,e),i+=s.width+this.options.horizontalSeparation,n=Math.max(n,s.height+this.options.verticalSeparation+a);i-=this.options.horizontalSeparation;break;default:throw new Error("Unhandled TreeDirection in the Down layout measuring.")}break;default:throw new Error("Unhandled TreeDirection in the layout measuring.")}o=new ie(i,n)}return t.SectorAngle=Math.sqrt(i*i/4+n*n/4),t.Size=o,o}arrange(t,e){const s=t.associatedShape.bounds();let i,n,o,r,h;const a=s.width;const c=s.height;if($(t.children))t.x=e.x,t.y=e.y,t.BoundingRectangle=new Nt(e.x,e.y,a,c);else{let s,l;let d;switch(t.treeDirection){case"Left":switch(t.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(d=e,t.x=d.x,t.y=d.y,t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height),l=e.y+c+this.options.underneathVerticalTopOffset,i=0;i<r.children.length;i++)r=r.children[i],s=d.x-r.associatedShape.width-this.options.underneathHorizontalOffset,n=new Ot(s,l),this.arrange(r,n),l+=r.Size.height+this.options.underneathVerticalSeparation;break;case"Default":for(d=new Ot(e.x+t.Size.width-a,e.y+(t.Size.height-c)/2),t.x=d.x,t.y=d.y,t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height),s=d.x-this.options.horizontalSeparation,l=e.y,i=0;i<t.children.length;i++)r=t.children[i],n=new Ot(s-r.Size.width,l),this.arrange(r,n),l+=r.Size.height+this.options.verticalSeparation;break;default:throw new Error("Unsupported TreeDirection")}break;case"Right":switch(t.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(d=e,t.x=d.x,t.y=d.y,t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height),s=e.x+a+this.options.underneathHorizontalOffset,l=e.y+c+this.options.underneathVerticalTopOffset,i=0;i<t.children.length;i++)r=t.children[i],n=new Ot(s,l),this.arrange(r,n),l+=r.Size.height+this.options.underneathVerticalSeparation;break;case"Default":for(d=new Ot(e.x,e.y+(t.Size.height-c)/2),t.x=d.x,t.y=d.y,t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height),s=e.x+a+this.options.horizontalSeparation,l=e.y,i=0;i<t.children.length;i++)r=t.children[i],n=new Ot(s,l),this.arrange(r,n),l+=r.Size.height+this.options.verticalSeparation;break;default:throw new Error("Unsupported TreeDirection")}break;case"Up":if(d=new Ot(e.x+(t.Size.width-a)/2,e.y+t.Size.height-c),t.x=d.x,t.y=d.y,t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height),Math.abs(d.x-e.x)<u){for(h=0,i=0;i<t.children.length;i++)o=t.children[i],h+=o.Size.width+this.options.horizontalSeparation;h-=this.options.horizontalSeparation,s=e.x+(a-h)/2}else s=e.x;for(i=0;i<t.children.length;i++)r=t.children[i],l=d.y-this.options.verticalSeparation-r.Size.height,n=new Ot(s,l),this.arrange(r,n),s+=r.Size.width+this.options.horizontalSeparation;break;case"Down":switch(t.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(d=e,t.x=d.x,t.y=d.y,t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height),s=e.x+this.options.underneathHorizontalOffset,l=e.y+c+this.options.underneathVerticalTopOffset,i=0;i<t.children.length;i++)r=t.children[i],n=new Ot(s,l),this.arrange(r,n),l+=r.Size.height+this.options.underneathVerticalSeparation;break;case"Default":if(d=new Ot(e.x+(t.Size.width-a)/2,e.y),t.x=d.x,t.y=d.y,t.BoundingRectangle=new Nt(t.x,t.y,t.width,t.height),Math.abs(d.x-e.x)<u){for(h=0,i=0;i<t.children.length;i++)o=t.children[i],h+=o.Size.width+this.options.horizontalSeparation;h-=this.options.horizontalSeparation,s=e.x+(a-h)/2}else s=e.x;for(i=0;i<t.children.length;i++)r=t.children[i],l=d.y+this.options.verticalSeparation+c,n=new Ot(s,l),this.arrange(r,n),s+=r.Size.width+this.options.horizontalSeparation;break;default:throw new Error("Unsupported TreeDirection")}break;case"None":break;default:throw new Error("Unsupported TreeDirection")}}}layoutSwitch(){if(!this.center)return;if($(this.center.children))return;let t=this.options.subtype;let e,s,i,n;j(t)&&(t="Down");const o=this.center.children;switch(t.toLowerCase()){case"radial":case"radialtree":this.layoutRadialTree();break;case"mindmaphorizontal":case"mindmap":e=this.center.children,1===this.center.children.length?this.layoutRight(e):(n=o.length/2,s=ut(this.center.children,(function(t){return lt(o,t)<n})),i=ut(this.center.children,(function(t){return lt(o,t)>=n})),this.layoutLeft(s),this.layoutRight(i));break;case"mindmapvertical":e=this.center.children,1===this.center.children.length?this.layoutDown(e):(n=o.length/2,s=ut(this.center.children,(function(t){return lt(o,t)<n})),i=ut(this.center.children,(function(t){return lt(o,t)>=n})),this.layoutUp(s),this.layoutDown(i));break;case"right":this.layoutRight(this.center.children);break;case"left":this.layoutLeft(this.center.children);break;case"up":case"bottom":this.layoutUp(this.center.children);break;case"down":case"top":this.layoutDown(this.center.children);break;case"tipover":case"tipovertree":if(this.options.tipOverTreeStartLevel<0)throw new Error("The tip-over level should be a positive integer.");this.tipOverTree(this.center.children,this.options.tipOverTreeStartLevel)}}}class zs extends Wt{constructor(t){if(super(),j(t))throw new Error("No diagram specified.");this.diagram=t}layout(t){this.transferOptions(t);const e=new Gt(this.diagram);this.graph=e.convert();const s=this.layoutComponents();return new qt(this.diagram,s)}layoutComponents(){if(this.graph.isEmpty())return;const t=this.graph.getConnectedComponents();if($(t))return;const e=new Rs(this.options);const s=[];for(let i=0;i<t.length;i++){const n=t[i];const o=this.getTree(n);if(!o)throw new Error("Failed to find a spanning tree for the component.");const r=o.root;const h=o.tree;e.layout(h,r),s.push(h)}return this.gridLayoutComponents(s)}getTree(t){let e=null;if(this.options.roots&&this.options.roots.length>0)for(let s=0,i=t.nodes.length;s<i;s++){const i=t.nodes[s];for(let t=0;t<this.options.roots.length;t++){if(this.options.roots[t]===i.associatedShape){e=i;break}}}if(!e&&(e=t.root(),!e))throw new Error("Unable to find a root for the tree.");return this.getTreeForRoot(t,e)}getTreeForRoot(t,e){const s=t.getSpanningTree(e);return j(s)||s.isEmpty()?null:{tree:s,root:s.root()}}}class Os{constructor(t,e){this.diagram=t,this.options=Ft({},this.options,e),this.visual=new is,this.diagram._adorners.push(this)}refresh(){}}class Ns{constructor(t,e,s){this.item=t,this._undoSource=e,this._undoTarget=s,this._redoSource=t.source(),this._redoTarget=t.target(),this.title=O}undo(){this.item._updateConnector(this._undoSource,D),this.item._updateConnector(this._undoTarget,R),this.item.updateModel()}redo(){this.item._updateConnector(this._redoSource,D),this.item._updateConnector(this._redoTarget,R),this.item.updateModel()}}function Bs(t){return t.options.name.toLowerCase()===m.toLowerCase()}function As(t,e){let s,i,n=B;for(let o=0;o<e.length;o++)if(i=e[o],!Bs(i)){const e=t.distanceTo(i.position());e<n&&(n=e,s=i)}return s}function Vs(t,e){const s=[];let i,n;const o=t.drawingContainer().children;const r=o.length;for(i=0;i<e.length;i++){n=e[i];for(let t=0;t<r;t++)if(o[t]===n.drawingContainer()){s.push(t);break}}return s}function Hs(t){const e={};return K((t=t||{}).text)&&null!==t.text&&(e.text=t.text),K(t.x)&&null!==t.x&&(e.x=t.x),K(t.y)&&null!==t.y&&(e.y=t.y),K(t.width)&&null!==t.width&&(e.width=t.width),K(t.height)&&null!==t.height&&(e.height=t.height),K(t.type)&&null!==t.type&&(e.type=t.type),e}var Fs;!function(t){t.Terminator="Terminator",t.Process="Process",t.Decision="Decision",t.PredefinedProcess="PredefinedProcess",t.Document="Document",t.MultipleDocuments="MultipleDocuments",t.ManualInputOutput="ManualInputOutput",t.Preparation="Preparation",t.ManualOperation="ManualOperation",t.InternalStorage="InternalStorage",t.Display="Display",t.DirectAccessStorage="DirectAccessStorage",t.Database="Database",t.OnPageConnector="OnPageConnector",t.OffPageConnector="OffPageConnector",t.DataInputOutput="DataInputOutput",t.SummingJunction="SummingJunction",t.LogicalOr="LogicalOr",t.Merge="Merge",t.Extract="Extract",t.DataStorage="DataStorage",t.Delay="Delay",t.Sort="Sort",t.Collate="Collate"}(Fs||(Fs={}));const Us=[{name:"top"},{name:"bottom",position:function(t){const e=t.bounds().height;const s=e*t.shapeVisual.options.waveRatio;const i=t.getPosition("top");return i.y+=e-.4*s,i}},{name:"left"},{name:"right"},{name:"auto"}];const Ws=[{name:"top"},{name:"bottom"},{name:"left",position:function(t){const e=t.getPosition("left");const s=t.bounds();return e.x+=s.width/4-.6*t.shapeVisual.options.cornerRadius*(s.width/s.height),e}},{name:"right",position:function(t){const e=t.getPosition("right");const s=t.bounds();return e.x-=s.width/4-.6*t.shapeVisual.options.cornerRadius*(s.width/s.height),e}},{name:"auto"}];const qs={[Fs.Extract]:Ws,[Fs.Merge]:Ws,[Fs.Document]:Us,[Fs.MultipleDocuments]:Us,[Fs.DataInputOutput]:[{name:"top"},{name:"bottom"},{name:"left",position:function(t){const e=t.getPosition("left");return e.x+=t.bounds().width*t.shapeVisual.options.slantRatio/2-t.shapeVisual.options.cornerRadius/5,e}},{name:"right",position:function(t){const e=t.getPosition("right");return e.x-=t.bounds().width*t.shapeVisual.options.slantRatio/2-t.shapeVisual.options.cornerRadius/5,e}},{name:"auto"}],[Fs.ManualOperation]:[{name:"top"},{name:"bottom"},{name:"left",position:function(t){const e=t.getPosition("left");return e.x+=t.bounds().width*t.shapeVisual.options.baseShrinkRatio/(4+t.shapeVisual.options.cornerRadius/10),e}},{name:"right",position:function(t){const e=t.getPosition("right");return e.x-=t.bounds().width*t.shapeVisual.options.baseShrinkRatio/(4+t.shapeVisual.options.cornerRadius/10),e}},{name:"auto"}],[Fs.ManualInputOutput]:[{name:"top",position:function(t){const e=t.getPosition("top");return e.y+=t.bounds().height*t.shapeVisual.options.topSlantRatio/2,e}},{name:"bottom"},{name:"left"},{name:"right"},{name:"auto"}],[Fs.DataStorage]:[{name:"top"},{name:"bottom"},{name:"left"},{name:"right",position:function(t){const e=t.bounds().width;const s=t.getPosition("right");return s.x-=e*t.shapeVisual.options.ellipseRadiusXRatio,s}},{name:"auto"}]};class Ks{constructor(t,e,s){this.shapes=e,this.undoRotates=s,this.title="Rotation",this.redoRotates=[],this.redoAngle=t._angle,this.adorner=t,this.center=t._innerBounds.center();for(let t=0;t<this.shapes.length;t++)this.redoRotates.push(this.redoAngle)}undo(){let t,e;for(t=0;t<this.shapes.length;t++)e=this.shapes[t],e.rotate(this.undoRotates[t],this.center,!1),"layout"in e&&e.layout(e),e.updateModel();this.adorner&&(this.adorner._initialize(),this.adorner.refresh())}redo(){let t,e;for(t=0;t<this.shapes.length;t++)e=this.shapes[t],e.rotate(this.redoRotates[t],this.center,!1),"layout"in e&&e.layout(e),e.updateModel();this.adorner&&(this.adorner._initialize(),this.adorner.refresh())}}const Ys={width:7,height:7,fill:{color:"Yellow"},hover:{}};class js{constructor(t,e){this.options=Ft({},Ys,e),this.connections=[],this.shape=t}position(){return this.options.position?this.options.position(this.shape):this.shape.getPosition(this.options.name)}toJSON(){return{shapeId:this.shape.toString(),connector:this.options.name}}static parse(t,e){const s=e.split(":"),i=s[0],n=s[1]||m;for(let e=0;e<t.shapes.length;e++){const s=t.shapes[e];if(s.options.id===i)return s.getConnector(n.trim())}}}const Xs=[{name:_},{name:v},{name:w},{name:y},{name:m,position:function(t){return t.getPosition("center")}}];const Gs=function(t){const e={type:"rectangle",path:"",autoSize:!0,visual:null,x:0,y:0,minWidth:20,minHeight:20,width:100,height:100,cornerRadius:0,hover:{},editable:{connect:!0,tools:[]},connectors:Xs,rotation:{angle:0}};return Q(e,t),e};let Js={compile:function(t,e){return t}};class Zs{static register(t){Js=t}static compile(t,e={}){return Js.compile(t,e)}}function $s(t={}){let e;return t.visual?t.visual=e=Zs.compile(t.visual,t):t.template?t.template=e=Zs.compile(t.template,t):Y(t.content)&&(e=t.content),e}function Qs(){const t=function(t){let e=!1;const s={wp:/(Windows Phone(?: OS)?)\s(\d+)\.(\d+(\.\d+)?)/,fire:/(Silk)\/(\d+)\.(\d+(\.\d+)?)/,android:/(Android|Android.*(?:Opera|Firefox).*?\/)\s*(\d+)\.?(\d+(\.\d+)?)?/,iphone:/(iPhone|iPod).*OS\s+(\d+)[._]([\d._]+)/,ipad:/(iPad).*OS\s+(\d+)[._]([\d_]+)/,playbook:/(PlayBook).*?Tablet\s*OS\s*(\d+)\.(\d+(\.\d+)?)/,windows:/(MSIE)\s+(\d+)\.(\d+(\.\d+)?)/,tizen:/(tizen).*?Version\/(\d+)\.(\d+(\.\d+)?)/i,sailfish:/(sailfish).*rv:(\d+)\.(\d+(\.\d+)?).*firefox/i},i={ios:/^i(phone|pad|pod)$/i,android:/^android|fire$/i,windows:/windows/,wp:/wp/,flat:/sailfish|ffos|tizen/i};for(const n in s){if(!Object.prototype.hasOwnProperty.call(s,n))continue;if(t.match(s[n])){if("windows"===n&&"plugins"in navigator)return!1;e={},e.device=n,e.name=ti(n,i),e[e.name]=!0;break}}return e}(navigator.userAgent);const e={};return e.mobileOS=t,e}function ti(t,e,s){for(const s in e)if(e[s].test(t))return s;return void 0!==s?s:t}const ei=Object.assign;const si=()=>(new Date).getTime();const ii=(t,e)=>{t.classList.add(e)};const ni=t=>{const e=document.createElement("div");return e.innerHTML=t,e.firstChild};const oi=(t,e)=>{e.insertBefore(t,e.firstChild)};const ri={hover:{},cursor:g.grip,content:{align:"center middle"},selectable:!0,serializable:!0,enable:!0};class hi extends Tt{constructor(t){super(),this.dataItem=(t||{}).dataItem,this.options=Ft({id:Lt()},ri,t),this.isSelected=!1,this.visual=new is({id:this.options.id,autoSize:this.options.autoSize}),this.id=this.options.id,this._template()}_getCursor(t){return this.adorner?this.adorner._getCursor(t):this.options.cursor}visible(t){if(j(t))return this.visual.visible();this.visual.visible(t)}bounds(t){return j(t),null}refresh(){this.visual.redraw()}position(t){this.options.x=t.x,this.options.y=t.y,this.visual.position(t)}toString(){return this.options.id}serialize(){const t=Ft({},{options:this.options});return this.dataItem&&(t.dataItem=this.dataItem.toString()),t}_content(t){if(void 0!==t){const e=this.options;J(t)?e.content.text=t:Ft(e.content,t);const s=e.content;this._contentVisual?this._updateContentVisual(s):this._createContentVisual(s)}return this.options.content.text}_createContentVisual(t){if(t.text){t.shapeSize=this.bounds();const e="wrap"!==t.textWrap?Es:Is;this._contentVisual=new e(t),this._contentVisual._includeInBBox=!1,this.visual.append(this._contentVisual)}}_updateContentVisual(t){this._contentVisual.redraw(t)}_hitTest(t){const e=this.bounds();return this.visible()&&e.contains(t)&&this.options.enable}_template(){if(this.options.content.template){const t=this.dataItem||{};const e=$s(ei({},this.options.content,{dataItem:this.dataItem||this.options.dataItem}));Y(e)?this.options.content.text=e(t):J(e)&&(this.options.content.text=e)}}_canSelect(){return!1!==this.options.selectable}toJSON(){return{id:this.options.id}}}const ai={Terminator:es,Process:bs,Decision:Fe,PredefinedProcess:ws,Document:Qe,MultipleDocuments:ts,ManualInputOutput:cs,Preparation:xs,ManualOperation:ds,InternalStorage:rs,Display:je,DirectAccessStorage:Ke,Database:Ae,OnPageConnector:ze,OffPageConnector:fs,DataInputOutput:Ne,SummingJunction:Ms,LogicalOr:ps,Merge:us,Extract:ss,DataStorage:He,Delay:We,Sort:Ss,Collate:Re};class ci extends hi{constructor(t,e){super(t),this.name="Shape",this.options=Ft({},this.options,Gs({connectors:void 0}),t),this.diagram=e,this.updateOptionsFromModel(),t=this.options,this.connectors=[],this.type=t.type,this.createShapeVisual(),this.updateBounds(),this.content(this.content()),this._createConnectors()}_setOptionsFromModel(t){const e=Hs(t||this.dataItem);this.options=Ft({},this.options,e),this.redrawVisual()}updateOptionsFromModel(t,e){if(this.diagram&&this.diagram._isEditable){const s=Hs(t||this.dataItem);if(t&&e)if(ct(["x","y","width","height"],e)){const s=this.bounds();s[e]=t[e],this.bounds(s)}else this.options.visual?this._redrawVisual():s.type&&(this.options=Ft({},this.options,s),this._redrawVisual()),this.options.content&&(this._template(),this.content(this.options.content));else this.options=Ft({},this.options,s)}}_redrawVisual(){this.visual.clear(),this._contentVisual=null,this.options.dataItem=this.dataItem,this.createShapeVisual(),this.updateBounds()}redrawVisual(){this._redrawVisual(),this.options.content&&(this._template(),this.content(this.options.content))}updateModel(t){const e=this.diagram;e&&e._isEditable&&e.updateShapeModel(this,t)}updateBounds(){const t=this.visual._measure(!0);const e=this.options;this.bounds(new Nt(e.x,e.y,t.width,t.height)),this._rotate(),this._alignContent()}content(t){const e=this._content(t);return this._alignContent(),e}_alignContent(){const t=this.options.content||{};const e=this._contentVisual;if(e&&t.align&&!1!==e.alignable){const s=this.visual._measure();const i=new Bt(s);const n=e.drawingElement.bbox(null);const o=new Nt(0,0,n.width(),n.height());const r=i.align(o,t.align);e.position(r.topLeft())}}_createConnectors(){const t=this.options,e=t.connectors||qs[t.type]||Xs,s=e.length,i=t.connectorDefaults;let n,o;for(o=0;o<s;o++)n=new js(this,Ft({},i,e[o])),this.connectors.push(n)}bounds(t){let e;if(t)if(J(t))switch(t){case U:e=this._transformedBounds();break;case"absolute":{e=this._transformedBounds();const t=this.diagram._pan;e.x+=t.x,e.y+=t.y;break}case I:e=this._rotatedBounds();break;default:e=this._bounds}else this._setBounds(t),this._triggerBoundsChange(),this.diagram&&this.diagram._layouting||this.refreshConnections();else e=this._bounds;return e}_setBounds(t){const e=this.options;const s=t.topLeft();const i=e.x=s.x;const n=e.y=s.y;const o=e.width=Math.max(t.width,e.minWidth);const r=e.height=Math.max(t.height,e.minHeight);this._bounds=new Nt(i,n,o,r),this.visual.redraw({x:i,y:n,width:o,height:r})}position(t){if(!t)return this._bounds.topLeft();this.bounds(new Nt(t.x,t.y,this._bounds.width,this._bounds.height))}clone(){const t=this.serialize();return t.options.id=Lt(),this.diagram&&this.diagram._isEditable&&K(this.dataItem)&&(t.options.dataItem=this.diagram.options.cloneDataItem(this.dataItem)),new ci(t.options,void 0)}select(t){const e=this.diagram;let s,i;if(j(t)&&(t=!0),this._canSelect()&&this.isSelected!==t)return s=[],i=[],this.isSelected=t,this.isSelected?(e._selectedItems.push(this),s.push(this)):(at(e._selectedItems,this),i.push(this)),e._internalSelection||e._selectionChanged(s,i),!0}rotate(t,e,s){const i=this.visual.rotate();if(void 0!==t){!1!==s&&this.diagram&&this.diagram.undoRedoService&&t!==i.angle&&this.diagram.undoRedoService.add(new Ks(this.diagram._resizingAdorner,[this],[i.angle]),!1);const n=this.bounds(),o=new Ot(n.width/2,n.height/2);let r,h;e&&(r=t-i.angle,h=n.center().rotate(r,e).minus(o),this._rotationOffset=this._rotationOffset.plus(h.minus(n.topLeft())),this.position(h)),this.visual.rotate(t,o),this.options.rotation.angle=t,this.diagram&&this.diagram._connectorsAdorner&&this.diagram._connectorsAdorner.refresh(),this.refreshConnections(),this.diagram&&this.diagram.trigger(S,{item:this})}return i}connections(t){const e=[];let s,i,n,o,r;for(s=0;s<this.connectors.length;s++)for(r=this.connectors[s],o=r.connections,i=0;i<o.length;i++)if(n=o[i],"out"===t){const t=n.source();t.shape&&t.shape===this&&e.push(n)}else if("in"===t){const t=n.target();t.shape&&t.shape===this&&e.push(n)}else e.push(n);return e}refreshConnections(){this.connections().forEach((function(t){t.refresh()}))}getConnector(t){let e,s;if(!J(t))return t instanceof Ot?As(t,this.connectors):this.connectors.length?this.connectors[0]:null;for(t=t.toLocaleLowerCase(),e=0;e<this.connectors.length;e++)if(s=this.connectors[e],s.options.name.toLocaleLowerCase()===t)return s}getPosition(t){const e=this.bounds(),s=t.charAt(0).toLowerCase()+t.slice(1);return Y(e[s])?this._transformPoint(e[s]()):e.center()}redraw(t){if(t){let e=this.options;let s;this.shapeVisual.redraw(this._visualOptions(t)),this._diffNumericOptions(t,[i,n,o,r])&&(this.bounds(new Nt(e.x,e.y,e.width,e.height)),s=!0),t.connectors&&(e.connectors=t.connectors,this._updateConnectors()),e=Ft(e,t),(t.rotation||s)&&this._rotate(),e.content&&this.content(e.content)}}_updateConnectors(){const t=this.connections();let e;let s;let i;this.connectors=[],this._createConnectors();for(let n=0;n<t.length;n++)e=t[n],s=e.source(),i=e.target(),s.shape&&s.shape===this?e.source(this.getConnector(s.options.name)||null):i.shape&&i.shape===this&&e.target(this.getConnector(i.options.name)||null),e.updateModel()}_diffNumericOptions(t,e){return ae.call(this,t,e)}_visualOptions(t){return{cornerRadius:t.cornerRadius,data:t.path,source:t.source,hover:t.hover,fill:t.fill,stroke:t.stroke,dataItem:this.dataItem||(null==t?void 0:t.dataItem)}}_triggerBoundsChange(){this.diagram&&this.diagram.trigger(M,{item:this,bounds:this._bounds.clone()})}_transformPoint(t){const e=this.rotate(),s=this.bounds().topLeft();return e.angle&&t.rotate(e.angle,e.center().plus(s)),t}_transformedBounds(){const t=this.bounds(),e=t.topLeft(),s=t.bottomRight();return Nt.fromPoints(this.diagram.modelToView(e),this.diagram.modelToView(s))}_rotatedBounds(){const t=this.bounds().rotatedBounds(this.rotate().angle),e=t.topLeft(),s=t.bottomRight();return Nt.fromPoints(e,s)}_rotate(){const t=this.options.rotation;t&&t.angle&&this.rotate(t.angle),this._rotationOffset=new Ot}_hover(t){const e=this.options,s=e.hover;let i=e.stroke,n=e.fill;t&&q(s.stroke)&&(i=Ft({},i,s.stroke)),t&&q(s.fill)&&(n=s.fill),this.shapeVisual.redraw({stroke:i,fill:n}),e.editable&&e.editable.connect&&this.diagram._showConnectors(this,t)}_hitTest(t){if(this.visible()){const e=this.bounds(),s=this.rotate().angle;let i;if(t.isEmpty&&!t.isEmpty())return Zt.rects(t,e,s||0);if(i=t.clone().rotate(s,e.center()),e.contains(i))return this}}toJSON(){return{shapeId:this.options.id}}createShapeVisual(){const t=this.options;const e=this._visualOptions(t);const s=t.visual?Zs.compile(t.visual,t):t.visual;const i=(t.type+"").toLocaleLowerCase();let n;e.width=t.width,e.height=t.height,Y(s)?n=s.call(this,t):e.data?(n=new ms(e),function(t){const e=t.drawingContainer().clippedBBox(null);0===e.origin.x&&0===e.origin.y||t.position(-e.origin.x,-e.origin.y)}(n)):n="rectangle"===i?new Le(e):"circle"===i?new ke(e):"text"===i?new Es(e):"image"===i?new ns(e):ai[t.type]?new ai[t.type](e):new ms(e),this.shapeVisual=n,this.visual.append(this.shapeVisual)}}class li extends Os{constructor(t,e){e=Ft({handles:{}},e),super(t.diagram,e),this.connection=t;const s=this.connection.diagram;this._ts=s.toolService;const i=this.connection.sourcePoint();const n=this.connection.targetPoint();this.spVisual=new ke(Ft(this.options.handles,{center:i})),this.epVisual=new ke(Ft(this.options.handles,{center:n})),this.visual.append(this.spVisual),this.visual.append(this.epVisual)}_getCursor(){return g.move}start(t){switch(this.handle=this._hitTest(t),this.startPoint=t,this._initialSource=this.connection.source(),this._initialTarget=this.connection.target(),this.handle){case-1:this.connection.targetConnector&&this._ts._connectionManipulation(this.connection,this.connection.targetConnector.shape);break;case 1:this.connection.sourceConnector&&this._ts._connectionManipulation(this.connection,this.connection.sourceConnector.shape)}}move(t,e){switch(t){case-1:this.connection.source(e);break;case 1:this.connection.target(e);break;default:{const t=e.minus(this.startPoint);this.startPoint=e,this.connection.sourceConnector||this.connection.source(this.connection.sourcePoint().plus(t)),this.connection.targetConnector||this.connection.target(this.connection.targetPoint().plus(t));break}}return this.refresh(),!0}stop(t){const e=this.diagram.toolService,s=e.hoveredItem;let i;return i=e._hoveredConnector?e._hoveredConnector._c:s&&s instanceof ci?s.getConnector(m)||s.getConnector(t):t,-1===this.handle?this.connection.source(i):1===this.handle&&this.connection.target(i),this.handle=void 0,this._ts._connectionManipulation(),new Ns(this.connection,this._initialSource,this._initialTarget)}_hitTest(t){const e=this.connection.sourcePoint();const s=this.connection.targetPoint();const i=this.options.handles.width/2+f;const n=this.options.handles.height/2+f;const o=e.distanceTo(t);const r=s.distanceTo(t);const h=new Nt(e.x,e.y).inflate(i,n).contains(t);const a=new Nt(s.x,s.y).inflate(i,n).contains(t);let c=0;return h&&(!a||o<r)?c=-1:a&&(!h||r<o)&&(c=1),c}refresh(){this.spVisual.redraw({center:this.diagram.modelToLayer(this.connection.sourcePoint())}),this.epVisual.redraw({center:this.diagram.modelToLayer(this.connection.targetPoint())})}}class di{constructor(t){this.options=Ft({},t.options),this._c=t,this.visual=new ke(this.options),this.refresh()}_hover(t){const e=this.options,s=e.hover;let i=e.stroke,n=e.fill;t&&q(s.stroke)&&(i=Ft({},i,s.stroke)),t&&q(s.fill)&&(n=s.fill),this.visual.redraw({stroke:i,fill:n})}refresh(){const t=this._c.shape.diagram.modelToView(this._c.position()),e=t.minus(this._c.shape.bounds("transformed").topLeft()),s=new Nt(t.x,t.y,0,0);s.inflate(this.options.width/2,this.options.height/2),this._visualBounds=s,this.visual.redraw({center:new Ot(e.x,e.y)})}_hitTest(t){const e=this._c.shape.diagram.modelToView(t);return this._visualBounds.contains(e)}}class ui extends Os{constructor(t,e){super(t,e),this._refreshHandler=t=>{t.item===this.shape&&this.refresh()}}show(t){this._visible=!0,this.shape=t,this.diagram.bind(M,this._refreshHandler),this.connectors=[],this._clearVisual();const e=t.connectors.length;for(let s=0;s<e;s++){const e=new di(t.connectors[s]);this.connectors.push(e),this.visual.append(e.visual)}this.visual.visible(!0),this.refresh()}_clearVisual(){this.diagram._cachedTouchTarget?this._keepCachedTouchTarget():this.visual.clear()}_keepCachedTouchTarget(){const t=this.visual.children;const e=t.length;const s=dt(this.diagram._cachedTouchTarget,t);for(let i=e-1;i>=0;i--)i!==s&&this.visual.remove(t[i])}destroy(){this.diagram.unbind(M,this._refreshHandler),this.shape=void 0,this._visible=void 0,this.visual.visible(!1)}_hitTest(t){let e,s;for(s=0;s<this.connectors.length;s++)if(e=this.connectors[s],e._hitTest(t)){e._hover(!0),this.diagram.toolService._hoveredConnector=e;break}}refresh(){if(this.shape){let t=this.shape.bounds();t=this.diagram.modelToLayer(t),this.visual.position(t.topLeft()),this.connectors.forEach((function(t){t.refresh()}))}}}function pi(t){const e=t.options.editable;return e&&!1!==e.drag}class gi{constructor(t,e,s){this.shapes=t,this.undoStates=e,this.title="Transformation",this.redoStates=[],this.adorner=s;for(let t=0;t<this.shapes.length;t++){const e=this.shapes[t];this.redoStates.push(e.bounds())}}undo(){for(let t=0;t<this.shapes.length;t++){const e=this.shapes[t];e.bounds(this.undoStates[t]),"layout"in e&&e.layout(e,this.redoStates[t],this.undoStates[t]),e.updateModel()}this.adorner&&(this.adorner.refreshBounds(),this.adorner.refresh())}redo(){for(let t=0;t<this.shapes.length;t++){const e=this.shapes[t];e.bounds(this.redoStates[t]),"layout"in e&&e.layout(e,this.undoStates[t],this.redoStates[t]),e.updateModel()}this.adorner&&(this.adorner.refreshBounds(),this.adorner.refresh())}}const fi={handles:{fill:{color:"#fff"},stroke:{color:"#282828"},height:7,width:7,hover:{fill:{color:"#282828"},stroke:{color:"#282828"}}},selectable:{stroke:{color:"#778899",width:1,dashType:"dash"},fill:{color:h}},offset:10};class mi extends Os{constructor(t,e){super(t,e=Ft({},fi,e)),this._manipulating=!1,this.map=[],this.shapes=[],this.shapeStates=[],this._initSelection(),this._createHandles(),this.redraw(),this.diagram.bind("select",(()=>{this._initialize()})),this._refreshHandler=()=>{this._internalChange||(this.refreshBounds(),this.refresh())},this._rotatedHandler=()=>{1===this.shapes.length&&(this._angle=this.shapes[0].rotate().angle),this._refreshHandler()},this.diagram.bind(M,this._refreshHandler).bind(S,this._rotatedHandler),this.refreshBounds(),this.refresh()}_initSelection(){const t=this.diagram.options.selectable;const e=Ft({},this.options.selectable,t);this.rect=new Le(e),this.visual.append(this.rect)}_resizable(){return this.options.editable&&!1!==this.options.editable.resize}_handleOptions(){return(this.options.editable.resize||{}).handles||this.options.handles}_createHandles(){let t,e,s,i;if(this._resizable())for(t=this._handleOptions(),i=-1;i<=1;i++)for(s=-1;s<=1;s++)0===i&&0===s||(e=new Le(t),e.drawingElement._hover=this._hover.bind(this),this.map.push({x:i,y:s,visual:e}),this.visual.append(e))}bounds(t){if(!t)return this._bounds;this._innerBounds=t.clone(),this._bounds=this.diagram.modelToLayer(t).inflate(this.options.offset,this.options.offset)}_hitTest(t){const e=this.map.length;let s,i,n,o,r=this.diagram.modelToLayer(t);if(this._angle&&(r=r.clone().rotate(this._angle,this._bounds.center())),this._resizable())for(s=0;s<e;s++)if(o=this.map[s],i=new Ot(o.x,o.y),n=this._getHandleBounds(i),n.offset(this._bounds.x,this._bounds.y),n.contains(r))return i;if(this._bounds.contains(r))return new Ot(0,0)}_getHandleBounds(t){if(this._resizable()){const e=this._handleOptions(),s=e.width,i=e.height,n=new Nt(0,0,s,i);return t.x<0?n.x=-s/2:0===t.x?n.x=Math.floor(this._bounds.width/2)-s/2:t.x>0&&(n.x=this._bounds.width+1-s/2),t.y<0?n.y=-i/2:0===t.y?n.y=Math.floor(this._bounds.height/2)-i/2:t.y>0&&(n.y=this._bounds.height+1-i/2),n}}_getCursor(t){let e=this._hitTest(t);if(e&&e.x>=-1&&e.x<=1&&e.y>=-1&&e.y<=1&&this._resizable()){const t=this._angle;if(t&&(e.rotate(t,new Ot(0,0)),e=new Ot(Math.round(e.x),Math.round(e.y))),-1===e.x&&-1===e.y)return"nw-resize";if(1===e.x&&1===e.y)return"se-resize";if(-1===e.x&&1===e.y)return"sw-resize";if(1===e.x&&-1===e.y)return"ne-resize";if(0===e.x&&-1===e.y)return"n-resize";if(0===e.x&&1===e.y)return"s-resize";if(1===e.x&&0===e.y)return"e-resize";if(-1===e.x&&0===e.y)return"w-resize"}return this._manipulating?g.move:g.select}_initialize(){let t,e;const s=this.diagram.select();for(this.shapes=[],t=0;t<s.length;t++)e=s[t],e instanceof ci&&(this.shapes.push(e),e._rotationOffset=new Ot);this._angle=1===this.shapes.length?this.shapes[0].rotate().angle:0,this._startAngle=this._angle,this._rotates(),this._positions(),this.refreshBounds(),this.refresh(),this.redraw()}_rotates(){let t,e;for(this.initialRotates=[],t=0;t<this.shapes.length;t++)e=this.shapes[t],this.initialRotates.push(e.rotate().angle)}_positions(){let t,e;for(this.initialStates=[],t=0;t<this.shapes.length;t++)e=this.shapes[t],this.initialStates.push(e.bounds())}_hover(t,e){if(this._resizable()){const s=this._handleOptions(),i=s.hover;let n=s.stroke,o=s.fill;t&&q(i.stroke)&&(n=Ft({},n,i.stroke)),t&&q(i.fill)&&(o=i.fill),e.stroke(n.color,n.width,n.opacity),e.fill(o.color,o.opacity)}}start(t){this._sp=t,this._cp=t,this._lp=t,this._manipulating=!0,this._internalChange=!0,this.shapeStates=[];for(let t=0;t<this.shapes.length;t++){const e=this.shapes[t];this.shapeStates.push(e.bounds())}}redraw(){let t,e;const s=this._resizable();for(t=0;t<this.map.length;t++)e=this.map[t],e.visual.visible(s)}angle(t){return K(t)&&(this._angle=t),this._angle}rotate(){const t=this._innerBounds.center();let e=this.angle();this._internalChange=!0;for(let s=0;s<this.shapes.length;s++){const i=this.shapes[s];e=(e+this.initialRotates[s]-this._startAngle)%360,i.rotate(e,t)}this.refresh()}move(t,e){let s,i,n,o,r,h,a,c,l,d,u,p=new Ot,g=new Ot,f=0;if(-2===t.y&&-1===t.x){for(o=this._innerBounds.center(),this._angle=this._truncateAngle(ot(o,e)),h=0;h<this.shapes.length;h++)r=this.shapes[h],a=(this._angle+this.initialRotates[h]-this._startAngle)%360,r.rotate(a,o),Object.prototype.hasOwnProperty.call(r,"layout")&&r.layout(r),this._rotating=!0;this.refresh()}else{if(this.shouldSnap()){const t=this._truncateDistance(e.minus(this._lp));if(0===t.x&&0===t.y)return void(this._cp=e);s=t,this._lp=new Ot(this._lp.x+t.x,this._lp.y+t.y)}else s=e.minus(this._cp);for(this.isDragHandle(t)?(g=p=s,i=!0):(this._angle&&s.rotate(this._angle,new Ot(0,0)),-1===t.x?p.x=s.x:1===t.x&&(g.x=s.x),-1===t.y?p.y=s.y:1===t.y&&(g.y=s.y)),i||(l=function(t,e){let s;return-1===t.x&&-1===t.y?s=e.bottomRight():1===t.x&&1===t.y?s=e.topLeft():-1===t.x&&1===t.y?s=e.topRight():1===t.x&&-1===t.y?s=e.bottomLeft():0===t.x&&-1===t.y?s=e.bottom():0===t.x&&1===t.y?s=e.top():1===t.x&&0===t.y?s=e.left():-1===t.x&&0===t.y&&(s=e.right()),s}(t,this._innerBounds),d=(this._innerBounds.width+s.x*t.x)/this._innerBounds.width,u=(this._innerBounds.height+s.y*t.y)/this._innerBounds.height),h=0;h<this.shapes.length;h++){if(r=this.shapes[h],n=r.bounds(),i){if(!pi(r))continue;c=this._displaceBounds(n,p,g,i)}else{c=n.clone(),c.scale(d,u,l,this._innerBounds.center(),r.rotate().angle);const t=c.center();t.rotate(-this._angle,n.center()),c=new Nt(t.x-c.width/2,t.y-c.height/2,c.width,c.height)}if(c.width>=r.options.minWidth&&c.height>=r.options.minHeight){const t=n;r.bounds(c),Object.prototype.hasOwnProperty.call(r,"layout")&&r.layout(r,t,c),t.width===c.width&&t.height===c.height||r.rotate(r.rotate().angle),f+=1}}f&&(f===h?(c=this._displaceBounds(this._innerBounds,p,g,i),this.bounds(c)):this.refreshBounds(),this.refresh()),this._positions()}this._cp=e}isDragHandle(t){return 0===t.x&&0===t.y}cancel(){const t=this.shapes;const e=this.shapeStates;for(let s=0;s<t.length;s++)t[s].bounds(e[s]);this.refreshBounds(),this.refresh(),this._manipulating=void 0,this._internalChange=void 0,this._rotating=void 0}_truncatePositionToGuides(t){return this.diagram.ruler?this.diagram.ruler.truncatePositionToGuides(t):t}_truncateSizeToGuides(t){return this.diagram.ruler?this.diagram.ruler.truncateSizeToGuides(t):t}_truncateAngle(t){const e=this.snapOptions();const s=Math.max(e.angle||10,5);return e?Math.floor(t%360/s)*s:t%360}_truncateDistance(t){if(t instanceof Ot)return new Ot(this._truncateDistance(t.x),this._truncateDistance(t.y));{const e=this.snapOptions()||{};const s=Math.max(e.size||10,5);return e?Math.floor(t/s)*s:t}}snapOptions(){return((this.diagram.options.editable||{}).drag||{}).snap||{}}shouldSnap(){const t=this.diagram.options.editable;const e=(t||{}).drag;const s=(e||{}).snap;return!1!==t&&!1!==e&&!1!==s}_displaceBounds(t,e,s,i){const n=t.topLeft().plus(e),o=t.bottomRight().plus(s);let r,h=Nt.fromPoints(n,o);return i||(r=h.center(),r.rotate(-this._angle,t.center()),h=new Nt(r.x-h.width/2,r.y-h.height/2,h.width,h.height)),h}stop(){let t,e,s;if(this._cp!==this._sp)if(this._rotating)t=new Ks(this,this.shapes,this.initialRotates),this._rotating=!1;else if(this._diffStates()){if(this.diagram.ruler)for(e=0;e<this.shapes.length;e++){s=this.shapes[e];let t=s.bounds();t=this._truncateSizeToGuides(this._truncatePositionToGuides(t)),s.bounds(t),this.refreshBounds(),this.refresh()}for(e=0;e<this.shapes.length;e++)s=this.shapes[e],s.updateModel();t=new gi(this.shapes,this.shapeStates,this),this.diagram._syncShapeChanges()}return this._manipulating=void 0,this._internalChange=void 0,this._rotating=void 0,t}_diffStates(){const t=this.shapes;const e=this.shapeStates;for(let s=0;s<t.length;s++)if(!t[s].bounds().equals(e[s]))return!0;return!1}refreshBounds(){const t=1===this.shapes.length?this.shapes[0].bounds().clone():this.diagram.boundingBox(this.shapes,!0);this.bounds(t)}refresh(){let t,e;if(this.shapes.length>0){e=this.bounds(),this.visual.visible(!0),this.visual.position(e.topLeft()),this.map.forEach((e=>{t=this._getHandleBounds(new Ot(e.x,e.y)),e.visual.position(t.topLeft())})),this.visual.position(e.topLeft());const s=new Ot(e.width/2,e.height/2);if(this.visual.rotate(this._angle,s),this.rect.redraw({width:e.width,height:e.height}),this.rotationThumb){const t=this.options.editable.rotate.thumb;this._rotationThumbBounds=new Nt(e.center().x,e.y+t.y,0,0).inflate(t.width),this.rotationThumb.redraw({x:e.width/2-t.width/2})}}else this.visual.visible(!1)}}const _i={stroke:{color:"#778899",width:1,dashType:"dash"},fill:{color:h}};class yi{constructor(t){const e=t.options.selectable;this.options=Ft({},_i,e),this.visual=new Le(this.options),this.diagram=t}start(t){this._sp=this._ep=t,this.refresh(),this.diagram._adorn(this,!0)}end(){this._sp=this._ep=void 0,this.diagram._adorn(this,!1)}bounds(t){return t&&(this._bounds=t),this._bounds}move(t){this._ep=t,this.refresh()}refresh(){if(this._sp){const t=Nt.fromPoints(this.diagram.modelToLayer(this._sp),this.diagram.modelToLayer(this._ep));this.bounds(Nt.fromPoints(this._sp,this._ep)),this.visual.position(t.topLeft()),this.visual.redraw({height:t.height+1,width:t.width+1})}}}class wi{constructor(){}}class vi extends wi{constructor(t){super(),this.connection=t}hitTest(t){return!!this.getBounds().inflate(f).contains(t)&&Rt.distanceToPolyline(t,this.connection.allPoints())<f}getBounds(){const t=this.connection.allPoints(),e=t[0],s=t[t.length-1];let i=Math.max(e.x,s.x),n=Math.min(e.x,s.x),o=Math.min(e.y,s.y),r=Math.max(e.y,s.y);for(let e=1;e<t.length-1;++e)i=Math.max(i,t[e].x),n=Math.min(n,t[e].x),o=Math.min(o,t[e].y),r=Math.max(r,t[e].y);return new Nt(n,o,i-n,r-o)}}const xi="topLeft";const bi="bottomRight";class Ci extends vi{constructor(t){super(t),this.SAME_SIDE_DISTANCE_RATIO=5,this._connectorSides=[{name:_,axis:r,boundsPoint:xi,secondarySign:1},{name:w,axis:o,boundsPoint:xi,secondarySign:1},{name:v,axis:r,boundsPoint:bi,secondarySign:-1},{name:y,axis:o,boundsPoint:bi,secondarySign:-1}],this.connection=t}routePoints(t,e,s,i){let n;return n=s&&i?this._connectorPoints(t,e,s,i):this._floatingPoints(t,e,s),n}route(){const t=this.connection._resolvedSourceConnector;const e=this.connection._resolvedTargetConnector;const s=this.connection.sourcePoint();const i=this.connection.targetPoint();const n=this.routePoints(s,i,t,e);this.connection.points(n)}_connectorSide(t,e){const s=t.position();const i=t.shape.bounds(I);const n={topLeft:i.topLeft(),bottomRight:i.bottomRight()};const o=this._connectorSides;let r=Number.MAX_VALUE;let h;let a;let c;let l;for(let t=0;t<o.length;t++)l=o[t],c=l.axis,h=Math.round(Math.abs(s[c]-n[l.boundsPoint][c])),h<r?(r=h,a=l):h===r&&(s[c]-e[c])*l.secondarySign>(s[a.axis]-e[a.axis])*a.secondarySign&&(a=l);return a.name}_sameSideDistance(t){const e=t.shape.bounds(I);return Math.min(e.width,e.height)/this.SAME_SIDE_DISTANCE_RATIO}_connectorPoints(t,e,s,i){const n=this._connectorSide(s,e);const o=this._connectorSide(i,t);const r=e.x-t.x;const h=e.y-t.y;const a=this._sameSideDistance(s);let c=[];let l,d;return n===_||n===v?o===_||o===v?n===o?(d=n===_?Math.min(t.y,e.y)-a:Math.max(t.y,e.y)+a,c=[new Ot(t.x,d),new Ot(e.x,d)]):c=[new Ot(t.x,t.y+h/2),new Ot(e.x,t.y+h/2)]:c=[new Ot(t.x,e.y)]:o===w||o===y?n===o?(l=n===w?Math.min(t.x,e.x)-a:Math.max(t.x,e.x)+a,c=[new Ot(l,t.y),new Ot(l,e.y)]):c=[new Ot(t.x+r/2,t.y),new Ot(t.x+r/2,t.y+h)]:c=[new Ot(e.x,t.y)],c}_floatingPoints(t,e,s){const i=s?this._connectorSide(s,e):null;const n=this._startHorizontal(t,e,i);const o=[t,t,e,e];const r=e.x-t.x;const h=e.y-t.y;const a=o.length;let c=1;let l;let d;for(;c<a-1;++c)n?c%2!=0?(l=r/(a/2),d=0):(l=0,d=h/((a-1)/2)):c%2!=0?(l=0,d=h/(a/2)):(l=r/((a-1)/2),d=0),o[c]=new Ot(o[c-1].x+l,o[c-1].y+d);return c--,o[a-2]=n&&c%2!=0||!n&&c%2==0?new Ot(o[a-1].x,o[a-2].y):new Ot(o[a-2].x,o[a-1].y),[o[1],o[2]]}_startHorizontal(t,e,s){let i;return i=null!==s&&(s===y||s===w)||Math.abs(t.x-e.x)>Math.abs(t.y-e.y),i}}class Si extends vi{constructor(t){super(t),this.connection=t}route(){}}class Mi{constructor(t){this.toolService=t,this.type="ConnectionTool"}tryActivate(t,e){const s=this.toolService,i=s.diagram.options.selectable,n=s.hoveredItem,o=!1!==i&&n&&n.path&&!(n.isSelected&&e.ctrlKey);return o&&(this._c=n),o}start(t,e,s){const i=this.toolService;const n=this._c;i.selectSingle(n,e);const o=n.adorner;let r,h;o&&(r=o._hitTest(t),h=z[r]),pi(n)&&o&&!i.diagram.trigger(x,{shapes:[],connections:[n],connectionHandle:h,point:t,meta:e,nativeEvent:s})?(this.handle=r,this.handleName=h,o.start(t)):(i.startPoint=t,i.end(t,e,s))}move(t,e,s){const i=this._c.adorner;if(pi(this._c)&&i)return i.move(this.handle,t),this.toolService.diagram.trigger(b,{shapes:[],connections:[this._c],connectionHandle:this.handleName,point:t,meta:e,nativeEvent:s}),!0}end(t,e,s){const i=this._c;const n=i.adorner;const o=this.toolService.diagram;if(n&&pi(i)){const r=n.stop(t);o.trigger(C,{shapes:[],connections:[i],connectionHandle:this.handleName,point:t,meta:e,nativeEvent:s})?r.undo():(o.undoRedoService.add(r,!1),i.updateModel(),o._syncConnectionChanges())}}getCursor(){return g.move}}class Ti{constructor(t){this.toolService=t,this.type="ConnectionTool"}tryActivate(){return this.toolService._hoveredConnector}start(t,e,s){const i=this.toolService,n=i.diagram,o=i._hoveredConnector,r=n._createConnection({},o._c,t);pi(r)&&!n.trigger(x,{shapes:[],connections:[r],connectionHandle:R,point:t,meta:e,nativeEvent:s})&&n._addConnection(r)?(i._connectionManipulation(r,o._c.shape,!0),i._removeHover(),i.selectSingle(i.activeConnection,e),"touchmove"===e.type&&(n._cachedTouchTarget=o.visual)):(r.source(null),i.end(t,e,s))}move(t,e,s){const i=this.toolService;const n=i.activeConnection;return n.target(t),i.diagram.trigger(b,{shapes:[],connections:[n],connectionHandle:R,point:t,meta:e,nativeEvent:s}),!0}end(t,e,s){const i=this.toolService,n=i.diagram,o=i.activeConnection,r=i.hoveredItem,h=i._hoveredConnector,a=n._cachedTouchTarget;let c;o&&(c=h&&h._c!==o.sourceConnector?h._c:r&&r instanceof ci?r.getConnector(m)||r.getConnector(t):t,o.target(c),n.trigger(C,{shapes:[],connections:[o],connectionHandle:R,point:t,meta:e,nativeEvent:s})?(n.remove(o,!1),n.undoRedoService.pop()):(o.updateModel(),n._syncConnectionChanges()),i._connectionManipulation(),a&&(n._connectorsAdorner.visual.remove(a),n._cachedTouchTarget=null))}getCursor(){return g.arrow}}class ki{constructor(t){this.toolService=t}start(){}move(){}end(){}tryActivate(){return!1}getCursor(){return g.arrow}}function Ei(t){return!1===t.ctrlKey&&!1===t.altKey&&!1===t.shiftKey}class Pi{constructor(t){this.toolService=t}tryActivate(){return!0}start(t,e,s){const i=this.toolService,n=i.diagram,o=i.hoveredItem;o&&(i.selectSingle(o,e),o.adorner&&(this.adorner=o.adorner,this.handle=this.adorner._hitTest(t))),this.handle||(this.handle=n._resizingAdorner._hitTest(t),this.handle&&(this.adorner=n._resizingAdorner)),this.adorner&&(this.adorner.isDragHandle(this.handle)&&n.trigger(x,{shapes:this.adorner.shapes,connections:[],point:t,nativeEvent:s,meta:e})?(i.startPoint=t,i.end(t,e,s)):this.adorner.start(t))}move(t,e,s){this.adorner&&(this.adorner.move(this.handle,t),this.adorner.isDragHandle(this.handle)&&this.toolService.diagram.trigger(b,{shapes:this.adorner.shapes,connections:[],point:t,meta:e,nativeEvent:s}))}end(t,e,s){const i=this.toolService.diagram,n=this.adorner;let o;n&&(n.isDragHandle(this.handle)&&i.trigger(C,{shapes:n.shapes,connections:[],point:t,meta:e,nativeEvent:s})?n.cancel():(o=n.stop(),o&&i.undoRedoService.add(o,!1))),this.adorner=void 0,this.handle=void 0}getCursor(t){return this.toolService.hoveredItem?this.toolService.hoveredItem._getCursor(t):g.arrow}}const Li={down:"pointerdown",move:"pointermove",up:"pointerup",cancel:"pointercancel pointerleave"};function Ii(t){return Li[t]||t}const Di=t=>t.replace(/([^ ]+)/g,Ii);const Ri=e.w;const zi=function(t,e,s){return"translate3d("+t+"px,"+e+"px,0) scale("+s+")"};class Oi extends Tt{constructor(t,e){super();const s=t[0]||t;this.element=s,this.capture=!1,this._pressHandler=this._press.bind(this),this._releaseHandler=this._release.bind(this),Li.down.split(" ").forEach((t=>{s.addEventListener(t,this._pressHandler,!0)})),Li.up.split(" ").forEach((t=>{s.addEventListener(t,this._releaseHandler,!0)})),this.bind(["press","release"],e||{})}captureNext(){this.capture=!0}cancelCapture(){this.capture=!1}_press(t){this.trigger("press"),this.capture&&t.preventDefault()}_release(t){this.trigger("release"),this.capture&&(t.preventDefault(),this.cancelCapture())}destroy(){const t=this.element;Li.down.split(" ").forEach((e=>{t.removeEventListener(e,this._pressHandler,!0)})),Li.up.split(" ").forEach((e=>{t.removeEventListener(e,this._releaseHandler,!0)}))}}class Ni extends Tt{constructor(t){super(),this.forcedEnabled=!1,ei(this,t),this.scale=1,this.horizontal?(this.measure="offsetWidth",this.scrollSize="scrollWidth",this.axis="x"):(this.measure="offsetHeight",this.scrollSize="scrollHeight",this.axis="y")}makeVirtual(){ei(this,{virtual:!0,forcedEnabled:!0,_virtualMin:0,_virtualMax:0})}virtualSize(t,e){this._virtualMin===t&&this._virtualMax===e||(this._virtualMin=t,this._virtualMax=e,this.update())}outOfBounds(t){return t>this.max||t<this.min}forceEnabled(){this.forcedEnabled=!0}getSize(){return this.container[this.measure]}getTotal(){return this.element[this.scrollSize]}rescale(t){this.scale=t}update(t){const e=this.virtual?this._virtualMax:this.getTotal(),s=e*this.scale,i=this.getSize();(0!==e||this.forcedEnabled)&&(this.max=this.virtual?-this._virtualMin:0,this.size=i,this.total=s,this.min=Math.min(this.max,i-s),this.minScale=i/e,this.centerOffset=(s-i)/2,this.enabled=this.forcedEnabled||s>i,t||this.trigger(p,this))}}class Bi extends Tt{constructor(t){super(),this.x=new Ni(ei({horizontal:!0},t)),this.y=new Ni(ei({horizontal:!1},t)),this.container=t.container,this.forcedMinScale=t.minScale,this.maxScale=t.maxScale||100,this.bind(p,t)}rescale(t){this.x.rescale(t),this.y.rescale(t),this.refresh()}centerCoordinates(){return{x:Math.min(0,-this.x.centerOffset),y:Math.min(0,-this.y.centerOffset)}}refresh(){this.x.update(),this.y.update(),this.enabled=this.x.enabled||this.y.enabled,this.minScale=this.forcedMinScale||Math.min(this.x.minScale,this.y.minScale),this.fitScale=Math.max(this.x.minScale,this.y.minScale),this.trigger(p)}}class Ai extends Tt{constructor(t){super(),ei(this,t)}outOfBounds(){return this.dimension.outOfBounds(this.movable[this.axis])}dragMove(t){const e=this.dimension,s=this.axis,i=this.movable,n=i[s]+t;if(!e.enabled)return;let o=t;(n<e.min&&t<0||n>e.max&&t>0)&&(o*=this.resistance),i.translateAxis(s,o),this.trigger(p,this)}}class Vi{constructor(t){let e,s;ei(this,{elastic:!0},t);const i=this.elastic?.5:0;const n=this.movable;this.x=e=new Ai({axis:"x",dimension:this.dimensions.x,resistance:i,movable:n}),this.y=s=new Ai({axis:"y",dimension:this.dimensions.y,resistance:i,movable:n}),this.userEvents.bind(["press","move","end","gesturestart","gesturechange"],{gesturestart(t){this.gesture=t,this.offset=Ri(this.dimensions.container)},press(t){const e=t.event.target.closest("a");e&&e.matches("[data-navigate-on-press=true]")&&t.sender.cancel()},gesturechange(t){const i=this.gesture,o=i.center,r=t.center,h=this.dimensions.minScale,a=this.dimensions.maxScale;let c=t.distance/i.distance;n.scale<=h&&c<1&&(c+=.8*(1-c)),n.scale*c>=a&&(c=a/n.scale);const l=n.x+this.offset.left,d=n.y+this.offset.top;const u={x:(l-o.x)*c+r.x-l,y:(d-o.y)*c+r.y-d};n.scaleWith(c),e.dragMove(u.x),s.dragMove(u.y),this.dimensions.rescale(n.scale),this.gesture=t,t.preventDefault()},move(t){t.event.target.tagName.match(/textarea|input/i)||(e.dimension.enabled||s.dimension.enabled?(e.dragMove(t.x.delta),s.dragMove(t.y.delta),t.preventDefault()):t.touch.skip())},end(t){t.preventDefault()}})}}class Hi extends Tt{constructor(t){super(),this.element=t,this.element.style.transformOrigin="left top",this.x=0,this.y=0,this.scale=1;const e=zi(this.x,this.y,this.scale);this.element.style.transform=e,this._saveCoordinates(e)}translateAxis(t,e){this[t]+=e,this.refresh()}scaleTo(t){this.scale=t,this.refresh()}scaleWith(t){this.scale*=t,this.refresh()}translate(t){this.x+=t.x,this.y+=t.y,this.refresh()}moveAxis(t,e){this[t]=e,this.refresh()}moveTo(t){ei(this,t),this.refresh()}refresh(){let t=this.x,e=this.y;this.round&&(t=Math.round(t),e=Math.round(e));const s=zi(t,e,this.scale);s!==this.coordinates&&(this.element.style.transform=s,this._saveCoordinates(s),this.trigger(p))}_saveCoordinates(t){this.coordinates=t}}function Fi(t){window.requestAnimationFrame(t)}class Ui{constructor(){this._tickProxy=()=>this._tick(),this._started=!1}tick(){}done(){return!1}onEnd(){}onCancel(){}start(){this.enabled()&&(this.done()?this.onEnd():(this._started=!0,Fi(this._tickProxy)))}enabled(){return!0}cancel(){this._started=!1,this.onCancel()}_tick(){this._started&&(this.tick(),this.done()?(this._started=!1,this.onEnd()):Fi(this._tickProxy))}}class Wi extends Ui{constructor(t){super(),ei(this,t)}done(){return this.timePassed()>=this.duration}timePassed(){return Math.min(this.duration,si()-this.startDate)}moveTo(t){const e=this.movable;this.initial=e[this.axis],this.delta=t.location-this.initial,this.duration="number"==typeof t.duration?t.duration:300,this.tick=this._easeProxy(t.ease),this.startDate=si(),this.start()}_easeProxy(t){return function(){this.movable.moveAxis(this.axis,t(this.timePassed(),this.initial,this.delta,this.duration))}}static easeOutExpo(t,e,s,i){return t===i?e+s:s*(1-Math.pow(2,-10*t/i))+e}}const qi=new WeakMap;const Ki=Symbol("id");function Yi(t,e,s,i,n){!function(t,e,s,i,n){const o=Array.isArray(e)?e:(e||"").split(" ");o.forEach((function(e){!function(t,e,s,i,n){let o=i;let r;s&&Y(s)&&!i?o=s:s&&(h=s,"string"==typeof h)&&Y(o)&&(r=s);var h;const a=function(e){const s=e.target?e.target.closest(r):null;if(!r||r&&e.target&&s){const i=r?s:e.currentTarget;Object.defineProperty(e,"currentTarget",{value:i}),Object.defineProperty(e,"delegateTarget",{value:t}),o(e)}};o[Ki]||(o[Ki]=function(){let t="";let e;let s;for(e=0;e<32;e++)s=Math.floor(16*Math.random()),8!==e&&12!==e&&16!==e&&20!==e||(t+="-"),t+=(12===e?4:16===e?s%4+8:s).toString(16);return t}());let c=qi.get(t);c||(c=new Map,qi.set(t,c));c.set(e+o[Ki],a),t.addEventListener(e,a,Boolean(n))}(t,e,s,i,n)}))}(t,e,s,i,n)}function ji(t,e,s,i){!function(t,e,s,i){const n=Array.isArray(e)?e:(e||"").split(" ");n.forEach((function(e){!function(t,e,s,i){const n=qi.get(t);if(n&&s&&s[Ki]){const o=e+s[Ki];const r=n.get(o);n.delete(o),r&&t.removeEventListener(e,r,Boolean(i))}}(t,e,s,i)}))}(t,e,s,i)}const Xi=t=>{t.preventDefault()};const Gi=()=>{};const Ji="press",Zi="hold",$i="select",Qi="start",tn="move",en="end",sn="cancel",nn="tap",on="doubleTap",rn="release",hn="gesturechange",an="gestureend",cn="gesturetap";const ln={api:0,touch:0,mouse:9,pointer:9};let dn=800,un=0;function pn(t){const e=[],s=t.originalEvent||t,i=t.currentTarget;return t.api?e.push({id:2,event:t,target:t.target,currentTarget:t.target,location:t,type:"api"}):e.push({location:s,event:t,target:t.target,currentTarget:i,id:s.pointerId,type:"pointer"}),e}class gn{constructor(t,e){this.support=Qs(),this.invalidZeroEvents=this.support.mobileOS&&this.support.mobileOS.android,this.axis=t,this._updateLocationData(e),this.startLocation=this.location,this.velocity=this.delta=0,this.timeStamp=si()}move(t){const e=t["page"+this.axis],s=si(),i=s-this.timeStamp||1;!e&&this.invalidZeroEvents||(this.delta=e-this.location,this._updateLocationData(t),this.initialDelta=e-this.startLocation,this.velocity=this.delta/i,this.timeStamp=s)}_updateLocationData(t){const e=this.axis;this.location=t["page"+e],this.client=t["client"+e],this.screen=t["screen"+e]}}class fn{constructor(t,e,s){ei(this,{x:new gn("X",s.location),y:new gn("Y",s.location),type:s.type,threshold:t.threshold||ln[s.type],userEvents:t,target:e,currentTarget:s.currentTarget,initialTouch:s.target,id:s.id,pressEvent:s,_clicks:t._clicks,supportDoubleTap:t.supportDoubleTap,_moved:!1,_finished:!1})}press(){this._holdTimeout=setTimeout((()=>this._hold()),this.userEvents.minHold),this._trigger(Ji,this.pressEvent)}_tap(t){this.userEvents._clicks++,1===this.userEvents._clicks&&(this._clickTimeout=setTimeout((()=>{1===this.userEvents._clicks?this._trigger(nn,t):this._trigger(on,t),this.userEvents._clicks=0}),300))}_hold(){this._trigger(Zi,this.pressEvent)}move(t){const e="api"!==t.type&&this.userEvents._shouldNotMove;if(!this._finished&&!e){if(this.x.move(t.location),this.y.move(t.location),!this._moved){if(this._withinIgnoreThreshold())return;if(_n.current&&_n.current!==this.userEvents)return this.dispose();this._start(t)}this._finished||this._trigger(tn,t)}}end(t){this.endTime=si(),this._finished||(this._finished=!0,this._trigger(rn,t),this._moved?this._trigger(en,t):this.supportDoubleTap?this._tap(t):this._trigger(nn,t),clearTimeout(this._holdTimeout),this.dispose())}dispose(){const t=this.userEvents.touches||[];this._finished=!0,this.pressEvent=null,clearTimeout(this._holdTimeout);const e=t.indexOf(this);t.splice(e,1)}skip(){this.dispose()}cancel(){this.dispose()}isMoved(){return this._moved}_start(t){clearTimeout(this._holdTimeout),this.startTime=si(),this._moved=!0,this._trigger(Qi,t)}_trigger(t,e){const s=e.event;const i={touch:this,x:this.x,y:this.y,target:this.target,event:s};this.userEvents.notify(t,i)&&s.preventDefault()}_withinIgnoreThreshold(){const t=this.x.initialDelta,e=this.y.initialDelta;return Math.sqrt(t*t+e*e)<=this.threshold}}function mn(t){const e=Li.up.split(" "),s=e.length;for(let i=0;i<s;i++)t(e[i])}class _n extends Tt{constructor(t,e){super();const s=Qs();this.support=s,e=e||{},this.options=e;const i=this.filter=e.filter;if(this.threshold=e.threshold||un,this.minHold=e.minHold||dn,this.touches=[],this._maxTouches=e.multiTouch?2:1,this.allowSelection=e.allowSelection,this.captureUpIfMoved=e.captureUpIfMoved,this._clicks=0,this.supportDoubleTap=e.supportDoubleTap,ei(this,{element:t,surface:e.surface||t,stopPropagation:e.stopPropagation,pressed:!1}),this._surfaceMoveHandler=this._move.bind(this),Yi(this.surface,Di("move"),this._surfaceMoveHandler),this._surfaceEndHandler=this._end.bind(this),Yi(this.surface,Di("up cancel"),this._surfaceEndHandler),this._elementStartHandler=this._start.bind(this),Yi(t,Di("down"),i,this._elementStartHandler),t.style["touch-action"]=e.touchAction||"none",e.preventDragEvent&&(this._elementDragStartHandler=Xi,Yi(t,Di("dragstart"),this._elementDragStartHandler)),this._elementSelectHandler=this._select.bind(this),Yi(t,Di("mousedown"),i,this._elementSelectHandler),this.captureUpIfMoved){const t=this.surface;this.preventIfMovingProxy=this.preventIfMoving.bind(this),mn((e=>{t.addEventListener(e,this.preventIfMovingProxy,!0)}))}this.bind([Ji,Zi,nn,on,Qi,tn,en,rn,sn,"gesturestart",hn,an,cn,$i],e)}preventIfMoving(t){this._isMoved()&&t.preventDefault()}destroy(){const t=this.options;const e=this.element;if(!this._destroyed){if(this._destroyed=!0,this.captureUpIfMoved){const t=this.surface;mn((e=>{t.removeEventListener(e,this.preventIfMovingProxy,!0)}))}ji(this.surface,Di("move"),this._surfaceMoveHandler),ji(this.surface,Di("up cancel"),this._surfaceEndHandler),ji(e,Di("down"),this._elementStartHandler),t.preventDragEvent&&ji(e,Di("dragstart"),this._elementDragStartHandler),ji(e,Di("mousedown"),this._elementSelectHandler),this._disposeAll(),this.unbind(),delete this.surface,delete this.element,delete this.currentTarget}}capture(){_n.current=this}cancel(){this._disposeAll(),this.trigger(sn)}notify(t,e){const s=this.touches;let i=t;if(this._isMultiTouch()){switch(i){case tn:i=hn;break;case en:i=an;break;case nn:i=cn}ei(e,{touches:s},function(t,e){const s=t.x.location,i=t.y.location,n=e.x.location,o=e.y.location,r=s-n,h=i-o;return{center:{x:(s+n)/2,y:(i+o)/2},distance:Math.sqrt(r*r+h*h)}}(s[0],s[1]))}return this.trigger(i,ei(e,{type:i}))}press(t,e,s){this._apiCall("_start",t,e,s)}move(t,e){this._apiCall("_move",t,e)}end(t,e){this._apiCall("_end",t,e)}_isMultiTouch(){return this.touches.length>1}_maxTouchesReached(){return this.touches.length>=this._maxTouches}_disposeAll(){const t=this.touches;for(;t.length>0;)t.pop().dispose()}_isMoved(){return function(t,e){const s=t.length;const i=[];for(let n=0;n<s;n++)e(t[n])&&i.push(t[n]);return i}(this.touches,(function(t){return t.isMoved()})).length}_select(t){this.allowSelection&&!this.trigger($i,{event:t})||t.preventDefault()}_start(t){if(t.which&&t.which>1||this._maxTouchesReached())return;let e;_n.current=null,this.currentTarget=t.currentTarget,this.stopPropagation&&t.stopPropagation();const s=pn(t);for(let t=0;t<s.length&&!this._maxTouchesReached();t++){const i=s[t];if(e=this.filter?i.currentTarget:this.element,e&&0===e.length)continue;const n=new fn(this,e,i);this.touches.push(n),n.press(),this._isMultiTouch()&&this.notify("gesturestart",{})}}_move(t){this._eachTouch("move",t)}_end(t){this._eachTouch("end",t)}_eachTouch(t,e){const s={},i=pn(e),n=this.touches;let o,r,h,a;for(o=0;o<n.length;o++)r=n[o],s[r.id]=r;for(o=0;o<i.length;o++)if(h=i[o],a=s[h.id],a){"move"===t&&"pointer"===h.type&&!this.surface.hasPointerCapture(h.id)&&this.surface.setPointerCapture(h.id),a[t](h)}}_apiCall(t,e,s,i){this[t]({api:!0,pageX:e,pageY:s,clientX:e,clientY:s,target:i||this.element,stopPropagation:Gi,preventDefault:Gi})}static defaultThreshold(t){un=t}static minHold(t){dn=t}}const yn=Object.assign,wn=Math.abs,vn="change",xn="scroll";class bn extends Ui{constructor(t){super(),yn(this,t),this.userEvents.bind("gestureend",this.start.bind(this)),this.tapCapture.bind("press",this.cancel.bind(this))}enabled(){return this.movable.scale<this.dimensions.minScale}done(){return this.dimensions.minScale-this.movable.scale<.01}tick(){const t=this.movable;t.scaleWith(1.1),this.dimensions.rescale(t.scale)}onEnd(){const t=this.movable;t.scaleTo(this.dimensions.minScale),this.dimensions.rescale(t.scale)}}class Cn extends Ui{constructor(t){super(),yn(this,t,{transition:new Wi({axis:t.axis,movable:t.movable,onEnd:()=>{this._end()}})}),this.tapCapture.bind("press",(()=>{this.cancel()})),this.userEvents.bind("end",(()=>this.start())),this.userEvents.bind("gestureend",(()=>this.start())),this.userEvents.bind("tap",(()=>this.onEnd()))}onCancel(){this.transition.cancel()}freeze(t){this.cancel(),this._moveTo(t)}onEnd(){this.paneAxis.outOfBounds()?this._snapBack():this._end()}done(){return wn(this.velocity)<1}start(t){let e;this.dimension.enabled&&(this.paneAxis.outOfBounds()?this.transition._started?(this.transition.cancel(),this.velocity=Math.min(t.touch[this.axis].velocity*this.velocityMultiplier,55),super.start()):this._snapBack():(e=t?2===t.touch.id?0:t.touch[this.axis].velocity:0,this.velocity=Math.max(Math.min(e*this.velocityMultiplier,55),-55),this.tapCapture.captureNext(),super.start()))}tick(){const t=this.dimension,e=this.paneAxis.outOfBounds()?.5:this.friction,s=this.velocity*=e;let i=this.movable[this.axis]+s;!this.elastic&&t.outOfBounds(i)&&(i=Math.max(Math.min(i,t.max),t.min),this.velocity=0),this.movable.moveAxis(this.axis,i)}_end(){this.tapCapture.cancelCapture(),this.end()}end(){}_snapBack(){const t=this.dimension,e=this.movable[this.axis]>t.max?t.max:t.min;this._moveTo(e)}_moveTo(t){this.transition.moveTo({location:t,duration:500,ease:(...t)=>{Wi.easeOutExpo.apply(null,t)}})}}class Sn extends Ui{constructor(t){super(),yn(this,t,{origin:{},destination:{},offset:{}})}moveTo(t){}tick(){this._updateCoordinates(),this.moveTo(this.origin)}done(){return wn(this.offset.y)<5&&wn(this.offset.x)<5}onEnd(){this.moveTo(this.destination),this.callback&&this.callback.call()}setCoordinates(t,e){this.offset={},this.origin=t,this.destination=e}setCallback(t){t&&Y(t)?this.callback=t:t=void 0}_updateCoordinates(){this.offset={x:(this.destination.x-this.origin.x)/4,y:(this.destination.y-this.origin.y)/4},this.origin={y:this.origin.y+this.offset.y,x:this.origin.x+this.offset.x}}}class Mn{constructor(t){const e="x"===t.axis;const s=ni('<div class="km-touch-scrollbar km-'+(e?"horizontal":"vertical")+'-scrollbar" />');yn(this,t,{element:s,elementSize:0,movable:new Hi(s),scrollMovable:t.movable,alwaysVisible:t.alwaysVisible,size:e?"width":"height"}),this.scrollMovable.bind(vn,this.refresh.bind(this)),this.container.appendChild(s),t.alwaysVisible&&this.show()}refresh(){const t=this.axis,e=this.dimension,s=e.size,i=this.scrollMovable,n=s/e.total;let o=Math.round(s*n),r=Math.round(-i[t]*n);this.element.style.display=n>=1?"none":"",r+o>s?o=s-r:r<0&&(o+=r,r=0),this.elementSize!==o&&(this.element.style[this.size]=o+"px",this.elementSize=o),this.movable.moveAxis(t,r)}show(){this.element.style.opacity=.7,this.element.style.visibility="visible"}hide(){this.alwaysVisible||(this.element.style.opacity=0)}}const Tn={name:"Scroller",zoom:!1,pullOffset:140,visibleScrollHints:!1,elastic:!0,useNative:!1,mousewheelScrolling:!0,avoidScrolling:()=>!1,pullToRefresh:!1,messages:{pullTemplate:"Pull to refresh",releaseTemplate:"Release to refresh",refreshTemplate:"Refreshing"}};class kn extends Tt{constructor(t,e){super(),this.element=t=t[0]||t,this._initOptions(e),this.events.push("pull",xn,"resize");const s=(()=>{const{mobileOS:t}=Qs();return t.ios||t.android})();this._native=this.options.useNative&&s;const i=ni('<div class="km-scroll-header"/>');if(this._native)return ii(t,"km-native-scroller"),oi(i,t),void yn(this,{scrollElement:t,fixedContainer:t.children[0]});t.style.overflow="hidden",ii(t,"km-scroll-wrapper");((t,e)=>{for(t.appendChild(e);t.firstChild!==e;)e.appendChild(t.firstChild)})(t,ni('<div class="km-scroll-container"/>')),oi(i,t);const n=t.children[1],o=new Oi(t),r=new Hi(n),h=new Bi({element:n,container:t,forcedEnabled:this.options.zoom}),a=this.options.avoidScrolling,c=new _n(t,{touchAction:"none",allowSelection:!0,preventDragEvent:!0,captureUpIfMoved:!0,multiTouch:this.options.zoom,supportDoubleTap:this.options.supportDoubleTap,start:t=>{h.refresh();const e=wn(t.x.velocity),s=wn(t.y.velocity),i=2*e>=s,n=2*s>=e;!this.fixedContainer.contains(t.event.target)&&!a(t)&&this.enabled&&(h.x.enabled&&i||h.y.enabled&&n)?c.capture():c.cancel()}}),l=new Vi({movable:r,dimensions:h,userEvents:c,elastic:this.options.elastic}),d=new bn({movable:r,dimensions:h,userEvents:c,tapCapture:o}),u=new Sn({moveTo:t=>{this.scrollTo(t.x,t.y)}});r.bind(vn,(()=>{this.scrollTop=-r.y,this.scrollLeft=-r.x,this.trigger(xn,{scrollTop:this.scrollTop,scrollLeft:this.scrollLeft})})),this.options.mousewheelScrolling&&(this._wheelScrollHandler=this._wheelScroll.bind(this),Yi(t,"wheel",this._wheelScrollHandler)),yn(this,{movable:r,dimensions:h,zoomSnapBack:d,animatedScroller:u,userEvents:c,pane:l,tapCapture:o,pulled:!1,enabled:!0,scrollElement:n,scrollTop:0,scrollLeft:0,fixedContainer:t.children[0]}),this._initAxis("x"),this._initAxis("y"),this._wheelEnd=()=>{this._wheel=!1,this.userEvents.end(0,this._wheelY)},h.refresh(),this.options.pullToRefresh&&this._initPullToRefresh(),this.bind(this.events,this.options)}_initOptions(t){this.options=Ft({},this.options,Tn,t)}_wheelScroll(t){if(t.ctrlKey)return;this._wheel||(this._wheel=!0,this._wheelY=0,this.userEvents.press(0,this._wheelY)),clearTimeout(this._wheelTimeout),this._wheelTimeout=setTimeout((()=>this._wheelEnd()),50);const e=(t=>{const e=t.wheelDeltaY;let s;return t.wheelDelta?(void 0===e||e)&&(s=t.wheelDelta):t.detail&&t.axis===t.VERTICAL_AXIS&&(s=10*-t.detail),s})(t);e&&(this._wheelY+=e,this.userEvents.move(0,this._wheelY)),t.preventDefault()}makeVirtual(){this.dimensions.y.makeVirtual()}virtualSize(t,e){this.dimensions.y.virtualSize(t,e)}height(){return this.dimensions.y.size}scrollHeight(){return this.scrollElement.scrollHeight}scrollWidth(){return this.scrollElement.scrollWidth}_resize(){this._native||this.contentResized()}setOptions(t){this._initOptions(t),t.pullToRefresh&&this._initPullToRefresh()}reset(){this._native?this.scrollElement.scrollTop(0):(this.movable.moveTo({x:0,y:0}),this._scale(1))}contentResized(){this.dimensions.refresh(),this.pane.x.outOfBounds()&&this.movable.moveAxis("x",this.dimensions.x.min),this.pane.y.outOfBounds()&&this.movable.moveAxis("y",this.dimensions.y.min)}zoomOut(){const t=this.dimensions;t.refresh(),this._scale(t.fitScale),this.movable.moveTo(t.centerCoordinates())}enable(){this.enabled=!0}disable(){this.enabled=!1}scrollTo(t,e){this._native?(this.scrollElement.scrollLeft(wn(t)),this.scrollElement.scrollTop(wn(e))):(this.dimensions.refresh(),this.movable.moveTo({x:t,y:e}))}animatedScrollTo(t,e,s){let i,n;this._native?this.scrollTo(t,e):(i={x:this.movable.x,y:this.movable.y},n={x:t,y:e},this.animatedScroller.setCoordinates(i,n),this.animatedScroller.setCallback(s),this.animatedScroller.start())}pullHandled(){}destroy(){ji(this.element,"wheel",this._wheelScrollHandler),this.userEvents&&this.userEvents.destroy(),this.tapCapture&&this.tapCapture.destroy()}_scale(t){this.dimensions.rescale(t),this.movable.scaleTo(t)}_initPullToRefresh(){}_dragEnd(){}_paneChange(){}_initAxis(t){const e=this.movable,s=this.dimensions[t],i=this.tapCapture,n=this.pane[t],o=new Mn({axis:t,movable:e,dimension:s,container:this.element,alwaysVisible:this.options.visibleScrollHints});s.bind(vn,(()=>{o.refresh()})),n.bind(vn,(()=>{o.show()})),this[t+"inertia"]=new Cn({axis:t,paneAxis:n,movable:e,tapCapture:i,userEvents:this.userEvents,dimension:s,elastic:this.options.elastic,friction:this.options.friction||.96,velocityMultiplier:this.options.velocityMultiplier||10,end:()=>{o.hide(),this.trigger("scrollEnd",{axis:t,scrollTop:this.scrollTop,scrollLeft:this.scrollLeft})}})}}function En(){var t;return/Macintosh|iPhone|iPad/i.test((null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.userAgent)||"")}class Pn extends ki{constructor(t){super(t);const e=this.toolService.diagram,s=e.canvas;const i=e._mobileOS()?.93:.9;const n=e.scroller=this.scroller=new kn(e.scrollable,{friction:i,velocityMultiplier:5,mousewheelScrolling:!1,zoom:!1,scroll:this._move.bind(this)});s.translate&&(this.movableCanvas=new Hi(s.element));const o=function(t,e,s){t.makeVirtual(),t.virtualSize(e||-2e4,s||2e4)};o(n.dimensions.x),o(n.dimensions.y),n.disable()}tryActivate(t,e){const s=this.toolService;const i=s.diagram.options.pannable;const n=e.metaKey&&En();let o=e.ctrlKey||n;return K(i.key)&&(i.key&&"none"!==i.key?(o=e[i.key+"Key"],o=o||"ctrl"===i.key&&n):o=Ei(e)&&!K(s.hoveredItem)),!1!==i&&o&&!K(s.hoveredAdorner)&&!K(s._hoveredConnector)}start(){this.scroller.enable()}move(){}_move(t){const e=this.toolService.diagram,s=e.canvas;let i=new Ot(t.scrollLeft,t.scrollTop);s.translate?(e._storePan(i.times(-1)),this.movableCanvas.moveTo(i),s.translate(i.x,i.y)):i=i.plus(e._pan.times(-1)),e.trigger(L,{pan:i})}end(){this.scroller.disable()}getCursor(){return g.move}}class Ln{constructor(t){this.toolService=t}tryActivate(t,e){const s=this.toolService;const i=s.diagram.options.selectable;let n=i&&!1!==i.multiple;return n&&(n=i.key&&"none"!==i.key?e[i.key+"Key"]:Ei(e)),n&&!K(s.hoveredItem)&&!K(s.hoveredAdorner)}start(t){const e=this.toolService.diagram;e.deselect(),e.selector.start(t)}move(t){this.toolService.diagram.selector.move(t)}end(t,e){const s=this.toolService.diagram,i=this.toolService.hoveredItem;const n=s.selector.bounds();i&&i.isSelected||e.ctrlKey||s.deselect(),n.isEmpty()||s.selectArea(n),s.selector.end()}getCursor(){return g.arrow}}function In(t,e){return e.charCodeAt(0)===t||e.toUpperCase().charCodeAt(0)===t}class Dn{constructor(t,e,s){this.item=t,this._redoSource=e,this._redoTarget=s,K(e)&&(this._undoSource=t.source()),K(s)&&(this._undoTarget=t.target()),this.title=O}undo(){void 0!==this._undoSource&&this.item._updateConnector(this._undoSource,D),void 0!==this._undoTarget&&this.item._updateConnector(this._undoTarget,R),this.item.updateModel()}redo(){void 0!==this._redoSource&&this.item._updateConnector(this._redoSource,D),void 0!==this._redoTarget&&this.item._updateConnector(this._redoTarget,R),this.item.updateModel()}}const Rn={hover:{stroke:{}},startCap:V,endCap:V,points:[],selectable:!0,fromConnector:m,toConnector:m};class zn extends hi{constructor(t,e,s){super(s=Ft({},Rn,s)),this.name="Connection",this.updateOptionsFromModel(),this._initRouter(),this.path=new _s(this.options),this.path.fill(h),this.visual.append(this.path),this._sourcePoint=this._targetPoint=new Ot,this._setSource(t),this._setTarget(e),this.content(this.options.content),this.definers=[],K(s)&&s.points&&this.points(s.points)}_setOptionsFromModel(t){this.updateOptionsFromModel(t||this.dataItem)}updateOptionsFromModel(t){if(this.diagram&&this.diagram._isEditable){const e=this.diagram._dataMap;const s=function(t){const e={};return K((t=t||{}).text)&&null!==t.text&&(e.content=t.text),K(t.type)&&null!==t.type&&(e.type=t.type),K(t.from)&&null!==t.from&&(e.from=t.from),K(t.fromConnector)&&null!==t.fromConnector&&(e.fromConnector=t.fromConnector),K(t.fromX)&&null!==t.fromX&&(e.fromX=t.fromX),K(t.fromY)&&null!==t.fromY&&(e.fromY=t.fromY),K(t.to)&&null!==t.to&&(e.to=t.to),K(t.toConnector)&&null!==t.toConnector&&(e.toConnector=t.toConnector),K(t.toX)&&null!==t.toX&&(e.toX=t.toX),K(t.toY)&&null!==t.toY&&(e.toY=t.toY),e}(t||this.dataItem);if(t){if(K(s.from)){let t=e[s.from];t&&K(s.fromConnector)&&(t=t.getConnector(s.fromConnector)),this.source(t)}else K(s.fromX)&&K(s.fromY)&&this.source(new Ot(s.fromX,s.fromY));if(K(s.to)){let t=e[s.to];t&&K(s.toConnector)&&(t=t.getConnector(s.toConnector)),this.target(t)}else K(s.toX)&&K(s.toY)&&this.target(new Ot(s.toX,s.toY));K(s.type)&&this.type()!==s.type&&(this.points([]),this.type(s.type)),this.dataItem=t,this._template(),this.redraw(this.options)}else this.options=Ft({},s,this.options)}}updateModel(t){this.diagram&&this.diagram._isEditable&&this.diagram.updateConnectionModel(this,t)}sourcePoint(){return this._resolvedSourceConnector?this._resolvedSourceConnector.position():this._sourcePoint}_setSource(t){const e=t instanceof ci;const s=this.options.fromConnector||m;let i;e&&!t.getConnector(s)||(void 0!==t&&(this.from=t),this._removeFromSourceConnector(),null===t?this.sourceConnector&&(this._sourcePoint=(this._resolvedSourceConnector||this.sourceConnector).position(),this._clearSourceConnector(),this._setFromOptions(null,this._sourcePoint)):t instanceof js?(i=t.shape.dataItem,i&&this._setFromOptions(i.id),this.sourceConnector=t,this.sourceConnector.connections.push(this)):t instanceof Ot?(this._setFromOptions(null,t),this._sourcePoint=t,this.sourceConnector&&this._clearSourceConnector()):e&&(i=t.dataItem,i&&this._setFromOptions(i.id),this.sourceConnector=t.getConnector(s),this.sourceConnector.connections.push(this)))}source(t,e){return q(t)&&(e&&this.diagram&&this.diagram.undoRedoService.addCompositeItem(new Dn(this,t)),this._setSource(t),this.refresh()),this.sourceConnector?this.sourceConnector:this._sourcePoint}_setFromOptions(t,e){this.options.from=t,e?(this.options.fromX=e.x,this.options.fromY=e.y):(this.options.fromX=null,this.options.fromY=null)}sourceDefiner(t){if(!t)return this._sourceDefiner||(this._sourceDefiner=new ee(this.sourcePoint(),null,null)),this._sourceDefiner;if(!(t instanceof ee))throw new Error("The sourceDefiner needs to be a PathDefiner.");t.left=null,this._sourceDefiner=t,this.source(t.point)}targetPoint(){return this._resolvedTargetConnector?this._resolvedTargetConnector.position():this._targetPoint}_setTarget(t){const e=t instanceof ci;const s=this.options.toConnector||m;let i;e&&!t.getConnector(s)||(void 0!==t&&(this.to=t),this._removeFromTargetConnector(),null===t?this.targetConnector&&(this._targetPoint=(this._resolvedTargetConnector||this.targetConnector).position(),this._clearTargetConnector(),this._setToOptions(null,this._targetPoint)):t instanceof js?(i=t.shape.dataItem,i&&this._setToOptions(i.id),this.targetConnector=t,this.targetConnector.connections.push(this)):t instanceof Ot?(this._setToOptions(null,t),this._targetPoint=t,this.targetConnector&&this._clearTargetConnector()):e&&(i=t.dataItem,i&&this._setToOptions(i.id),this.targetConnector=t.getConnector(s),this.targetConnector.connections.push(this)))}target(t,e){return q(t)&&(e&&this.diagram&&this.diagram.undoRedoService.addCompositeItem(new Dn(this,void 0,t)),this._setTarget(t),this.refresh()),this.targetConnector?this.targetConnector:this._targetPoint}_setToOptions(t,e){this.options.to=t,e?(this.options.toX=e.x,this.options.toY=e.y):(this.options.toX=null,this.options.toY=null)}targetDefiner(t){if(!t)return this._targetDefiner||(this._targetDefiner=new ee(this.targetPoint(),null,null)),this._targetDefiner;if(!(t instanceof ee))throw new Error("The sourceDefiner needs to be a PathDefiner.");t.right=null,this._targetDefiner=t,this.target(t.point)}_updateConnectors(){this._updateConnector(this.source(),"source"),this._updateConnector(this.target(),"target")}_updateConnector(t,e){const s=this.diagram;if(t instanceof js&&!s.getShapeById(t.shape.id)){const i=t.shape.dataItem;const n=t.options.name;const o=()=>{const o=s._dataMap[i.id];t=o.getConnector(n),this[e](t,!1),this.updateModel()};if(s._dataMap[i.id])o();else{const t=s._inactiveShapeItems.getByUid(i.uid);t&&s._deferredConnectionUpdates.push(t.onActivate(o))}}else this[e](t,!1)}content(t){const e=this.options.content.text;const s=this._content(t);return K(t)&&(e!==s&&(this._contentVisual._measured=!1),this._alignContent()),s}_createContentVisual(t){let e;const s=t.visual;const i=t.template;const n=ei({},t,{dataItem:this.dataItem||t.dataItem});const o=$s(n);if(s){e=Y(o)?o.call(this,n):null}else if(i){const t=Y(o)?o.call(this,n.dataItem):null;Y(t)?e=t:J(t)&&(e=new Es(ei({},n,{text:t})))}else t.text&&(e=new Es(n));return e&&(this._contentVisual=e,e._includeInBBox=!1,this.visual.append(e)),e}_updateContentVisual(t){Y(t.visual)?(this.visual.remove(this._contentVisual),this._createContentVisual(t)):this._contentVisual.redraw(t)}_alignContent(){if(this._contentVisual){let t=5;const s=this.allPoints();let i=Math.floor(s.length/2);let n=i-1;for(;n>0&&s[n].equals(s[i]);)n--,i++;let o=s[i];let r=s[n];const h=this._contentVisual._measure();const a=h.width;const c=h.height;let l=s.length%2==0;const d=r.distanceTo(o);let u;if(l&&s.length>2&&d>0&&(r.y===o.y&&d<a||r.x===o.x&&d<c)&&(l=!1,t=0),l){const s=e.q(Math.atan2(o.y-r.y,o.x-r.x));u=new Ot((o.x-r.x)/2+r.x,(o.y-r.y)/2+r.y),90===Math.abs(s)?(u.x+=t,u.y-=c/2):s%180==0?(u.x-=a/2,u.y-=c+t):s<-90||0<s&&s<90?u.y-=c:(s<0||s>90)&&(u.x-=a,u.y-=c)}else{const e=Math.floor(s.length/2);u=s[e].clone(),r=s[e-1],o=s[e+1];const i=r.x<=u.x&&o.x<=u.x?t:-h.width-t;const n=r.y<=u.y&&o.y<=u.y?t:-h.height-t;u.x+=i,u.y+=n}this._contentVisual.position(u)}}select(t){const e=this.diagram;let s,i;if(this._canSelect()&&this.isSelected!==t)return this.isSelected=t,s=[],i=[],this.isSelected?(this.adorner=new li(this,this.options.selection),e._adorn(this.adorner,!0),e._selectedItems.push(this),s.push(this)):this.adorner&&(e._adorn(this.adorner,!1),at(e._selectedItems,this),this.adorner=void 0,i.push(this)),this.adorner&&this.adorner.refresh(),e._internalSelection||e._selectionChanged(s,i),!0}bounds(t){if(!t||J(t))return this._bounds;this._bounds=t}type(t){const e=this.options;if(!t)return e.type;t!==e.type&&(e.type=t,this._initRouter(),this.refresh())}_initRouter(){const t=(this.options.type||"").toLowerCase();this._router=t===N?new Ci(this):new Si(this)}points(t){if(!t){const t=[];if(q(this.definers))for(let e=0;e<this.definers.length;e++)t.push(this.definers[e].point);return t}this.definers=[];for(let e=0;e<t.length;e++){const s=t[e];if(s instanceof Ot)this.definers.push(new ee(s));else{if(!Object.prototype.hasOwnProperty.call(s,"x")||!Object.prototype.hasOwnProperty.call(s,"y"))throw new Error("A Connection point needs to be a Point or an object with x and y properties.");this.definers.push(new ee(new Ot(s.x,s.y)))}}}allPoints(){const t=[this.sourcePoint()];if(this.definers)for(let e=0;e<this.definers.length;e++)t.push(this.definers[e].point);return t.push(this.targetPoint()),t}refresh(){this._resolveConnectors(),this._refreshPath(),this._alignContent(),this.adorner&&this.adorner.refresh()}_resolveConnectors(){let t,e,s,i;const n=this.source(),o=this.target();n instanceof Ot?t=n:n instanceof js&&(s=Bs(n)?n.shape.connectors:[n]),o instanceof Ot?e=o:o instanceof js&&(i=Bs(o)?o.shape.connectors:[o]),t?i&&(this._resolvedTargetConnector=As(t,i)):s&&(e?this._resolvedSourceConnector=As(e,s):i&&this._resolveAutoConnectors(s,i))}_resolveAutoConnectors(t,e){let s=B;let i=B;let n,o;let r,h;let a,c;let l,d;let u,p;let g;for(u=0;u<t.length;u++)if(l=t[u],!Bs(l))for(r=l.position(),p=0;p<e.length;p++)d=e[p],Bs(d)||(h=d.position(),g=Math.round(r.distanceTo(h)),g<s&&this.diagram&&this._testRoutePoints(r,h,l,d)&&(s=g,n=l,o=d),g<i&&(a=l,c=d,i=g));n&&(a=n,c=o),this._resolvedSourceConnector=a,this._resolvedTargetConnector=c}_testRoutePoints(t,e,s,i){const n=this._router;let o=!0;if(n instanceof Ci){const r=n.routePoints(t,e,s,i),h=this._getRouteExclude(t,e,s.shape,i.shape);let a,c,l;r.unshift(t),r.push(e);for(let t=1;t<r.length;t++)if(a=r[t-1],c=r[t],l=new Nt(Math.min(a.x,c.x),Math.min(a.y,c.y),Math.abs(a.x-c.x),Math.abs(a.y-c.y)),l.width>0&&(l.x++,l.width-=2),l.height>0&&(l.y++,l.height-=2),!l.isEmpty()&&this.diagram._shapesQuadTree.hitTestRect(l,h)){o=!1;break}}return o}_getRouteExclude(t,e,s,i){const n=[];return this._isPointInsideShape(t,s)&&n.push(s),this._isPointInsideShape(e,i)&&n.push(i),n}_isPointInsideShape(t,e){const s=e.bounds(),i=e.rotate().angle,n=s.x,o=s.y;const r=t.clone().rotate(i,s.center());const h=r.x;const a=r.y;return h>n&&h<n+s.width&&a>o&&a<o+s.height}redraw(t){if(t){this.options=Ft({},this.options,t);const e=this.options.points;K(e)&&e.length>0&&(this.points(e),this._refreshPath()),(t&&t.content||t.text)&&this.content(t.content),this.path.redraw({fill:t.fill,stroke:t.stroke,startCap:t.startCap,endCap:t.endCap})}}clone(){const t=this.serialize();return this.diagram&&this.diagram._isEditable&&K(this.dataItem)&&(t.options.dataItem=this.diagram.options.cloneDataItem(this.dataItem)),new zn(this.from,this.to,t.options)}serialize(){const t=this.from.toJSON?this.from.toJSON:this.from.toString(),e=this.to.toJSON?this.to.toJSON:this.to.toString();const s=Ft({},{options:this.options,from:t,to:e});return K(this.dataItem)&&(s.dataItem=this.dataItem.toString()),s.options.points=this.points(),s}_hitTest(t){if(this.visible()){const e=new Ot(t.x,t.y),s=this.sourcePoint(),i=this.targetPoint();if(t.isEmpty&&!t.isEmpty()&&t.contains(s)&&t.contains(i))return this;if(this._router.hitTest(e))return this}}_hover(t){let e=(this.options.stroke||{}).color;t&&q(this.options.hover.stroke.color)&&(e=this.options.hover.stroke.color),this.path.redraw({stroke:{color:e}})}_refreshPath(){K(this.path)&&(this._drawPath(),this.bounds(this._router.getBounds()))}_drawPath(){this._router&&this._router.route();const t=this.sourcePoint();const e=this.targetPoint();const s=this.points();this.path.redraw({points:[t].concat(s,[e])})}_clearSourceConnector(){this.sourceConnector=void 0,this._resolvedSourceConnector=void 0}_clearTargetConnector(){this.targetConnector=void 0,this._resolvedTargetConnector=void 0}_removeFromSourceConnector(){this.sourceConnector&&at(this.sourceConnector.connections,this)}_removeFromTargetConnector(){this.targetConnector&&at(this.targetConnector.connections,this)}toJSON(){let t,e,s;return this.from&&this.from.toJSON?t=this.from.toJSON():(s=this._sourcePoint,t={x:s.x,y:s.y}),this.to&&this.to.toJSON?e=this.to.toJSON():(s=this._targetPoint,e={x:s.x,y:s.y}),{from:t,to:e}}}const On=e.r;class Nn{constructor(t){this.diagram=t,this.tools=[new Pn(this),new Mi(this),new Ti(this),new Ln(this),new Pi(this)],this.activeTool=void 0}start(t,e,s){return e=Ft({},e),this.activeTool&&this.activeTool.end(t,e),this._updateHoveredItem(t,e,s),this._activateTool(t,e),this.activeTool.start(t,e,s),this._updateCursor(t),this.diagram.focus(),this.diagram.canvas.surface.suspendTracking(),this.startPoint=t,!0}move(t,e,s){e=Ft({},e);let i=!0;return this.activeTool&&(i=this.activeTool.move(t,e,s)),i&&this._updateHoveredItem(t,e,s),this._updateCursor(t),!0}end(t,e,s){return e=Ft({},e),this.activeTool&&this.activeTool.end(t,e,s),this.diagram.canvas.surface.resumeTracking(),this.activeTool=void 0,this._updateCursor(t),!0}keyDown(t,e){const s=this.diagram;if(!(e=Ft({ctrlKey:!1,metaKey:!1,altKey:!1},e)).ctrlKey&&!e.metaKey||e.altKey){if(46===t||8===t){const t=this.diagram._triggerRemove(s.select());return t.length&&(this.diagram.remove(t,!0),this.diagram._syncChanges(),this.diagram._destroyToolBar()),!0}if(27===t)return this._discardNewConnection(),s.deselect(),s._destroyToolBar(),!0}else{if(In(t,"a"))return s.selectAll(),s._destroyToolBar(),!0;if(In(t,"z"))return s.undo(),s._destroyToolBar(),!0;if(In(t,"y"))return s.redo(),s._destroyToolBar(),!0;In(t,"c")?(s.copy(),s._destroyToolBar()):In(t,"x")?(s.cut(),s._destroyToolBar()):In(t,"v")?(s.paste(),s._destroyToolBar()):In(t,"l")?(s.layout(),s._destroyToolBar()):In(t,"d")&&(s._destroyToolBar(),s.copy(),s.paste())}}wheel(t,e,s){const i=this.diagram;let n=i.zoom();const o=e.delta,r=i.options,h=r.zoomRate,a={point:t,meta:e,zoom:n,nativeEvent:s};if(!i.trigger(E,a))return o<0?n+=h:n-=h,n=On(Math.max(r.zoomMin,Math.min(r.zoomMax,n)),2),a.zoom=n,i.zoom(n,a),i.trigger(P,a),!0}setTool(t,e){t.toolService=this,this.tools[e]=t}selectSingle(t,e){const s=this.diagram;const i=s.options.selectable;if(i&&!t.isSelected&&!1!==t.options.selectable){const n=e.ctrlKey&&!1!==i.multiple;s.select(t,{addToSelection:n})}}_discardNewConnection(){this.newConnection&&(this.diagram.remove(this.newConnection),this.newConnection=void 0)}_activateTool(t,e){for(let s=0;s<this.tools.length;s++){const i=this.tools[s];if(i.tryActivate(t,e)){this.activeTool=i;break}}}_updateCursor(t){const e=this.diagram.element;const s=this.activeTool?this.activeTool.getCursor(t):this.hoveredAdorner?this.hoveredAdorner._getCursor(t):this.hoveredItem?this.hoveredItem._getCursor(t):g.arrow;e.style.cursor=s}_connectionManipulation(t,e,s){this.activeConnection=t,this.disabledShape=e,this.newConnection=s?this.activeConnection:void 0}_updateHoveredItem(t,e,s){const i=this._hitTest(t);const n=this.diagram;i===this.hoveredItem||this.disabledShape&&i===this.disabledShape||(this.hoveredItem&&(n.trigger(k,{item:this.hoveredItem,nativeEvent:s,point:t,meta:e}),this.hoveredItem._hover(!1)),i&&i.options.enable?(n.trigger(T,{item:i,nativeEvent:s,point:t,meta:e}),this.hoveredItem=i,this.hoveredItem._hover(!0)):this.hoveredItem=void 0)}_removeHover(){this.hoveredItem&&(this.hoveredItem._hover(!1),this.hoveredItem=void 0)}_hitTest(t){const e=this.diagram;let s,i,n;if(this._hoveredConnector&&(this._hoveredConnector._hover(!1),this._hoveredConnector=void 0),e._connectorsAdorner._visible&&(s=e._connectorsAdorner._hitTest(t),s))return s;if(s=this.diagram._resizingAdorner._hitTest(t),s){if(this.hoveredAdorner=e._resizingAdorner,0!==s.x||0!==s.y)return;s=void 0}else this.hoveredAdorner=void 0;if(!this.activeTool||"ConnectionTool"!==this.activeTool.type){const o=[];for(n=0;n<e._selectedItems.length;n++)i=e._selectedItems[n],i instanceof zn&&o.push(i);s=this._hitTestItems(o,t)}return s||this._hitTestElements(t)}_hitTestElements(t){const e=this.diagram;const s=this._hitTestItems(e.shapes,t);const i=this._hitTestItems(e.connections,t);let n;if((!this.activeTool||"ConnectionTool"!==this.activeTool.type)&&s&&i&&!function(t,e){let s,i,n;for(let o=0;o<t.connectors.length;o++)if(s=t.connectors[o],i=s.position(),n=new Nt(i.x,i.y),n.inflate(f,f),n.contains(e))return s}(s,t)){const t=e.mainLayer;n=dt(s.visual,t.children)>dt(i.visual,t.children)?s:i}return n||s||i}_hitTestItems(t,e){let s,i,n;for(s=t.length-1;s>=0;s--)if(i=t[s],n=i._hitTest(e),n)return n}}class Bn{constructor(t,e){this.connection=t,this.diagram=e,this.title="New connection"}undo(){this.diagram.remove(this.connection,!1)}redo(){this.diagram._addConnection(this.connection,!1)}}class An{constructor(t,e){this.shape=t,this.diagram=e,this.title="New shape"}undo(){this.diagram.deselect(),this.diagram.remove(this.shape,!1)}redo(){this.diagram._addShape(this.shape,!1)}}class Vn{constructor(t){this.units=[],this.title="Composite unit",void 0!==t&&this.units.push(t)}add(t){this.units.push(t)}undo(){for(let t=0;t<this.units.length;t++)this.units[t].undo()}redo(){for(let t=0;t<this.units.length;t++)this.units[t].redo()}}class Hn{constructor(t){this.connection=t,this.diagram=t.diagram,this.targetConnector=t.targetConnector,this.title="Delete connection"}undo(){this.diagram._addConnection(this.connection,!1)}redo(){this.diagram.remove(this.connection,!1)}}class Fn{constructor(t){this.shape=t,this.diagram=t.diagram,this.title="Deletion"}undo(){this.diagram._addShape(this.shape,!1),this.shape.select(!1)}redo(){this.shape.select(!1),this.diagram.remove(this.shape,!1)}}class Un{constructor(t){this.layoutState=t,this.diagram=t.diagram}initState(){this.froms=[],this.tos=[],this.subjects=[];this.layoutState.nodeMap.forEach(((t,e)=>{const s=this.diagram.getShapeById(t);s&&(this.subjects.push(s),this.froms.push(s.bounds().topLeft()),this.tos.push(e.topLeft()))}),this)}update(t){if(!(this.subjects.length<=0))for(let e=0;e<this.subjects.length;e++)this.subjects[e].position(new Ot(this.froms[e].x+(this.tos[e].x-this.froms[e].x)*t,this.froms[e].y+(this.tos[e].y-this.froms[e].y)*t))}}class Wn{constructor(t,e,s){j(s)?this.animate=!1:this.animate=Boolean(s),this._initialState=t,this._finalState=e,this.title="Diagram layout"}undo(){this.setState(this._initialState)}redo(){this.setState(this._finalState)}setState(t){const e=t.diagram;if(this.animate){t.linkMap.forEach((function(t,s){const i=e.getShapeById(t);i.visible(!1),i&&i.points(s)}));const s=new Pt;s.addAdapter(new Un(t)),s.onComplete((function(){t.linkMap.forEach((function(t){e.getShapeById(t).visible(!0)}))})),s.play()}else t.nodeMap.forEach((function(t,s){const i=e.getShapeById(t);i&&i.position(s.topLeft())})),t.linkMap.forEach((function(t,s){const i=e.getShapeById(t);i&&i.points(s)}))}}class qn{constructor(t,e,s){this.diagram=t,this.indices=s,this.items=e,this.title="Rotate Unit"}undo(){this.diagram._toIndex(this.items,this.indices)}redo(){this.diagram.toBack(this.items,!1)}}class Kn{constructor(t,e,s){this.diagram=t,this.indices=s,this.items=e,this.title="Rotate Unit"}undo(){this.diagram._toIndex(this.items,this.indices)}redo(){this.diagram.toFront(this.items,!1)}}class Yn extends Tt{constructor(t={}){super(),this.events=["undone","redone"],this.bind(this.events,t),this.stack=[],this.index=0,this.capacity=100}begin(){this.composite=new Vn}cancel(){this.composite=void 0}commit(t){this.composite.units.length>0&&this._restart(this.composite,t),this.composite=void 0}addCompositeItem(t){this.composite?this.composite.add(t):this.add(t)}add(t,e){this._restart(t,e)}pop(){this.index>0&&(this.stack.pop(),this.index--)}count(){return this.stack.length}undo(){this.index>0&&!this.trigger("undo",{unit:this.stack[this.index-1]})&&(this.index--,this.stack[this.index].undo(),this.trigger("undone"))}redo(){this.stack.length>0&&this.index<this.stack.length&&!this.trigger("redo",{unit:this.stack[this.index]})&&(this.stack[this.index].redo(),this.index++,this.trigger("redone"))}_restart(t,e){this.stack.splice(this.index,this.stack.length-this.index),this.stack.push(t),!1!==e?this.redo():this.index++,this.stack.length>this.capacity&&(this.stack.splice(0,this.stack.length-this.capacity),this.index=this.capacity)}clear(){this.stack=[],this.index=0}}class jn{constructor(t){this.dataItem=t,this.callbacks=[]}onActivate(t){return new Promise((e=>{this.callbacks.push({callback:t,resolve:e})}))}activate(){const t=this.callbacks;let e;for(let s=0;s<t.length;s++)e=this.callbacks[s],e.callback(this.dataItem),e.resolve();this.callbacks=[]}}class Xn{constructor(){this.items={}}add(t){for(let e=0;e<t.length;e++)this.items[t[e].uid]=new jn(t[e])}forEach(t){for(const e in this.items)Object.prototype.hasOwnProperty.call(this.items,e)&&t(this.items[e])}getByUid(t){return this.items[t]}remove(t){delete this.items[t.uid]}destroy(){this.items={}}}class Gn{constructor(){this.shapes=[]}_add(t,e){this.shapes.push({bounds:e,shape:t}),t._quadNode=this}insert(t,e){this._add(t,e)}remove(t){const e=this.shapes;const s=e.length;for(let i=0;i<s;i++)if(e[i].shape===t){e.splice(i,1);break}}hitTestRect(t,e){const s=this.shapes;const i=s.length;for(let n=0;n<i;n++)if(this._testRect(s[n].shape,t)&&!ct(e,s[n].shape))return!0}_testRect(t,e){const s=t.rotate().angle;const i=t.bounds();let n;return n=s?Zt.rects(e,i,-s):i.overlaps(e),n}}class Jn extends Gn{constructor(t){super(),this.children=[],this.rect=t}inBounds(t){const e=this.rect;const s=e.bottomRight();const i=t.bottomRight();return e.x<=t.x&&e.y<=t.y&&i.x<=s.x&&i.y<=s.y}overlapsBounds(t){return this.rect.overlaps(t)}insert(t,e){let s=!1;const i=this.children;const n=i.length;if(this.inBounds(e)){if(!n&&this.shapes.length<4)this._add(t,e);else{n||this._initChildren();for(let n=0;n<i.length;n++)if(i[n].insert(t,e)){s=!0;break}s||this._add(t,e)}s=!0}return s}_initChildren(){const t=this.rect,e=this.children,s=this.shapes,i=t.center(),n=t.width/2,o=t.height/2;let r,h;for(e.push(new Jn(new Nt(t.x,t.y,n,o)),new Jn(new Nt(i.x,t.y,n,o)),new Jn(new Nt(t.x,i.y,n,o)),new Jn(new Nt(i.x,i.y,n,o))),h=s.length-1;h>=0;h--)for(r=0;r<e.length;r++)if(e[r].insert(s[h].shape,s[h].bounds)){s.splice(h,1);break}}hitTestRect(t,e){let s;const i=this.children;const n=i.length;let o=!1;if(this.overlapsBounds(t))if(super.hitTestRect(t,e))o=!0;else for(s=0;s<n;s++)if(i[s].hitTestRect(t,e)){o=!0;break}return o}}class Zn{constructor(t){this.ROOT_SIZE=1e3;const e=this._boundsChange.bind(this);t.bind(M,e),t.bind(S,e),this.initRoots()}initRoots(){this.rootMap={},this.root=new Gn}clear(){this.initRoots()}_boundsChange(t){t.item._quadNode&&t.item._quadNode.remove(t.item),this.insert(t.item)}insert(t){const e=t.bounds(I);const s=this.ROOT_SIZE;const i=this.getSectors(e);const n=i[0][0];const o=i[1][0];this.inRoot(i)?this.root.insert(t,e):(this.rootMap[n]||(this.rootMap[n]={}),this.rootMap[n][o]||(this.rootMap[n][o]=new Jn(new Nt(n*s,o*s,s,s))),this.rootMap[n][o].insert(t,e))}remove(t){t._quadNode&&t._quadNode.remove(t)}inRoot(t){return t[0].length>1||t[1].length>1}getSectors(t){const e=this.ROOT_SIZE;const s=t.bottomRight();const i=Math.floor(s.x/e);const n=Math.floor(s.y/e);const o=[[],[]];for(let s=Math.floor(t.x/e);s<=i;s++)o[0].push(s);for(let s=Math.floor(t.y/e);s<=n;s++)o[1].push(s);return o}hitTestRect(t,e){const s=this.getSectors(t);let i,n,o,r;let h;if(this.root.hitTestRect(t,e))return!0;for(i=0;i<s[0].length;i++)for(o=s[0][i],n=0;n<s[1].length;n++)if(r=s[1][n],h=(this.rootMap[o]||{})[r],h&&h.hitTestRect(t,e))return!0;return!1}}function $n(t,e,s){let i;for(let n=0;n<s.length;n++)i=s[n],e&&!K(e[i])&&(e[i]=t[i])}const Qn={name:"Diagram",theme:"sass",layout:"",zoomRate:.1,zoom:1,zoomMin:0,zoomMax:2,dataSource:{},draggable:!0,template:"",autoBind:!0,editable:{rotate:{},resize:{},text:!0,tools:[],drag:{snap:{size:10,angle:10}},remove:!0},pannable:{},selectable:{key:"none"},tooltip:{enabled:!0,format:"{0}"},copy:{enabled:!0,offsetX:20,offsetY:20},shapeDefaults:Gs({undoable:!0,connectors:void 0}),connectionDefaults:{editable:{tools:[]},type:N},shapes:[],connections:[]};const to=["contextmenu","dblclick","pointerdown","pointermove","pointerup","pointercancel","pointerleave","touchstart","touchmove","touchend","touchcancel"];const eo=[P,E,L,A,S,M,p,"click",T,k,"toolBarClick","save","cancel","edit","remove","undo","redo","add","dataBound",...to,x,b,C];function so(t){const e=[];const s=[];let i,n;for(n=0;n<t.length;n++)i=t[n],i instanceof ci?s.push(i):e.push(i);return{shapes:s,connections:e}}function io(t,e=!1){let s=t.offsetHeight;if(e){const e=getComputedStyle(t);s+=parseFloat(e.marginTop)+parseFloat(e.marginBottom)}return s}t.$=be,t.A=Qe,t.B=ws,t.C=Me,t.D=Dt,t.E=ss,t.F=Fe,t.G=jt,t.H=It,t.I=Zt,t.J=bs,t.K=es,t.L=Yt,t.M=Qt,t.N=Kt,t.O=fs,t.P=ee,t.Q=At,t.R=function(t,e,s){if(void 0===t||void 0===e)return[];if(s&&nt(e-t)!==nt(s))throw new Error("The sign of the increment should allow to reach the stop-value.");if(t=t||0,((e=e||t)-t)/(s=s||1)==1/0)throw new Error("Infinite range defined.");const i=[];let n,o=-1;const r=function(t){let e=1;for(;t*e%1;)e*=10;return e}(Math.abs(s));if(s*=r,(t*=r)>(e*=r)&&s>0&&(s=-s),s<0)for(;(n=t+s*++o)>=e;)i.push(n/r);else for(;(n=t+s*++o)<=e;)i.push(n/r);return i},t.S=se,t.T=Pt,t.U=kt,t.V=ve,t.W=Es,t.X=he,t.Y=_s,t.Z=Pe,t._=Se,t.__meta__={id:"diagram-common.cmn.chunk",name:"DiagramCommonCmnChunk",category:"web",description:"A reusable outputed chunk of code",depends:["drawing.cmn.chunk","common.cmn.chunk"],hidden:!0,chunk:!0},t.a=te,t.a0=class extends ve{constructor(t){super(t),this._capMap=hs._capMap,this.container=new e.G,this._getPath=hs._getPath.bind(this),this._normalizeMarkerOptions=hs._normalizeMarkerOptions.bind(this),this._removeMarker=hs._removeMarker.bind(this),this._createMarkers=hs._createMarkers.bind(this),this._createMarker=hs._createMarker.bind(this),this._positionMarker=hs._positionMarker.bind(this),this._redrawMarker=hs._redrawMarker.bind(this),this._redrawMarkers=hs._redrawMarkers.bind(this),this._initPath(),this._createMarkers()}drawingContainer(){return this.container}redraw(t){if(t){const e=(t=t||{}).from;const s=t.to;e&&(this.options.from=e),s&&(this.options.to=s),e||s?(this._drawPath(),this._redrawMarkers(!0,t)):this._redrawMarkers(!1,t),super.redraw(t)}}_initPath(){const t=this.options;const s=this.drawingElement=new e.a({stroke:t.stroke});this._fill(),this._drawPath(),this.container.append(s)}_drawPath(){const t=this.options;const e=this.drawingElement;const s=t.from||new Ot;const i=t.to||new Ot;e.segments.elements([pe(s.x,s.y),pe(i.x,i.y)])}},t.a1=class extends is{constructor(t,s){super(s),this.drawingElement=new e.j(ge(t),s),this._initSize()}rect(t){if(t)this.drawingElement.rect(ge(t));else{const t=this.drawingElement.rect();if(t)return new Nt(t.origin.x,t.origin.y,t.size.width,t.size.height)}}reflow(){this.drawingElement.reflow()}redraw(t){Ft(this.drawingElement.options,t),super.redraw.call(this,t)}},t.a2=ms,t.a3=Le,t.a4=is,t.a5=ke,t.a6=ne,t.a7=re,t.a8=oe,t.a9=ce,t.aA=An,t.aB=class{constructor(t,e,s){this.initial=t,this.finalPos=e,this.diagram=s,this.title="Pan Unit"}undo(){this.diagram.pan(this.initial)}redo(){this.diagram.pan(this.finalPos)}},t.aC=gi,t.aD=Vn,t.aE=qt,t.aF=Wt,t.aG=Ds,t.aH=Gt,t.aI=zs,t.aJ=Xt,t.aK=Zs,t.aL=Xs,t.aM=Gs,t.aN=K,t.aO=ci,t.aP=eo,t.aQ=zn,t.aR=ft,t.aS=Qn,t.aT=class extends Tt{constructor(t,e,s){super(),this._clipboard=[],this._connectionsDataMap={},this._dataMap={},this._inactiveShapeItems=new Xn,this._selectedItems=[],this.shapes=[],this.connections=[],this._deferredConnectionUpdates=[],this._domEvent=t=>{const e=this._meta(t);const s=this._eventPositions(t);const i=this.toolService._hitTest(s);this.trigger(t.type,{nativeEvent:t,item:i,point:s,meta:e})},this.element=t,this.options=Ft({createToolBar:xt,destroyToolBar:xt},Qn,e),this.events=eo,this._initTheme(s),this._initElements(),this._extendLayoutOptions(this.options),this._initDefaults(e),this._interactionDefaults(),this._initCanvas(),this.mainLayer=new is({id:"main-layer"}),this.canvas.append(this.mainLayer),this._shapesQuadTree=new Zn(this),this._pan=new Ot,this._adorners=[],this.adornerLayer=new is({id:"adorner-layer"}),this.canvas.append(this.adornerLayer),this._createHandlers(),this._initialize(),this._resizingAdorner=new mi(this,{editable:this.options.editable}),this._connectorsAdorner=new ui(this),this._adorn(this._resizingAdorner,!0),this._adorn(this._connectorsAdorner,!0),this.selector=new yi(this),this._clipboard.length=0,this.pauseMouseHandlers=!1}_createShape(t,e){(e=Ft({},this.options.shapeDefaults,e)).dataItem=t;return new ci(e,this)}_createConnection(t,e,s){const i=Ft({},this.options.connectionDefaults);i.dataItem=t;return new zn(e||new Ot,s||new Ot,i)}_initElements(){this.element.innerHTML="",this.element.style.position="relative",this.element.setAttribute("tabindex","0"),this.element.classList.add("k-diagram"),this.scrollable=document.createElement("div"),this.element.appendChild(this.scrollable),this.wrapper=this.element}_initDefaults(t){const e=this.options;const s=e.editable;const i=e.shapeDefaults;const n=e.connectionDefaults;const o=(t||{}).shapeDefaults;!1===s?(i.editable=!1,n.editable=!1):($n(s,i.editable,["drag","remove","connect"]),$n(s,n.editable,["drag","remove"])),o&&o.connectors&&(e.shapeDefaults.connectors=o.connectors)}_interactionDefaults(){const t=this.options;const e=t.selectable;const s=t.pannable;const i=this._mobileOS();e&&!K(e.multiple)&&(t.selectable=Ft({multiple:!i},t.selectable)),s&&!K(s.key)&&(t.pannable=Ft({key:i?"none":"ctrl"},t.pannable))}_initCanvas(){const t=document.createElement("div");t.classList.add("k-layer"),this.scrollable.appendChild(t);const e=this.viewport();this.canvas=new(this.options.Canvas||Me)(t,{width:e.width||600,height:e.height||600})}_createHandlers(){const t=this.element;this._wheelHandler=this._wheelHandler||this._wheel.bind(this),this._keydownHandler=this._keydownHandler||this._keydown.bind(this),this._mobileOS()&&this._mobileOS().browser.mobilesafari?t.addEventListener("mousewheel",this._wheelHandler):t.addEventListener("wheel",this._wheelHandler),t.addEventListener("keydown",this._keydownHandler),this._userEvents=new _n(this.scrollable,{multiTouch:!0,fastTap:!0,tap:this._tap.bind(this),start:this._dragStart.bind(this),move:this._drag.bind(this),end:this._dragEnd.bind(this),gesturestart:this._gestureStart.bind(this),gesturechange:this._gestureChange.bind(this),gestureend:this._gestureEnd.bind(this),doubleTap:this._doubleTap.bind(this),supportDoubleTap:!0}),this.toolService=new Nn(this),this._mouseoverHandler=this._mouseoverHandler||this._mouseover.bind(this),this._mouseoutHandler=this._mouseoutHandler||this._mouseout.bind(this),this._mouseMoveHandler=this._mouseMoveHandler||this._mouseMove.bind(this),this._mouseDownHandler=this._mouseDownHandler||this._mouseDown.bind(this),this._mouseUpHandler=this._mouseUpHandler||this._mouseUp.bind(this),this.scrollable.addEventListener("mouseover",this._mouseoverHandler),this.scrollable.addEventListener("mouseout",this._mouseoutHandler),this.scrollable.addEventListener("mousemove",this._mouseMoveHandler),this.scrollable.addEventListener("mousedown",this._mouseDownHandler),this.scrollable.addEventListener("mouseup",this._mouseUpHandler),to.forEach((t=>{this.scrollable.addEventListener(t,this._domEvent)})),this._initResizeObserver(),this.bind(E,this._destroyToolBar.bind(this)),this.bind(L,this._destroyToolBar.bind(this))}_initResizeObserver(){const t=new ResizeObserver((t=>{t.forEach((t=>{const{width:e,height:s}=t.contentRect;t.target!==this.element||this.size&&this.size.width===e&&this.size.height===s||(this.size={width:e,height:s},this._resize(),this.trigger("resize",this.size))}))}));this._resizeObserver=t,t.observe(this.element)}_destroyResizeObserver(){this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null)}_dragStart(t){this._pauseMouseHandlers=!0;const e=this._eventPositions(t,!0);this.toolService.start(e,this._meta(t),t.event)&&(this._destroyToolBar(),t.preventDefault())}_drag(t){const e=this._eventPositions(t);this.toolService.move(e,this._meta(t),t.event)&&t.preventDefault()}_dragEnd(t){this._pauseMouseHandlers=!1;const e=this._eventPositions(t);this.toolService.end(e,this._meta(t),t.event)&&(this.options.createToolBar(),t.preventDefault())}_mouseMove(t){if(!this._pauseMouseHandlers){const e=this._eventPositions(t);this.toolService._updateHoveredItem(e,this._meta(t),t),this.toolService._updateCursor(e)}}_mouseDown(){this._pauseMouseHandlers=!0}_mouseUp(){this._pauseMouseHandlers=!1}_tap(t){const e=this.toolService;const i=this.options.selectable;const n=this._eventPositions(t);const o=this.focus();const r=this._meta(t);if(e._updateHoveredItem(n,r,t.event),e.hoveredItem){const h=e.hoveredItem;if(this.trigger("click",{nativeEvent:t.event,item:h,point:n,meta:r}),i&&!1!==h.options.selectable){const t=!1!==i.multiple;const e=s.m||r.ctrlKey||r.metaKey&&En();h.isSelected?e?(this._destroyToolBar(),h.select(!1)):this.options.createToolBar(o):(this._destroyToolBar(),this.select(h,{addToSelection:t&&e}),this.options.createToolBar(o))}}else i&&(this._destroyToolBar(),this.deselect())}_keydown(t){this.toolService.keyDown(t.keyCode,this._meta(t))&&t.preventDefault()}_wheel(t){const e=function(t){let e=0;return t.wheelDelta?(e=-t.wheelDelta/40,e=e>0?Math.ceil(e):Math.floor(e)):t.detail&&(e=t.detail),e}(t),s=this._eventPositions(t),i=Ft(this._meta(t),{delta:e});this.toolService.wheel(s,i,t)&&t.preventDefault()}_meta(t){return{ctrlKey:(t=t.event||t).ctrlKey,metaKey:t.metaKey,altKey:t.altKey,shiftKey:t.shiftKey,type:t.type}}_eventPositions(t,e){let s;if(t.touch){const i=e?"startLocation":"location";s=new Ot(t.x[i],t.y[i])}else s=new Ot(t.pageX,t.pageY);return this.documentToModel(s)}_gestureStart(t){this._destroyToolBar(),this.scroller.disable();const e=this.documentToModel(new Ot(t.center.x,t.center.y));const s={point:e,zoom:this.zoom()};this.trigger(E,s)||(this._gesture=t,this._initialCenter=e)}_gestureChange(t){const e=this._gesture;const s=this._initialCenter;const i=this.documentToView(new Ot(t.center.x,t.center.y));const n=t.distance/e.distance;let o=this._zoom;let r=!1;Math.abs(n-1)>=.05&&(this._zoom=o=this._getValidZoom(o*n),this.options.zoom=o,this._gesture=t,r=!0);const h=s.times(o);const a=i.minus(h);(r||this._pan.distanceTo(a)>=5)&&(this._panTransform(a),this._updateAdorners()),t.preventDefault()}_doubleTap(t){const s=this._eventPositions(t);const i=this.options;const n=i.zoomRate;let o=this.zoom()+n;const r={point:s,meta:this._meta(t),zoom:o};this.trigger(E,r)||(o=e.r(Math.max(i.zoomMin,Math.min(i.zoomMax,o)),2),r.zoom=o,this.zoom(o,r),this.trigger(P,r))}_gestureEnd(){!1!==this.options.pannable&&this.scroller.enable(),this.trigger(P,{point:this._initialCenter,zoom:this.zoom()})}_resize(){const t=this.viewport();this.canvas&&this.canvas.size(t),this.scrollable&&this.toolBar&&(this.scrollable.style.height=t.height+"px")}_mouseover(t){const e=t.target._kendoNode;e&&e.srcElement._hover&&e.srcElement._hover(!0,e.srcElement)}_mouseout(t){const e=t.target._kendoNode;e&&e.srcElement._hover&&e.srcElement._hover(!1,e.srcElement)}_initTheme(t){this.options=Ft({},t,this.options),!0===this.options.editable&&(this.options.editable=(t||{}).editable)}_createOptionElements(){const t=this.options;const e=t.shapes.length;e&&this._createShapes(),t.connections.length&&this._createConnections(),e&&t.layout&&this.layout(t.layout)}_createShapes(){const t=this.options.shapes;let e,s;for(s=0;s<t.length;s++)e=t[s],this.addShape(e)}_createConnections(){const t=this.options,e=t.connectionDefaults,s=t.connections;let i,n,o,r;for(r=0;r<s.length;r++)i=s[r],n=this._findConnectionTarget(i.from),o=this._findConnectionTarget(i.to),this.options.connect?this.options.connect(n,o,Ft({},e,i)):this.connect(n,o,Ft({},e,i))}_findConnectionTarget(t){const e=J(t=t||{})?t:t.shapeId||t.id;let s;return e?(s=this.getShapeById(e),t.connector&&(s=s.getConnector(t.connector))):s=new Ot(t.x||0,t.y||0),s}destroy(){super.destroy(),this._destroyResizeObserver(),this._userEvents&&this._userEvents.destroy(),this.clear(),this.element.removeEventListener("mousewheel",this._wheelHandler),this.element.removeEventListener("wheel",this._wheelHandler),this.element.removeEventListener("keydown",this._keydownHandler),this.scrollable.removeEventListener("mouseover",this._mouseoverHandler),this.scrollable.removeEventListener("mouseout",this._mouseoutHandler),this.scrollable.removeEventListener("mousemove",this._mouseMoveHandler),this.scrollable.removeEventListener("mousedown",this._mouseDownHandler),this.scrollable.removeEventListener("mouseup",this._mouseUpHandler),to.forEach((t=>{this.scrollable.removeEventListener(t,this._domEvent)})),this.canvas.destroy(!0),this.canvas=void 0,this.destroyScroller(),this._destroyGlobalToolBar(),this._destroyToolBar(),this._inactiveShapeItems.destroy()}destroyScroller(){const t=this.scroller;t&&(t.destroy(),t.element.remove(),this.scroller=null)}save(){const t={shapes:[],connections:[]};let e,s,i;for(e=0;e<this.shapes.length;e++)i=this.shapes[e],i.options.serializable&&t.shapes.push(i.options);for(e=0;e<this.connections.length;e++)s=this.connections[e],t.connections.push(Ft({},s.options,s.toJSON()));return t}focus(){if(this.element!==this.element.ownerDocument.activeElement){const t=this.element,e=[],s=[],i=t.ownerDocument.documentElement;let n,o=t;do{o=o.parentNode,o.scrollHeight>o.clientHeight&&(e.push(o),s.push(o.scrollTop))}while(o!==i);for(t.focus({preventScroll:!0}),n=0;n<e.length;n++)e[n].scrollTop=s[n];return!0}}load(t){this.clear(),this.setOptions(t),this._createShapes(),this._createConnections()}setOptions(t){Ft(this.options,t)}clear(){this.select(!1),this.mainLayer.clear(),this._shapesQuadTree.clear(),this._initialize()}connected(t,e){for(let s=0;s<this.connections.length;s++){const i=this.connections[s];if(i.from===t&&i.to===e)return!0}return!1}addConnection(t,e){return!1!==e&&this.undoRedoService.add(new Bn(t,this),!1),t.diagram=this,t._setOptionsFromModel(),t.refresh(),this.mainLayer.append(t.visual),this.connections.push(t),this.trigger(p,{added:[t],removed:[]}),t}addShape(t,e){let s,i=this.options.shapeDefaults;if(t instanceof ci)s=t,this._parseBounds(s.bounds());else{if(t.prototype)return;i=Ft({},i,t||{}),s=new ci(i,this),this._parseBounds(s.bounds())}return!1!==e&&this.undoRedoService.add(new An(s,this),!1),this.shapes.push(s),s.diagram!==this&&(this._shapesQuadTree.insert(s),s.diagram=this),this.mainLayer.append(s.visual),this.trigger(p,{added:[s],removed:[]}),s}remove(t,e){const s=so(t=Array.isArray(t)?t.slice(0):[t]);const i=s.shapes;const n=s.connections;let o;for(K(e)||(e=!0),e&&this.undoRedoService.begin(),this._suspendModelRefresh(),o=i.length-1;o>=0;o--)this._removeItem(i[o],e,n);for(o=n.length-1;o>=0;o--)this._removeItem(n[o],e);this._resumeModelRefresh(),e&&this.undoRedoService.commit(!1),this.trigger(p,{added:[],removed:t})}_addConnection(t,e){return this.options._addConnection?this.options._addConnection(t,e):this.trigger("add",{connection:t})?void 0:(this.addConnection(t,e),t._updateConnectors(),t)}_addShape(t,e){return this.options._addShape?this.options._addShape(t,e):this.trigger("add",{shape:t})?void 0:this.addShape(t,e)}_parseBounds(t){t.x="string"==typeof t.x?parseFloat(t.x):t.x,t.y="string"==typeof t.y?parseFloat(t.y):t.y}_shouldRefresh(){return!this._suspended}_suspendModelRefresh(){this._suspended=(this._suspended||0)+1}_resumeModelRefresh(){this._suspended=Math.max((this._suspended||0)-1,0)}_triggerRemove(t){const e=[];let s,i,n;for(let o=0;o<t.length;o++)s=t[o],n=s.options.editable,i=s instanceof ci?{shape:s}:{connection:s},n&&!1!==n.remove&&!this.trigger("remove",i)&&e.push(s);return e}_addConnections(t,e){const s=t.length;for(let i=0;i<s;i++){const s=t[i];this._addConnectionDataItem(s,e)}}_addConnectionDataItem(t,e){if(!this._connectionsDataMap[t.uid]){let s=this._validateConnector(t.from);K(s)&&null!==s||(s=new Ot(t.fromX,t.fromY));let i=this._validateConnector(t.to);if(K(i)&&null!==i||(i=new Ot(t.toX,t.toY)),K(s)&&K(i)){const n=Ft({},this.options.connectionDefaults);n.dataItem=t;const o=new zn(s,i,n);this._connectionsDataMap[t.uid]=o,this.addConnection(o,e)}}}_validateConnector(t){let e;return K(t)&&null!==t&&(e=this._dataMap[t]),e}_addDataItems(t,e){let s,i,n,o;for(i=0;i<t.length;i++)s=t[i],n=this._addDataItemByUid(s),o=this._addDataItemByUid(e),o&&!this.connected(o,n)&&this.connect(o,n)}connect(t,e,s){const i=Ft({},this.options.connectionDefaults,s);const n=new zn(t,e,i);return this.addConnection(n)}undo(){this.undoRedoService.undo()}redo(){this.undoRedoService.redo()}select(t,e){if(!q(t))return this._selectedItems;{const s=[];let i,n,o=[];for((e=Ft({addToSelection:!1},e)).addToSelection||this.deselect(),this._internalSelection=!0,t instanceof Array?o=t:t instanceof hi&&(o=[t]),i=0;i<o.length;i++)n=o[i],n.select(!0)&&s.push(n);this._selectionChanged(s,[]),this._internalSelection=!1}}selectAll(){this.select(this.shapes.concat(this.connections))}selectArea(t){let e,s,i;this._internalSelection=!0;const n=[];if(t instanceof Nt)for(s=this.shapes.concat(this.connections),e=0;e<s.length;e++)i=s[e],t&&!i._hitTest(t)||!i.options.enable||i.select(!0)&&n.push(i);this._selectionChanged(n,[]),this._internalSelection=!1}deselect(t){this._internalSelection=!0;const e=[];let s,i,n=[];for(t instanceof Array?n=t:t instanceof hi?n.push(t):q(t)||(n=this._selectedItems.slice(0)),i=0;i<n.length;i++)s=n[i],s.select(!1)&&e.push(s);this._selectionChanged([],e),this._internalSelection=!1}toFront(t,e){t||(t=this._selectedItems.slice());const s=this._getDiagramItems(t);let i;if(!K(e)||e){i=Vs(this.mainLayer,s.visuals);const e=new Kn(this,t,i);this.undoRedoService.add(e)}else this.mainLayer.toFront(s.visuals),this._fixOrdering(s,!0)}toBack(t,e){t||(t=this._selectedItems.slice());const s=this._getDiagramItems(t);let i;if(!K(e)||e){i=Vs(this.mainLayer,s.visuals);const e=new qn(this,t,i);this.undoRedoService.add(e)}else this.mainLayer.toBack(s.visuals),this._fixOrdering(s,!1)}bringIntoView(t,e){const s=this.viewport();const i=new Bt(s);let n;if(0===s.width||0===s.height)return;"none"===(e=Ft({animate:!1,align:"center middle"},e)).align&&(e.align="center middle"),t instanceof hi?n=t.bounds(U):Array.isArray(t)?n=this.boundingBox(t):t instanceof Nt&&(n=t.clone());const o=n.clone();n.zoom(this._zoom),(n.width>s.width||n.height>s.height)&&(this._zoom=this._getValidZoom(Math.min(s.width/o.width,s.height/o.height)),n=o.clone().zoom(this._zoom)),this._zoomMainLayer();const r=n.clone();i.align(n,e.align);const h=n.topLeft().minus(r.topLeft());this.pan(h.times(-1),e.animate)}alignShapes(t){let e,s,i;j(t)&&(t="Left");const n=this.select();if(0===n.length)return;switch(t.toLowerCase()){case"left":case"top":e=H;break;case"right":case"bottom":e=F}for(i=0;i<n.length;i++)if(s=n[i],s instanceof ci)switch(t.toLowerCase()){case"left":e=Math.min(e,s.options.x);break;case"top":e=Math.min(e,s.options.y);break;case"right":e=Math.max(e,s.options.x);break;case"bottom":e=Math.max(e,s.options.y)}const o=[];const r=[];for(i=0;i<n.length;i++)if(s=n[i],s instanceof ci)switch(r.push(s),o.push(s.bounds()),t.toLowerCase()){case"left":case"right":s.position(new Ot(e,s.options.y));break;case"top":case"bottom":s.position(new Ot(s.options.x,e))}const h=new gi(r,o);this.undoRedoService.add(h,!1)}zoom(t,e){if(t){let s=e?e.point:new Ot(0,0);if(t=this._zoom=this._getValidZoom(t),!j(s)){s=new Ot(Math.round(s.x),Math.round(s.y));const e=s.times(t);const i=this.modelToView(s).minus(e);this._storePan(new Ot(Math.round(i.x),Math.round(i.y)))}e&&(e.zoom=t),this._panTransform(),this.canvas.surface.hideTooltip&&this.canvas.surface.hideTooltip(),this._updateAdorners()}return this._zoom}_getPan(t){return this.canvas.translate||(t=t.plus(this._pan)),t}pan(t,e){if(!(t instanceof Ot))return this._pan.times(-1);{const s=this.scroller;t=(t=this._getPan(t)).times(-1),e?s.animatedScrollTo(t.x,t.y,(()=>{this._updateAdorners()})):(s.scrollTo(t.x,t.y),this._updateAdorners())}}viewport(){const t=this.element;const e=function(t){const e=getComputedStyle(t);return t.clientWidth-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight)}(t);let s=function(t){const e=getComputedStyle(t);return t.clientHeight-parseFloat(e.paddingTop)-parseFloat(e.paddingBottom)}(t);return this.toolBar&&(s-=io(this.toolBar.element)),new Nt(0,0,e,s)}copy(){if(this.options.copy.enabled){this._clipboard.length=0,this._copyOffset=1;for(let t=0;t<this._selectedItems.length;t++){const e=this._selectedItems[t];this._clipboard.push(e)}}}cut(){if(this.options.copy.enabled){this._clipboard.length=0,this._copyOffset=0;for(let t=0;t<this._selectedItems.length;t++){const e=this._selectedItems[t];this._clipboard.push(e)}this.remove(this._clipboard,!0)}}paste(){if(this._clipboard.length>0){let t,e,s;const i={};const n=so(this._clipboard);const o=n.connections;const r=n.shapes;const h={x:this._copyOffset*this.options.copy.offsetX,y:this._copyOffset*this.options.copy.offsetY};for(this.deselect(),s=0;s<r.length;s++)t=r[s],e=t.clone(),i[t.id]=e,e.position(new Ot(t.options.x+h.x,t.options.y+h.y)),e.diagram=this,e=this._addShape(e),e&&e.select();for(s=0;s<o.length;s++)t=o[s],e=this._addConnection(t.clone()),e&&(this._updateCopiedConnection(e,t,"source",i,h),this._updateCopiedConnection(e,t,"target",i,h),e.select(!0),e.updateModel());this._syncChanges(),this._copyOffset+=1}}_syncChanges(){this.options._syncChanges&&this.options._syncChanges()}_syncConnectionChanges(){this.options._syncConnectionChanges&&this.options._syncConnectionChanges()}_syncShapeChanges(){this.options._syncShapeChanges&&this.options._syncShapeChanges()}_updateCopiedConnection(t,e,s,i,n){let o,r,h;const a=e[s]();a instanceof js&&i[a.shape.id]?(h=i[a.shape.id],this.getShapeById(h.id)?t[s](h.getConnector(a.options.name)):(r=this._inactiveShapeItems.getByUid(h.dataItem.uid),r&&(o=e=>{h=this._dataMap[e.id],t[s](h.getConnector(a.options.name)),t.updateModel()},this._deferredConnectionUpdates.push(r.onActivate(o))))):t[s](new Ot(e[s+"Point"]().x+n.x,e[s+"Point"]().y+n.y))}boundingBox(t,e){let s,i=Nt.empty();const n=q(t)?this._getDiagramItems(t):{shapes:this.shapes};if(n.shapes.length>0){let t=n.shapes[0];i=t.bounds(I);for(let o=1;o<n.shapes.length;o++)t=n.shapes[o],s=t.bounds(I),!0===e&&(s.x-=t._rotationOffset.x,s.y-=t._rotationOffset.y),i=i.union(s)}return i}_containerOffset(){const t=function(t){const e=t.getBoundingClientRect();const s=t.ownerDocument;const i=s.defaultView.scrollX||s.documentElement.scrollLeft||0;const n=s.defaultView.scrollY||s.documentElement.scrollTop||0;return{top:e.top+n,left:e.left+i}}(this.element);return this.toolBar&&(t.top+=io(this.toolBar.element)),t}documentToView(t){const e=this._containerOffset();return new Ot(t.x-e.left,t.y-e.top)}viewToDocument(t){const e=this._containerOffset();return new Ot(t.x+e.left,t.y+e.top)}viewToModel(t){return this._transformWithMatrix(t,this._matrixInvert)}modelToView(t){return this._transformWithMatrix(t,this._matrix)}modelToLayer(t){return this._transformWithMatrix(t,this._layerMatrix)}layerToModel(t){return this._transformWithMatrix(t,this._layerMatrixInvert)}documentToModel(t){const e=this.documentToView(t);return this.canvas.translate||(e.x=e.x+this.scroller.scrollLeft,e.y=e.y+this.scroller.scrollTop),this.viewToModel(e)}modelToDocument(t){return this.viewToDocument(this.modelToView(t))}_transformWithMatrix(t,e){let s=t;if(t instanceof Ot)e&&(s=e.apply(t));else{const i=this._transformWithMatrix(t.topLeft(),e),n=this._transformWithMatrix(t.bottomRight(),e);s=Nt.fromPoints(i,n)}return s}layout(t){let e;let s;switch(this._layouting=!0,j(t)&&(t=this.options.layout),e=j(t)||j(t.type)?"Tree":t.type,e.toLowerCase()){case"tree":s=new zs(this);break;case"layered":s=new Ds(this);break;case"forcedirected":case"force":case"spring":case"springembedder":s=new Xt(this);break;default:throw new Error("Layout algorithm '"+e+"' is not supported.")}const i=new qt(this);const n=s.layout(t);if(n){const e=new Wn(i,n,t?t.animate:null);this.undoRedoService.add(e)}this._layouting=!1,this._redrawConnections()}getShapeById(t){let e;return e=ft(this.shapes,(function(e){return e.visual.id===t})),e||(e=ft(this.connections,(function(e){return e.visual.id===t})),e)}getShapeByModelId(t){let e;return e=this._isEditable?this._dataMap[t]:ft(this.shapes,(function(e){return(e.dataItem||{}).id===t})),e}getShapeByModelUid(t){let e;return e=this._isEditable?ft(this.shapes,(function(e){return(e.dataItem||{}).uid===t})):this._dataMap[t],e}_extendLayoutOptions(t){t.layout&&(t.layout=Ft({},Ut,t.layout))}_selectionChanged(t,e){(t.length||e.length)&&this.trigger(A,{selected:t,deselected:e})}_getValidZoom(t){return Math.min(Math.max(t,this.options.zoomMin),this.options.zoomMax)}_panTransform(t){const e=t||this._pan;this.canvas.translate?(this.scroller.scrollTo(e.x,e.y),this._zoomMainLayer()):(this._storePan(e),this._transformMainLayer())}_finishPan(){this.trigger(L,{total:this._pan,delta:Number.NaN})}_storePan(t){this._pan=t,this._storeViewMatrix()}_zoomMainLayer(){const t=this._zoom;const e=new he(0,0,t,t);e.render(this.mainLayer),this._storeLayerMatrix(e),this._storeViewMatrix()}_transformMainLayer(){const t=this._pan,e=this._zoom;const s=new he(t.x,t.y,e,e);s.render(this.mainLayer),this._storeLayerMatrix(s),this._storeViewMatrix()}_storeLayerMatrix(t){this._layerMatrix=t.toMatrix(),this._layerMatrixInvert=t.invert().toMatrix()}_storeViewMatrix(){const t=this._pan,e=this._zoom;const s=new he(t.x,t.y,e,e);this._matrix=s.toMatrix(),this._matrixInvert=s.invert().toMatrix()}_toIndex(t,e){const s=this._getDiagramItems(t);this.mainLayer.toIndex(s.visuals,e),this._fixOrdering(s,!1)}_fixOrdering(t,e){const s=e?this.shapes.length-1:0,i=e?this.connections.length-1:0;let n,o;for(n=0;n<t.shapes.length;n++)o=t.shapes[n],at(this.shapes,o),mt(this.shapes,o,s);for(n=0;n<t.cons.length;n++)o=t.cons[n],at(this.connections,o),mt(this.connections,o,i)}_getDiagramItems(t){let e,s=t;const i={};for(i.visuals=[],i.shapes=[],i.cons=[],t?Array.isArray(t)||(s=[t]):s=this._selectedItems.slice(),e=0;e<s.length;e++){const t=s[e];t instanceof ci?(i.shapes.push(t),i.visuals.push(t.visual)):t instanceof zn&&(i.cons.push(t),i.visuals.push(t.visual))}return i}_addDataItemByUid(t){if(!K(t))return;let e=this._dataMap[t.uid];if(e)return e;const s=Ft({},this.options.shapeDefaults);return s.dataItem=t,e=new ci(s,this),this.addShape(e),this._dataMap[t.uid]=e,e}_addItem(t){t instanceof ci?this.addShape(t):t instanceof zn&&this.addConnection(t)}_toolBarClick(t){this.trigger("toolBarClick",t),this._destroyToolBar()}_normalizePointZoom(t){return t.times(1/this.zoom())}_initialize(){this.shapes.length=0,this.connections.length=0,this._selectedItems.length=0,Object.keys(this._dataMap).forEach((t=>{delete this._dataMap[t]})),Object.keys(this._connectionsDataMap).forEach((t=>{delete this._connectionsDataMap[t]})),this._deferredConnectionUpdates.length=0,this.undoRedoService=new Yn({undone:this._syncChanges.bind(this),redone:this._syncChanges.bind(this)}),this.undoRedoService.bind("undo",(t=>{this.trigger("undo",t)})),this.undoRedoService.bind("redo",(t=>{this.trigger("redo",t)})),this.id=Lt()}_redrawConnections(){const t=this.connections;for(let e=0;e<t.length;e++)t[e].refresh()}_adorn(t,e){void 0!==e&&t&&(e?(this._adorners.push(t),this.adornerLayer.append(t.visual)):(at(this._adorners,t),this.adornerLayer.remove(t.visual)))}_showConnectors(t,e){e?this._connectorsAdorner.show(t):this._connectorsAdorner.destroy()}_updateAdorners(){const t=this._adorners;for(let e=0;e<t.length;e++){const s=t[e];s.refreshBounds&&s.refreshBounds(),s.refresh()}}_refresh(){for(let t=0;t<this.connections.length;t++)this.connections[t].refresh()}_removeItem(t,e,s){t.select(!1),t instanceof ci?(this._removeShapeDataItem(t),this._removeShape(t,e,s)):t instanceof zn&&(this._removeConnectionDataItem(t),this._removeConnection(t,e)),this.mainLayer.remove(t.visual)}_removeConnectionDataItem(t){this._isEditable&&(this.options._removeConnectionDataItem(t.dataItem),delete this._connectionsDataMap[t.dataItem.uid])}_removeShapeDataItem(t){this._isEditable&&(this.options._removeShapeDataItem(t.dataItem),delete this._dataMap[t.dataItem.id])}_removeShape(t,e,s){let i,n,o;const r=[],h=[];for(this.toolService._removeHover(),e&&this.undoRedoService.addCompositeItem(new Fn(t)),at(this.shapes,t),this._shapesQuadTree.remove(t),i=0;i<t.connectors.length;i++){o=t.connectors[i];for(let t=0;t<o.connections.length;t++)n=o.connections[t],s&&ct(s,n)||(n.sourceConnector===o?r.push(n):n.targetConnector===o&&h.push(n))}for(i=0;i<r.length;i++)r[i].source(null,e),r[i].updateModel();for(i=0;i<h.length;i++)h[i].target(null,e),h[i].updateModel()}_removeConnection(t,e){t.sourceConnector&&at(t.sourceConnector.connections,t),t.targetConnector&&at(t.targetConnector.connections,t),e&&this.undoRedoService.addCompositeItem(new Hn(t)),at(this.connections,t)}_removeShapeConnections(t){const e=t.connections();let s;if(e)for(s=0;s<e.length;s++)this._removeItem(e[s],!1)}_destroyToolBar(){this.options.destroyToolBar()}_destroyGlobalToolBar(){this.toolBar&&(this.toolBar=null)}_mobileOS(){return s.m}exportDOMVisual(){const t=this.canvas._viewBox;const s=e.t().translate(-t.x,-t.y);const i=new e.R([0,0],[t.width,t.height]);const n=e.a.fromRect(i);const o=new e.G({transform:s});const r=new e.G({clip:n});const h=this.canvas.drawingElement.children[0];return r.append(o),o.children.push(h),r}exportVisual(){const t=1/this._zoom;const s=e.t().scale(t,t);const i=new e.G({transform:s});const n=this.mainLayer.drawingElement;return i.children.push(n),i}updateConnectionModel(t,e){if(this.options.updateConnectionModel)return this.options.updateConnectionModel(t,e)}updateShapeModel(t,e){if(this.options.updateShapeModel)return this.options.updateShapeModel(t,e)}},t.aU=Zn,t.aV=Gn,t.aW=Jn,t.aX=js,t.aa={none:"none",arrowStart:"ArrowStart",filledCircle:"FilledCircle",arrowEnd:"ArrowEnd"},t.ab=ae,t.ac=g,t.ad=Ks,t.ae=Mi,t.af=Pi,t.ag=Pn,t.ah=Ln,t.ai=Ci,t.aj=Si,t.ak=wi,t.al=qn,t.am=Kn,t.an=Dn,t.ao=Wn,t.ap=ui,t.aq=Nn,t.ar=yi,t.as=mi,t.at=Yn,t.au=di,t.av=Ti,t.aw=li,t.ax=Hn,t.ay=Fn,t.az=Bn,t.b=Bt,t.c=ie,t.d=Nt,t.e=Rt,t.f=Ot,t.g=ns,t.h=ts,t.i=Re,t.j=Ss,t.k=We,t.l=He,t.m=us,t.n=function(t,e){let s,i,n;do{s=2*Math.random()-1,i=2*Math.random()-1,n=s*s+i*i}while(!n||n>1);return t+e*s*Math.sqrt(-2*Math.log(n)/n)},t.o=ps,t.p=Ms,t.q=Ne,t.r=Lt,t.s=ze,t.t=Ae,t.u=Ke,t.v=je,t.w=rs,t.x=ds,t.y=xs,t.z=cs}));
//# sourceMappingURL=kendo.diagram-common.cmn.chunk.min.js.map
